<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#5B7B7A" />
  <title>Sistema de Avalúos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #5B7B7A;
      --primary-light: #8AA6A5;
      --primary-dark: #3A5958;
      --secondary: #A6B5A5;
      --accent: #8C9B9A;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --text: #2D3748;
      --text-light: #718096;
      --text-lighter: #A0AEC0;
      --bg: #F9FAFB;
      --bg-card: #FFFFFF;
      --bg-hover: #F8FAFC;
      --border: #E2E8F0;
      --border-light: #F1F5F9;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.02), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.03), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --space-xs: 8px;
      --space-sm: 16px;
      --space-md: 24px;
      --space-lg: 32px;
      --space-xl: 48px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }

    body { background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }

    .app-container { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-md); }

    .app-header {
      background: var(--bg-card);
      padding: var(--space-md) 0;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      margin-bottom: var(--space-lg);
    }
    .app-header h1 { font-size: 1.75rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); color: var(--primary); }
    .app-header h1 i { background: rgba(91,123,122,.1); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }

    .floating-actions {
      position: fixed;
      top: 100px;
      right: 24px;
      z-index: 99;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .floating-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }
    .floating-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .floating-btn:active {
      transform: translateY(0);
    }
    @media (max-width: 768px){
      .floating-actions {
        top: 90px;
        right: 16px;
      }
      .floating-btn {
        width: 50px;
        height: 50px;
        font-size: 1.1rem;
      }
    }

    .form-steps { display: flex; justify-content: space-between; margin-bottom: var(--space-xl); position: relative; padding: 0 var(--space-md); }
    .form-steps::before { content: ''; position: absolute; top: 24px; left: var(--space-md); right: var(--space-md); height: 2px; background: var(--border); z-index: 1; }
    .step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; cursor: pointer; transition: .3s; flex: 1; }
    .step-number { width: 48px; height: 48px; border-radius: 50%; background: var(--bg); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: var(--space-xs); transition: .3s; }
    .step-label { font-size: .875rem; font-weight: 500; color: var(--text-light); text-align: center; transition: .3s; }
    .step.active .step-number { background: var(--primary); border-color: var(--primary); color:#fff; }
    .step.active .step-label { color: var(--primary); font-weight: 600; }
    .step.completed .step-number { background: var(--success); border-color: var(--success); color:#fff; }

    .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--space-xl); margin: var(--space-lg) 0; box-shadow: var(--shadow); border: 1px solid var(--border); transition: .3s; }
    .card:hover { box-shadow: var(--shadow-lg); }
    .card h2 { font-size: 1.5rem; color: var(--text); margin-bottom: var(--space-lg); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); }
    .card h2 i { background: rgba(91,123,122,.1); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }

    .form-section { margin-bottom: var(--space-xl); display: none; animation: fadeIn .5s ease; }
    .form-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to{ opacity:1; transform:translateY(0);} }
    .form-section-title { font-size: 1.25rem; color: var(--text); margin-bottom: var(--space-md); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border-light); }
    .form-section-title i { background: rgba(91,123,122,.1); width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: var(--space-md); }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: .9rem; font-weight: 500; color: var(--text); margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs); }
    .required::after { content:'*'; color: var(--error); margin-left: 4px; }
    .form-group input,.form-group select,.form-group textarea { padding: 14px 16px; border:1px solid var(--border); border-radius: var(--radius); font-size:1rem; transition:.2s; background: var(--bg-card); color: var(--text); }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91,123,122,.1); }
    .form-help { font-size: .85rem; color: var(--text-light); margin-top: var(--space-xs); }

    .typology-selector{ margin-top: var(--space-md); }
    .typology-trigger{ background: var(--bg-card); border:1px solid var(--border); border-radius: var(--radius); padding:20px; cursor:pointer; display:flex; align-items:center; gap:var(--space-sm); transition:.2s; }
    .typology-trigger:hover{ border-color: var(--primary); background: var(--bg-hover); }
    .typology-trigger:after{ content:"▼"; font-size:.8rem; margin-left:auto; transition: transform .3s; color: var(--primary); }
    .typology-trigger.active:after{ transform: rotate(180deg); }
    .selected-image{ width:60px; height:60px; border-radius: var(--radius); object-fit: cover; flex-shrink: 0; }
    .selected-text{ display:flex; flex-direction:column; flex:1; }
    .selected-type{ font-weight: 600; color: var(--primary); font-size:1rem; margin-bottom:4px; }
    .selected-title{ font-weight: 500; color: var(--text); font-size:.9rem; }
    .selected-price{ font-size:.85rem; color: var(--text-light); margin-top:4px; }

    #norte-propietario,#sur-propietario,#oriente-propietario,#poniente-propietario,
    #norte-metros,#sur-metros,#oriente-metros,#poniente-metros{
      background: var(--bg-card)!important; border:1px solid var(--border)!important; color: var(--text)!important;
    }

    .table-ui{ width:100%; border-collapse:collapse; margin: var(--space-md) 0; background: var(--bg-card); border-radius: var(--radius); overflow:hidden; border:1px solid var(--border); }
    .table-ui th{ background: rgba(91,123,122,.05); color: var(--text); padding:16px; text-align:left; font-weight:600; font-size:.9rem; }
    .table-ui td{ padding:16px; border-bottom:1px solid var(--border-light); }
    .table-ui input, .table-ui select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); }

    .form-section-title + .form-grid + .form-section-title{ margin-top: var(--space-lg); }

    .btn-primary{ background: var(--primary); color:#fff; border:none; border-radius: var(--radius); padding:16px 24px; font-size:1rem; font-weight:500; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:10px; margin-top: var(--space-sm); }
    .btn-primary:hover{ background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary{ background:transparent; color: var(--primary); border:2px solid var(--primary); border-radius: var(--radius); padding:14px 22px; font-size:1rem; font-weight:500; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:10px; }
    .btn-secondary:hover{ background: var(--primary); color:#fff; }

    .btn-small{ padding:10px 14px; font-size:.9rem; border-radius:10px; }

    .form-navigation{ display:flex; justify-content:space-between; margin-top: var(--space-xl); padding-top: var(--space-md); border-top:1px solid var(--border-light); }

    .result-section{ display:none; animation: fadeIn .5s ease; }
    .result-section.active{ display:block; }
    .result-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom: var(--space-lg); }
    .result-item{ text-align:center; padding:24px 16px; background: rgba(91,123,122,.03); border-radius: var(--radius); border:1px solid var(--border-light); }
    .result-item .label{ font-size:.85rem; color: var(--text-light); margin-bottom:8px; font-weight:500;}
    .result-item .value{ font-size:1.2rem; font-weight:700; color: var(--primary); }
    .result-total{ text-align:center; padding:32px; background: rgba(91,123,122,.05); border-radius: var(--radius); margin-top:24px; border:1px solid var(--border-light); }
    .result-total .label{ font-size:1rem; margin-bottom:12px; color: var(--text); font-weight:500;}
    .result-total .value{ font-size:2rem; font-weight:700; color: var(--primary); }

    .catalog-modal{ position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; z-index:1000; padding:20px; }
    .catalog-modal.active{ display:flex; }
    .modal-content{ background: var(--bg-card); border-radius: var(--radius-lg); width:100%; max-width:600px; max-height:80vh; overflow-y:auto; padding:0; }
    .modal-header{ padding:24px; border-bottom:1px solid var(--border-light); position:sticky; top:0; background: var(--bg-card); border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    .modal-header h3{ color: var(--text); font-size:1.3rem; display:flex; align-items:center; gap:12px; font-weight:600; }
    .modal-close{ position:absolute; top:24px; right:24px; background:none; border:none; font-size:1.2rem; cursor:pointer; color: var(--text-light); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:.2s; }
    .modal-close:hover{ background: var(--border-light); }

    .catalog-item-modal{ padding:20px; border-bottom:1px solid var(--border-light); cursor:pointer; transition:.2s; }
    .catalog-item-modal:last-child{ border-bottom:none; }
    .catalog-item-modal:hover{ background: rgba(91,123,122,.03); }
    .catalog-item-content{ display:flex; gap:16px; align-items:flex-start; }
    .catalog-image-modal{ width:80px; height:80px; border-radius: var(--radius); object-fit:cover; flex-shrink:0; }
    .catalog-text-modal{ flex:1; }
    .catalog-type-modal{ font-weight:600; color: var(--primary); font-size:1.1rem; margin-bottom:4px; }
    .catalog-title-modal{ font-weight:500; color: var(--text); font-size:1rem; margin-bottom:4px; }
    .catalog-price-modal{ font-size:1rem; font-weight:600; color: var(--text); margin-bottom:8px; }
    .catalog-description-modal{ font-size:.9rem; color: var(--text-light); line-height:1.5; margin-bottom:12px; }
    .catalog-features-modal{ list-style:none; }
    .catalog-features-modal li{ padding:4px 0; display:flex; align-items:center; gap:8px; font-size:.85rem; color: var(--text); }
    .catalog-features-modal li i{ color: var(--primary); font-size:.8rem; }

    .select-button{ background: var(--primary); color:#fff; border:none; border-radius: var(--radius); padding:12px 20px; font-weight:500; cursor:pointer; margin-top:12px; width:100%; transition:.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
    .select-button:hover{ background: var(--primary-dark); }

    #save-btn,#pdf-btn{ position:fixed; right:24px; z-index:100; background: var(--primary); color:#fff; border:none; border-radius:50px; padding:14px 20px; font-weight:500; box-shadow: var(--shadow-md); display:none; cursor:pointer; transition:.2s; align-items:center; gap:8px; font-size:.9rem; }
    #save-btn:hover,#pdf-btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    #save-btn{ bottom:100px; }
    #pdf-btn{ bottom:170px; background: var(--secondary); }

    .loading-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,.9); display:none; justify-content:center; align-items:center; z-index:2000; flex-direction:column; gap: var(--space-md); }
    .loading-spinner{ width:48px; height:48px; border:4px solid var(--border); border-left:4px solid var(--primary); border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }

    .auth-overlay{ position:fixed; inset:0; background: rgba(0,0,0,.45); display:none; z-index:1500; align-items:center; justify-content:center; padding:24px; }
    .auth-panel{ width:100%; max-width:880px; }
    .auth-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
    .auth-col{ border:1px solid var(--border); border-radius: var(--radius); padding:12px; background:#fff; }
    .auth-col-title{ font-weight:600; margin-bottom:8px; }
    .auth-input{ width:100%; margin-bottom:8px; padding:10px; border:1px solid var(--border); border-radius:8px; }
    .auth-close{ position:absolute; top:18px; right:18px; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer; }
    
    @media (max-width:768px){
      .app-container{ padding:0 var(--space-sm); }
      .card{ padding: var(--space-md); margin: var(--space-md) 0; }
      .form-grid,.characteristics-grid,.result-grid{ grid-template-columns:1fr; }
      .form-steps{ flex-direction:column; gap: var(--space-md); }
      .form-steps::before{ display:none; }
      .step{ flex-direction:row; gap: var(--space-sm); }
      .step-label{ text-align:left; }
      #save-btn,#pdf-btn{ right:16px; bottom:80px; }
      #pdf-btn{ bottom:140px; }
    }

    #username-modal .modal-content {
      max-width: 400px;
    }
    #username-modal .form-group {
      margin-bottom: 0;
    }

    .appraisal-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .appraisal-item:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    .appraisal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .appraisal-date {
      font-weight: 600;
      color: var(--primary);
    }

    .appraisal-actions {
      display: flex;
      gap: 8px;
    }

    .appraisal-details {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .appraisal-details div {
      margin-bottom: 4px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* CORRECCIÓN: POSICIÓN DEL BOTÓN CERRAR SESIÓN */
    #user-box {
      display: none;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      margin-top: 16px;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    #user-box[style*="display: flex"] {
      margin-top: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      #user-box {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      #user-box .btn-secondary {
        width: 100%;
        justify-content: center;
      }
    }

    /* CORRECCIONES DE RESPONSIVIDAD PARA MÓVIL - AGREGADAS */
    @media (max-width: 768px){
      .catalog-modal .modal-content {
        max-width: 95vw;
        max-height: 90vh;
        margin: 20px 10px;
      }
      
      .catalog-item-content {
        flex-direction: column;
        text-align: center;
      }
      
      .catalog-image-modal {
        width: 100%;
        height: 150px;
        margin-bottom: 12px;
      }
      
      .catalog-text-modal {
        width: 100%;
      }
      
      .catalog-features-modal {
        text-align: left;
        max-height: 120px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 0 10px;
      }

      .table-ui {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 0.8rem;
      }
      
      .table-ui th,
      .table-ui td {
        padding: 12px 8px;
        min-width: 80px;
      }
      
      #tablaTerreno th,
      #tablaTerreno td {
        min-width: 70px;
        font-size: 0.75rem;
      }
      
      #tablaTerreno th:nth-child(1),
      #tablaTerreno td:nth-child(1) {
        min-width: 100px;
      }
      
      #tablaTerreno th:nth-child(9),
      #tablaTerreno td:nth-child(9),
      #tablaTerreno th:nth-child(10),
      #tablaTerreno td:nth-child(10) {
        min-width: 90px;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: var(--space-sm);
      }
      
      .characteristics-grid {
        grid-template-columns: 1fr;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px;
        font-size: 16px;
      }
      
      .card {
        padding: var(--space-md);
        margin: var(--space-sm) 0;
      }
      
      .card h2 {
        font-size: 1.3rem;
        margin-bottom: var(--space-md);
      }

      .form-navigation {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-navigation button {
        width: 100%;
        padding: 14px 20px;
      }
      
      .floating-actions {
        top: 80px;
        right: 12px;
      }
      
      .floating-btn {
        width: 48px;
        height: 48px;
        font-size: 1rem;
      }
      
      #save-btn, #pdf-btn {
        right: 12px;
        bottom: 70px;
        padding: 12px 16px;
        font-size: 0.8rem;
      }
      
      #pdf-btn {
        bottom: 130px;
      }

      .result-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .result-item {
        padding: 16px 12px;
      }
      
      .result-total {
        padding: 24px 16px;
      }
      
      .result-total .value {
        font-size: 1.5rem;
      }
      
      .appraisal-item {
        padding: 12px;
      }
      
      .appraisal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .appraisal-actions {
        width: 100%;
        justify-content: space-between;
      }

      .typology-trigger {
        padding: 16px;
      }
      
      .selected-image {
        width: 50px;
        height: 50px;
      }
      
      .selected-text {
        min-width: 0;
      }
      
      .selected-type {
        font-size: 0.9rem;
      }
      
      .selected-title {
        font-size: 0.8rem;
      }
      
      .selected-price {
        font-size: 0.75rem;
      }
      
      #precio-editable-container {
        margin-top: 8px;
      }

      .auth-grid {
        grid-template-columns: 1fr;
      }
      
      .auth-panel {
        margin: 10px;
      }
      
      .auth-overlay {
        padding: 10px;
      }

      .form-steps {
        flex-direction: column;
        gap: var(--space-sm);
        padding: 0;
      }
      
      .form-steps::before {
        display: none;
      }
      
      .step {
        flex-direction: row;
        gap: var(--space-sm);
        width: 100%;
        padding: 8px 0;
      }
      
      .step-number {
        width: 40px;
        height: 40px;
        margin-bottom: 0;
      }
      
      .step-label {
        text-align: left;
        flex: 1;
      }

      .app-header h1 {
        font-size: 1.4rem;
      }
      
      .app-header h1 i {
        width: 40px;
        height: 40px;
      }
      
      .form-section-title {
        font-size: 1.1rem;
      }
      
      .form-section-title i {
        width: 32px;
        height: 32px;
      }

      #gmap {
        height: 300px;
      }

      .btn-primary, .btn-secondary {
        padding: 14px 20px;
        font-size: 0.9rem;
      }
      
      .btn-small {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      #all-appraisals-list,
      #my-appraisals-list {
        max-height: 50vh;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <h1><i class="fas fa-home"></i> Sistema de Avalúos</h1>
    </header>

    <div class="floating-actions">
      <button class="floating-btn" id="all-appraisals-btn" title="Lista de Avalúos">
        <i class="fas fa-list"></i>
      </button>
      <button class="floating-btn" id="my-appraisals-btn" title="Mis Avalúos">
        <i class="fas fa-user"></i>
      </button>
    </div>

    <!-- Modal para username después de Google SignIn -->
    <div class="catalog-modal" id="username-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user-plus"></i> Completa tu perfil</h3>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <div class="form-group">
            <label for="google-username" class="required">Elige un nombre de usuario</label>
            <input type="text" id="google-username" placeholder="Ingresa tu username" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius);" />
            <div class="form-help">Este nombre se mostrará en tus avalúos</div>
          </div>
          <button class="btn-primary" id="save-google-username" style="width: 100%; margin-top: 16px;">
            <i class="fas fa-check"></i> Guardar y continuar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para Lista de Avalúos -->
    <div class="catalog-modal" id="all-appraisals-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-list"></i> Lista de Avalúos</h3>
          <button class="modal-close" onclick="closeModal('all-appraisals-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group">
            <input type="text" id="search-appraisals" placeholder="Buscar avalúos..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius);">
          </div>
          <div id="all-appraisals-list" style="max-height: 400px; overflow-y: auto;">
            <!-- Los avalúos se cargarán aquí -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Mis Avalúos -->
    <div class="catalog-modal" id="my-appraisals-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user"></i> Mis Avalúos</h3>
          <button class="modal-close" onclick="closeModal('my-appraisals-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div id="my-appraisals-list" style="max-height: 400px; overflow-y: auto;">
            <!-- Mis avalúos se cargarán aquí -->
          </div>
        </div>
      </div>
    </div>

    <div class="auth-overlay" id="auth-overlay">
      <button class="auth-close" title="Cerrar" onclick="/* no permitir cerrar sin login */void(0)">×</button>
      <div class="auth-panel card">
        <h2><i class="fas fa-user-lock"></i> Acceso requerido</h2>
        <p style="margin-bottom:12px;color:var(--text-light)">
          Inicia sesión para usar el Sistema de Avalúos. Si creas cuenta con correo, debes confirmar desde tu email.
        </p>
        <div class="auth-grid">
          <div class="auth-col">
            <div class="auth-col-title">Con correo</div>
            <input id="auth-email" type="email" placeholder="tu@correo.com" class="auth-input">
            <input id="auth-pass" type="password" placeholder="Contraseña" class="auth-input">
            <input id="auth-username" type="text" placeholder="Username (nuevo)" class="auth-input">
            <button class="btn-primary" type="button" onclick="__signInWithEmail(
              document.getElementById('auth-email').value,
              document.getElementById('auth-pass').value
            )">
              <i class="fas fa-right-to-bracket"></i> Iniciar sesión
            </button>
            <button class="btn-secondary" type="button" style="margin-top:8px" onclick="__signUpWithEmail(
              document.getElementById('auth-email').value,
              document.getElementById('auth-pass').value,
              document.getElementById('auth-username').value
            )">
              <i class="fas fa-user-plus"></i> Crear cuenta
            </button>
            <button class="btn-secondary" type="button" style="margin-top:8px"
              onclick="__resendVerification(document.getElementById('auth-email').value)">
              <i class="fas fa-envelope"></i> Reenviar correo de verificación
            </button>
          </div>

          <div class="auth-col">
            <div class="auth-col-title">Con Google</div>
            <button class="btn-primary" type="button" onclick="__signInWithGoogle()">
              <i class="fab fa-google"></i> Continuar con Google
            </button>
            <div class="form-help" style="margin-top:8px">
              Requiere configurar Google OAuth en Supabase/Google Cloud.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="user-box" style="display:none;align-items:center;gap:12px;justify-content:space-between;margin-top:-16px;">
      <div style="color:var(--text-light)">
        <i class="fas fa-circle-user"></i>
        <span data-user-name></span> · <span data-user-email></span>
      </div>
      <button class="btn-secondary" type="button" onclick="__signOut()">
        <i class="fas fa-arrow-right-from-bracket"></i> Cerrar sesión
      </button>
    </div>

    <div class="form-steps">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-label">Información General</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-label">Características</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-label">Cálculos</div>
      </div>
      <div class="step" data-step="4">
        <div class="step-number">4</div>
        <div class="step-label">Resultados</div>
      </div>
    </div>

    <!-- QUITAR "DATOS DE LA PROPIEDAD" DE TODAS LAS PESTAÑAS -->
    <div class="card">
      <!-- Se quita el título general "Datos de la Propiedad" -->

      <div class="form-section active" data-step="1">
        <h2><i class="fas fa-info-circle"></i> Información General</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="associate-name" class="required">Nombre del Asociado</label>
            <input type="text" id="associate-name" placeholder="Ingrese el nombre completo" required />
            <div class="form-help">Nombre completo del solicitante</div>
          </div>
          <div class="form-group">
            <label for="address" class="required">Dirección de la Propiedad</label>
            <input type="text" id="address" placeholder="Escriba y elija de las sugerencias" required />
            <div class="form-help">La dirección se completará automáticamente</div>
          </div>
          <div class="form-group">
            <label for="geo-lat">Latitud</label>
            <input type="text" id="geo-lat" placeholder="-" readonly />
          </div>
          <div class="form-group">
            <label for="geo-lng">Longitud</label>
            <input type="text" id="geo-lng" placeholder="-" readonly />
          </div>
          <div class="form-group">
            <label for="construction-area" class="required">Área Construida (m²)</label>
            <input type="number" id="construction-area" placeholder="Ej: 120" min="1" required />
          </div>
          <div class="form-group">
            <label for="land-area" class="required">Área del Terreno (m²)</label>
            <input type="number" id="land-area" placeholder="Ej: 200" min="1" required />
          </div>
        </div>
        
        <div style="margin: var(--space-md) 0;">
          <button class="btn-primary" type="button" onclick="locateMeOnce()">
            <i class="fas fa-location-crosshairs"></i> Usar mi ubicación
          </button>
          <div class="form-help">Requiere HTTPS o localhost y permiso del navegador</div>
        </div>

        <div class="form-section-title"><i class="fas fa-map"></i> Ubicación en Mapa</div>
        <div id="gmap" style="height: 360px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border);"></div>
        <div class="form-help">Arrastre el pin para ajustar la posición o <strong>toque/cliquee en cualquier lugar del mapa</strong> para colocar el marcador</div>
      </div>

      <div class="form-section" data-step="2">
        <h2><i class="fas fa-home"></i> Características de la Propiedad</h2>
        
        <div class="form-section-title"><i class="fas fa-file-contract"></i> Datos Registrales</div>
        <div class="form-grid">
          <div class="form-group"><label for="owner-name">Nombre del Propietario</label><input type="text" id="owner-name" placeholder="Ingrese el nombre del propietario" /></div>
          <div class="form-group"><label for="deed-number">Número de Escritura</label><input type="text" id="deed-number" placeholder="Número de escritura" /></div>
          <div class="form-group"><label for="deed-date">Fecha de Escritura</label><input type="date" id="deed-date" /></div>
          <div class="form-group"><label for="notary">Notario</label><input type="text" id="notary" placeholder="Nombre del notario" /></div>
        </div>

        <div class="form-section-title"><i class="fas fa-map-marked-alt"></i> Finca Registrada</div>
        <div class="form-grid">
          <div class="form-group"><label for="finca">Finca</label><input type="text" id="finca" placeholder="Número de finca" /></div>
          <div class="form-group"><label for="folio">Folio</label><input type="text" id="folio" placeholder="Folio" /></div>
          <div class="form-group"><label for="libro">Libro</label><input type="text" id="libro" placeholder="Libro" /></div>
          <div class="form-group"><label for="department">Departamento</label><input type="text" id="department" placeholder="Departamento" /></div>
        </div>

        <div class="form-section-title" style="margin-top: var(--space-lg);"><i class="fas fa-map-marker-alt"></i> Colindancias</div>
        <table class="table-ui">
          <thead><tr><th>Dirección</th><th>Propietario</th><th>Metros</th></tr></thead>
          <tbody>
            <tr><td><strong>Norte:</strong></td><td><input type="text" id="norte-propietario" placeholder="Propietario" /></td><td><input type="number" id="norte-metros" placeholder="Metros" step="0.01" /></td></tr>
            <tr><td><strong>Sur:</strong></td><td><input type="text" id="sur-propietario" placeholder="Propietario" /></td><td><input type="number" id="sur-metros" placeholder="Metros" step="0.01" /></td></tr>
            <tr><td><strong>Oriente:</strong></td><td><input type="text" id="oriente-propietario" placeholder="Propietario" /></td><td><input type="number" id="oriente-metros" placeholder="Metros" step="0.01" /></td></tr>
            <tr><td><strong>Poniente:</strong></td><td><input type="text" id="poniente-propietario" placeholder="Propietario" /></td><td><input type="number" id="poniente-metros" placeholder="Metros" step="0.01" /></td></tr>
          </tbody>
        </table>

        <div class="form-section-title"><i class="fas fa-hammer"></i> Características Constructivas</div>
        <div class="characteristics-grid">
          <div class="form-group"><label for="uso-destino">Uso y Destino</label><select id="uso-destino"><option value="">Seleccionar</option><option value="residencia">Residencia</option><option value="cultivo">Cultivo</option><option value="industrial">Industrial</option><option value="comercial">Comercial</option><option value="edificio">Edificio</option></select></div>
          <div class="form-group"><label for="estructura">Estructura</label><select id="estructura"><option value="">Seleccionar</option><option value="acero">Acero</option><option value="hierro">Hierro</option><option value="concreto">Concreto</option><option value="madera">Madera</option><option value="pre-fab">Pre-Fab</option><option value="adobe">Adobe</option></select></div>
          <div class="form-group"><label for="cimiento">Cimiento</label><select id="cimiento"><option value="">Seleccionar</option><option value="concreto">Concreto</option><option value="adobe">Adobe</option><option value="block">Block</option><option value="ladrillo">Ladrillo</option><option value="piedra">Piedra</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="techos">Techos</label><select id="techos"><option value="">Seleccionar</option><option value="concreto">Concreto</option><option value="lam-zinc">Lam. Zinc</option><option value="dural-roja">Dural. Roja</option><option value="dural-gris">Dural. Gris</option><option value="teja-barro">Teja de barro</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="pisos">Pisos</label><select id="pisos"><option value="">Seleccionar</option><option value="tota-ceramico">Tota-Cerámico</option><option value="ceramico">Cerámico</option><option value="granito">Granito</option><option value="porcelanato">Porcelanato</option><option value="madera">Madera</option><option value="tierra">Tierra</option></select></div>
          <div class="form-group"><label for="acabados">Acabados Interiores</label><select id="acabados"><option value="">Seleccionar</option><option value="repello">Repello</option><option value="cernido">Cernido</option><option value="alisado">Alisado</option><option value="estuco">Estuco</option><option value="tapiz">Tapiz</option><option value="otro">Otro</option></select></div>
          <div class="form-group"><label for="paredes">Paredes</label><select id="paredes"><option value="">Seleccionar</option><option value="block">Block</option><option value="adobe">Adobe</option><option value="madera">Madera</option><option value="bahareque">Bahareque</option><option value="prefabricado">Prefabricado</option><option value="concreto">Concreto</option></select></div>
          <div class="form-group"><label for="ventanas">Ventanas</label><select id="ventanas"><option value="">Seleccionar</option><option value="upvc">UPVC</option><option value="aluminio">Aluminio</option><option value="metal">Metal</option><option value="madera">Madera</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="puertas">Puertas</label><select id="puertas"><option value="">Seleccionar</option><option value="upvc">UPVC</option><option value="madera">Madera</option><option value="metal">Metal</option><option value="pre-fab">Pre-Fab</option><option value="rustica">Rústica</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="cielos">Cielos</label><select id="cielos"><option value="">Seleccionar</option><option value="concreto">Concreto</option><option value="prefabricado">Prefabricado</option><option value="machimbre">Machimbre</option><option value="madera">Madera</option><option value="falsa-terraza">Falsa terraza</option><option value="sin-cielo">Sin Cielo</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="sanitario">Sanitario</label><select id="sanitario"><option value="">Seleccionar</option><option value="bueno">Bueno</option><option value="medio">Medio</option><option value="bajo">Bajo</option><option value="letrina">Letrina</option><option value="pozo">Pozo</option></select></div>
          <div class="form-group"><label for="red-electric">Red Eléctrica</label><select id="red-electric"><option value="">Seleccionar</option><option value="municipal">Municipal</option><option value="energuate">Energuate</option><option value="solar">Solar</option><option value="solar-fed">Solar/Fed</option><option value="sin-elec">Sin Electricidad</option></select></div>
          <div class="form-group"><label for="agua">Servicio de Agua</label><select id="agua"><option value="">Seleccionar</option><option value="municipal">Municipal</option><option value="comunal">Comunal</option><option value="pozo">Pozo</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="estado-inmueble">Estado de Conservación</label><select id="estado-inmueble"><option value="">Seleccionar</option><option value="Excelente">Excelente</option><option value="Bueno">Bueno</option><option value="Regular">Regular</option><option value="Malo">Malo</option></select></div>
          <div class="form-group"><label for="anio-construccion">Año de Construcción</label><input type="number" id="anio-construccion" min="1900" max="2025" placeholder="Ej: 2018" /></div>
        </div>

        <div class="form-group" style="margin-top:24px;">
          <label for="otros-detalles">Otros Detalles Específicos</label>
          <textarea id="otros-detalles" placeholder="Describa otros detalles como: Aire Acondicionado, Car-port, Garaje, Chimeneas, etc."></textarea>
        </div>

        <div class="form-section-title" style="margin-top: var(--space-lg);"><i class="fas fa-list"></i> Seleccionar tipologías</div>
        <div class="form-group">
          <label>Tipología constructiva</label>
          <div class="typology-selector" onclick="__openTypology()">
            <div id="typologyTrigger" class="typology-trigger">
              <img id="selectedImage" class="selected-image" src="https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=200&q=60" alt="Tipología" />
              <div class="selected-text">
                <div id="selectedType" class="selected-type">Catálogo</div>
                <div id="selectedTitle" class="selected-title">Pulsa para elegir del catálogo</div>
                <div id="selectedPrice" class="selected-price">—</div>
              </div>
            </div>
          </div>
          <input type="hidden" id="typology" value="">
          <div class="form-help">Toca el recuadro para abrir el catálogo de tipologías</div>
        </div>
        
        <!-- CONTENEDOR PARA MODIFICAR PRECIO - AGREGADO -->
        <div class="form-group" id="precio-editable-container" style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-hover); border-radius: var(--radius); border: 1px solid var(--border);">
          <label for="precio-editable-input" class="required">Modificar Precio por m² (Q)</label>
          <input type="number" id="precio-editable-input" 
                 value="0" 
                 min="0" step="0.01" 
                 style="padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); width: 100%; margin-bottom: 8px;" />
          <div class="form-help" id="precio-help-text">Seleccione una tipología primero</div>
          
          <!-- BOTÓN PARA APLICAR CAMBIOS -->
          <button class="btn-primary btn-small" type="button" onclick="aplicarCambioPrecio()" style="margin-top: 8px; width: 100%;">
            <i class="fas fa-sync-alt"></i> Aplicar nuevo precio
          </button>
        </div>
      </div>

      <div class="form-section" data-step="3">
        <h2><i class="fas fa-calculator"></i> Datos de propiedad</h2>
        
        <div class="form-section-title"><i class="fas fa-mountain"></i> Cálculo del Valor del Terreno</div>
        <table class="table-ui" id="tablaTerreno">
          <thead>
            <tr>
              <th style="width:140px">V/Base (Q/m²)</th>
              <th style="width:120px">Frente</th>
              <th style="width:120px">Fondo</th>
              <th style="width:140px">Área m²</th>
              <th style="width:120px">Fac. Fte.</th>
              <th style="width:120px">Fac. Fdo.</th>
              <th style="width:120px">Fac. Fma.</th>
              <th style="width:120px">Fac. Ext.</th>
              <th style="width:140px">Otros Fac.</th>
              <th style="width:160px">MONTO</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="number" min="0" step="0.01" class="t-vbase" placeholder="1500"></td>
              <td><input type="number" min="0" step="0.01" class="t-frente" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-fondo" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-area" id="t-area" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffte" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffdo" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffma" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-fext" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-fotros" placeholder="1" value="1"></td>
              <td><input type="text" class="t-monto" id="t-monto" value="0.00" readonly></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="9" style="text-align:right; font-weight:600;">TOTAL TERRENO</td>
              <td><input type="text" id="totalTerreno" value="0.00" readonly></td>
            </tr>
          </tfoot>
        </table>

        <div class="form-section-title"><i class="fas fa-layer-group"></i> Integración de Valores</div>
        <div class="result-grid" id="integracionValores">
          <div class="result-item">
            <div class="label">Valor del Terreno</div>
            <div class="value" id="ivTerreno">Q0.00</div>
          </div>
          <div class="result-item">
            <div class="label">Total Avalúo</div>
            <div class="value" id="ivTotal">Q0.00</div>
          </div>
        </div>

        <div class="form-section-title"><i class="fas fa-building-user"></i> Cálculo del Valor de la Construcción</div>
        <table class="table-ui" id="tablaConstruccion">
          <thead>
            <tr>
              <th style="width:160px">Planta</th>
              <th style="width:140px">Área m²</th>
              <th style="width:140px">V/Base</th>
              <th style="width:120px">%</th>
              <th>Tipo de Construcción</th>
              <th style="width:160px">MONTO</th>
            </tr>
          </thead>
          <tbody id="tbBodyConstruccion">
            <tr>
              <td><input type="text" value="Primer Nivel" class="planta-input"></td>
              <td><input type="number" min="0" step="0.01" class="area-input" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="vbase-input" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" value="1" class="coef-input"></td>
              <td><input type="text" class="tipo-input" placeholder="Ej.: Block y Concreto"></td>
              <td><input type="text" class="monto-output" value="0.00" readonly></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align:right; font-weight:600;">TOTAL</td>
              <td><input type="text" id="totalConstruccion" value="0.00" readonly></td>
            </tr>
          </tfoot>
        </table>

        <div style="display:flex; gap:12px; margin-top:8px;">
          <button class="btn-secondary btn-small" type="button" onclick="agregarFilaConstruccion()">
            <i class="fas fa-plus"></i> Agregar nivel
          </button>
          <button class="btn-secondary btn-small" type="button" onclick="eliminarUltimaFilaConstruccion()">
            <i class="fas fa-minus"></i> Quitar último nivel
          </button>
        </div>

        <div class="form-help" style="margin-top:8px;">
          El MONTO se calcula como: <strong>Área m² × V/Base × %</strong>. Todos los campos son manuales (editables), excepto MONTO.
        </div>
      </div>

      <div class="form-navigation">
        <button class="btn-secondary" id="prev-step"><i class="fas fa-arrow-left"></i> Anterior</button>
        <button class="btn-primary" id="next-step">Siguiente <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <div class="result-section" id="resultSection">
      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> Calculo final</h2>
        <div class="result-grid">
          <div class="result-item"><div class="label">Área Construida</div><div class="value" id="resultArea">0 m²</div></div>
          <div class="result-item"><div class="label">Tipología</div><div class="value" id="resultTypology">-</div></div>
          <div class="result-item"><div class="label">Estado</div><div class="value" id="resultCondition">-</div></div>
          <div class="result-item"><div class="label">Antigüedad</div><div class="value" id="resultAge">0 años</div></div>
          <div class="result-item"><div class="label">Valor Terreno (sin ajuste)</div><div class="value" id="resultLandValue">Q0.00</div></div>
          <div class="result-item"><div class="label">Avaluó Terreno (con ajuste)</div><div class="value" id="resultLandAppraisal">Q0.00</div></div>
          <div class="result-item"><div class="label">Valor Construcción</div><div class="value" id="resultBuildValue">Q0.00</div></div>
          <div class="result-item"><div class="label">TOTAL Terreno + Construcción</div><div class="value" id="resultGrandTotal">Q0.00</div></div>
        </div>
        <div class="result-total"><div class="label">VALOR TOTAL ESTIMADO</div><div class="value" id="resultTotal">Q0.00</div></div>
        <div style="display:flex; gap:12px; margin-top:24px;">
          <button class="btn-primary" onclick="generateReport()" style="flex:1;"><i class="fas fa-file-pdf"></i> Generar Reporte PDF</button>
          <button class="btn-secondary" onclick="newAppraisal()" style="flex:1;"><i class="fas fa-redo"></i> Nuevo Avalúo</button>
        </div>
      </div>
    </div>

    <div class="catalog-modal" id="catalogModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-home"></i> Seleccionar Tipología Constructiva</h3>
          <button class="modal-close" id="closeModal" type="button">&times;</button>
        </div>
        <div class="modal-body" id="modalCatalogContent"></div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div style="color: var(--primary); font-weight: 500;">Generando PDF...</div>
  </div>

  <button id="save-btn" type="button"><i class="fas fa-save"></i> Guardar</button>
  <button id="pdf-btn" type="button"><i class="fas fa-file-pdf"></i> PDF</button>

  <script>
    // FUNCIÓN PARA MODIFICAR PRECIOS DE TIPOLOGÍAS - AGREGADA
    function modificarPrecioTipologia(tipologiaId, nuevoPrecio) {
        // Obtener todas las tipologías
        const tipologias = __getTipos();
        
        // Buscar la tipología específica
        const tipologia = tipologias.find(t => t.id === tipologiaId);
        
        if (!tipologia) {
            console.error('Tipología no encontrada:', tipologiaId);
            return false;
        }
        
        // Obtener el rango de precios para esta tipología
        const rango = RANGOS_PRECIO[tipologia.category]?.[tipologia.type];
        
        if (!rango) {
            console.error('Rango de precios no encontrado para:', tipologia.category, tipologia.type);
            return false;
        }
        
        // Validar que el nuevo precio no supere el máximo permitido
        const precioMaximo = rango.max;
        
        if (nuevoPrecio > precioMaximo) {
            console.warn(`El precio no puede superar Q${precioMaximo}. Se establecerá en el máximo permitido.`);
            nuevoPrecio = precioMaximo;
        }
        
        if (nuevoPrecio < rango.min) {
            console.warn(`El precio no puede ser menor a Q${rango.min}. Se establecerá en el mínimo permitido.`);
            nuevoPrecio = rango.min;
        }
        
        // Actualizar el precio de la tipología
        tipologia.pricePerM2 = nuevoPrecio;
        
        // Si esta tipología está actualmente seleccionada, actualizar el campo editable
        const tipologiaActual = document.getElementById('typology').value;
        if (tipologiaActual === tipologiaId) {
            const precioInput = document.getElementById('precio-editable-input');
            if (precioInput) {
                precioInput.value = nuevoPrecio;
                
                // Actualizar también la visualización del precio
                const pr = document.getElementById('selectedPrice');
                if (pr) {
                    pr.textContent = `Q${nuevoPrecio.toLocaleString('es-GT')}/m²`;
                }
                
                // Recalcular si estamos en resultados
                if (document.getElementById('resultSection').classList.contains('active')) {
                    calculateRealAppraisal();
                }
            }
        }
        
        console.log(`Precio de ${tipologia.title} actualizado a: Q${nuevoPrecio}/m²`);
        return true;
    }

    // FUNCIÓN PARA APLICAR CAMBIO DE PRECIO - AGREGADA
    function aplicarCambioPrecio() {
        const tipologiaId = document.getElementById('typology').value;
        const nuevoPrecio = parseFloat(document.getElementById('precio-editable-input').value);
        
        if (!tipologiaId) {
            alert('Primero seleccione una tipología');
            return;
        }
        
        if (isNaN(nuevoPrecio) || nuevoPrecio <= 0) {
            alert('Ingrese un precio válido mayor a 0');
            return;
        }
        
        // Usar la función que ya existe
        if (modificarPrecioTipologia(tipologiaId, nuevoPrecio)) {
            alert(`Precio actualizado exitosamente a Q${nuevoPrecio}/m²`);
            
            // Recalcular si estamos en resultados
            if (document.getElementById('resultSection').classList.contains('active')) {
                calculateRealAppraisal();
            }
        } else {
            alert('Error al actualizar el precio');
        }
    }

    // Sistema de almacenamiento de avalúos
    window.avaluosStorage = {
      getAllAppraisals: function() {
        try {
          const stored = localStorage.getItem('sistema_avaluos');
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          console.error('Error al cargar avalúos:', e);
          return [];
        }
      },

      saveAppraisal: function(avaluoData) {
        try {
          const avaluos = this.getAllAppraisals();
          const newAppraisal = {
            id: 'av-' + Date.now(),
            usuario_id: window.__session?.user?.id || 'anonimo',
            usuario_nombre: window.__session?.user?.user_metadata?.username || 'Anónimo',
            fecha_creacion: new Date().toISOString(),
            fecha_formateada: new Date().toLocaleDateString('es-GT'),
            datos: avaluoData,
            estado: 'completado'
          };
          
          avaluos.unshift(newAppraisal);
          localStorage.setItem('sistema_avaluos', JSON.stringify(avaluos));
          return newAppraisal;
        } catch (e) {
          console.error('Error al guardar avalúo:', e);
          return null;
        }
      },

      getMyAppraisals: function() {
        const userId = window.__session?.user?.id;
        if (!userId) return [];
        
        const allAppraisals = this.getAllAppraisals();
        return allAppraisals.filter(av => av.usuario_id === userId);
      },

      updateAppraisal: function(appraisalId, newData) {
        try {
          const avaluos = this.getAllAppraisals();
          const index = avaluos.findIndex(av => av.id === appraisalId);
          
          if (index !== -1) {
            avaluos[index].datos = { ...avaluos[index].datos, ...newData };
            avaluos[index].fecha_actualizacion = new Date().toISOString();
            localStorage.setItem('sistema_avaluos', JSON.stringify(avaluos));
            return true;
          }
          return false;
        } catch (e) {
          console.error('Error al actualizar avalúo:', e);
          return false;
        }
      },

      deleteAppraisal: function(appraisalId) {
        try {
          const avaluos = this.getAllAppraisals();
          const filtered = avaluos.filter(av => av.id !== appraisalId);
          localStorage.setItem('sistema_avaluos', JSON.stringify(filtered));
          return true;
        } catch (e) {
          console.error('Error al eliminar avalúo:', e);
          return false;
        }
      }
    };

    // Funciones para mostrar los modales
    function showAllAppraisals() {
      const modal = document.getElementById('all-appraisals-modal');
      const listContainer = document.getElementById('all-appraisals-list');
      
      const allAppraisals = window.avaluosStorage.getAllAppraisals();
      
      if (allAppraisals.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h4>No hay avalúos registrados</h4>
            <p>Los avalúos que se realicen aparecerán aquí</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = allAppraisals.map(avaluo => `
          <div class="appraisal-item">
            <div class="appraisal-header">
              <div class="appraisal-date">
                <i class="fas fa-calendar"></i> ${avaluo.fecha_formateada}
              </div>
              <div class="appraisal-actions">
                <button class="btn-secondary btn-small" onclick="viewAppraisal('${avaluo.id}')">
                  <i class="fas fa-eye"></i> Ver
                </button>
              </div>
            </div>
            <div class="appraisal-details">
              <div><strong>Asociado:</strong> ${avaluo.datos.associateName || 'No especificado'}</div>
              <div><strong>Dirección:</strong> ${avaluo.datos.address || 'No especificado'}</div>
              <div><strong>Valor Total:</strong> ${avaluo.datos.totalValue || 'Q0.00'}</div>
              <div><strong>Usuario:</strong> ${avaluo.usuario_nombre}</div>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function showMyAppraisals() {
      if (!window.__session) {
        alert('Debes iniciar sesión para ver tus avalúos');
        document.getElementById('auth-overlay').style.display = 'flex';
        return;
      }
      
      const modal = document.getElementById('my-appraisals-modal');
      const listContainer = document.getElementById('my-appraisals-list');
      
      const myAppraisals = window.avaluosStorage.getMyAppraisals();
      
      if (myAppraisals.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-file-contract"></i>
            <h4>No tienes avalúos guardados</h4>
            <p>Los avalúos que realices aparecerán aquí</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = myAppraisals.map(avaluo => `
          <div class="appraisal-item">
            <div class="appraisal-header">
              <div class="appraisal-date">
                <i class="fas fa-calendar"></i> ${avaluo.fecha_formateada}
              </div>
              <div class="appraisal-actions">
                <button class="btn-primary btn-small" onclick="editAppraisal('${avaluo.id}')">
                  <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-secondary btn-small" onclick="viewAppraisal('${avaluo.id}')">
                  <i class="fas fa-eye"></i> Ver
                </button>
                <button class="btn-small" style="background: var(--error); color: white; border: none;" onclick="deleteAppraisal('${avaluo.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="appraisal-details">
              <div><strong>Asociado:</strong> ${avaluo.datos.associateName || 'No especificado'}</div>
              <div><strong>Dirección:</strong> ${avaluo.datos.address || 'No especificado'}</div>
              <div><strong>Valor Total:</strong> ${avaluo.datos.totalValue || 'Q0.00'}</div>
              <div><strong>Estado:</strong> <span style="color: var(--success);">${avaluo.estado}</span></div>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function viewAppraisal(appraisalId) {
      const avaluos = window.avaluosStorage.getAllAppraisals();
      const avaluo = avaluos.find(av => av.id === appraisalId);
      
      if (avaluo) {
        alert(`Detalles del Avalúo:\n\n` +
              `Fecha: ${avaluo.fecha_formateada}\n` +
              `Asociado: ${avaluo.datos.associateName || 'No especificado'}\n` +
              `Dirección: ${avaluo.datos.address || 'No especificado'}\n` +
              `Área Construida: ${avaluo.datos.constructionArea || '0'} m²\n` +
              `Valor Total: ${avaluo.datos.totalValue || 'Q0.00'}\n` +
              `Usuario: ${avaluo.usuario_nombre}`);
      }
    }

    function editAppraisal(appraisalId) {
      const avaluos = window.avaluosStorage.getAllAppraisals();
      const avaluo = avaluos.find(av => av.id === appraisalId);
      
      if (avaluo) {
        document.getElementById('associate-name').value = avaluo.datos.associateName || '';
        document.getElementById('address').value = avaluo.datos.address || '';
        document.getElementById('construction-area').value = avaluo.datos.constructionArea || '';
        document.getElementById('land-area').value = avaluo.datos.landArea || '';
        
        closeModal('my-appraisals-modal');
        window.formWizard.goToStep(1);
        
        alert('Avalúo cargado para edición. Modifica los datos y guarda los cambios.');
      }
    }

    function deleteAppraisal(appraisalId) {
      if (confirm('¿Estás seguro de que quieres eliminar este avalúo? Esta acción no se puede deshacer.')) {
        if (window.avaluosStorage.deleteAppraisal(appraisalId)) {
          alert('Avalúo eliminado correctamente');
          showMyAppraisals();
        } else {
          alert('Error al eliminar el avalúo');
        }
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function saveCurrentAppraisal() {
      if (!window.__session) {
        alert('Debes iniciar sesión para guardar avalúos');
        return;
      }
      
      const appraisalData = {
        associateName: document.getElementById('associate-name').value,
        address: document.getElementById('address').value,
        constructionArea: document.getElementById('construction-area').value,
        landArea: document.getElementById('land-area').value,
        totalValue: document.getElementById('resultTotal').textContent,
        ownerName: document.getElementById('owner-name').value,
      };
      
      const savedAppraisal = window.avaluosStorage.saveAppraisal(appraisalData);
      
      if (savedAppraisal) {
        console.log('Avalúo guardado:', savedAppraisal);
      } else {
        alert('Error al guardar el avalúo');
      }
    }

    // Botones flotantes
    document.getElementById('all-appraisals-btn').addEventListener('click', showAllAppraisals);
    document.getElementById('my-appraisals-btn').addEventListener('click', showMyAppraisals);

    // Cerrar modales al hacer click fuera
    document.getElementById('all-appraisals-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal('all-appraisals-modal');
    });
    document.getElementById('my-appraisals-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal('my-appraisals-modal');
    });

    // Precios por categoría y tipología (rangos completos)
    const RANGOS_PRECIO = {
        'Baja': {
            'Baja 1': { min: 250, max: 400 },
            'Baja 2': { min: 250, max: 500 },
            'Media 1': { min: 650, max: 750 },
            'Media 2': { min: 650, max: 850 },
            'Alta 1': { min: 850, max: 950 },
            'Alta 2': { min: 850, max: 1000 }
        },
        'Media': {
            'Baja 1': { min: 800, max: 1100 },
            'Baja 2': { min: 800, max: 1100 },
            'Media 1': { min: 900, max: 1200 },
            'Media 2': { min: 1000, max: 1300 },
            'Alta 1': { min: 1300, max: 1700 },
            'Alta 2': { min: 1400, max: 1800 }
        },
        'Alta': {
            'Baja 1': { min: 1400, max: 1700 },
            'Baja 2': { min: 1500, max: 1800 },
            'Media 1': { min: 1800, max: 2100 },
            'Media 2': { min: 1900, max: 2200 }
        }
    };

    // CORRECCIÓN 1: IMÁGENES FUNCIONALES Y PERMANENTES
    const __FALLBACK_TIPOLOGIAS = [
      // CATEGORÍA BAJA - Viviendas económicas, materiales básicos
      {
        id: "baja-baja-1",
        category: "Baja", 
        type: "Baja 1",
        title: "Categoría Baja — Baja 1",
        img: "https://images.unsplash.com/photo-1570129477492-45c003edd2be?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q250–Q400/m²",
        pricePerM2: 400,
        bullets: ["Estructura de adobe y madera", "Paredes con nylon", "Techo de teja de barro sin cielo falso", "Piso de tierra con cemento", "Ventanas y puertas de madera sin tratar"]
      },
      {
        id: "baja-baja-2",
        category: "Baja",
        type: "Baja 2", 
        title: "Categoría Baja — Baja 2",
        img: "https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q250–Q500/m²",
        pricePerM2: 500,
        bullets: ["Estructura de adobe con columnas de madera", "Paredes de adobe, madera sin tratar y cartón", "Techo de teja de barro y lámina de zinc", "Piso de tierra con cemento", "Fachada sin mantenimiento"]
      },
      {
        id: "baja-media-1",
        category: "Baja",
        type: "Media 1",
        title: "Categoría Baja — Media 1", 
        img: "https://images.unsplash.com/photo-1564013799919-ab600027ffc6?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q650–Q750/m²",
        pricePerM2: 750,
        bullets: ["Estructura de adobe y block con pines fundidos", "Paredes con repello", "Techo de lámina de zinc con cielo falso de machimbre", "Piso de cemento líquido y cerámico", "Fachada tipo corredor"]
      },
      {
        id: "baja-media-2",
        category: "Baja",
        type: "Media 2",
        title: "Categoría Baja — Media 2",
        img: "https://images.unsplash.com/photo-1513584684374-8bab748fbf90?auto=format&fit=crop&w=800&q=80", 
        priceRange: "Q650–Q850/m²",
        pricePerM2: 850,
        bullets: ["Estructura de mampostería con columnas", "Paredes de block de cantera", "Techo de lámina de zinc", "Piso de cemento líquido", "Fachada sin diseño con ventanas y materiales expuestos"]
      },
      {
        id: "baja-alta-1",
        category: "Baja",
        type: "Alta 1",
        title: "Categoría Baja — Alta 1",
        img: "https://images.unsplash.com/photo-1449824913935-59a10b8d2000?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q850–Q950/m²",
        pricePerM2: 950,
        bullets: ["Estructura de mampostería con pines fundidos a 0.60 m", "Paredes de block de cantera con pintura", "Techo de lámina troquelada", "Piso de cemento líquido", "Ventanas y puertas de metal o madera sin tratar", "Instalaciones ocultas"]
      },
      {
        id: "baja-alta-2",
        category: "Baja", 
        type: "Alta 2",
        title: "Categoría Baja — Alta 2",
        img: "https://images.unsplash.com/photo-1472224371017-08207f84aaae?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q850–Q1,000/m²",
        pricePerM2: 1000,
        bullets: ["Estructura de adobe y mampostería reforzada", "Paredes de adobe con repello, cernido y block normado", "Techo de teja de barro y lámina de zinc con cielo falso de madera", "Piso de granito y cemento líquido", "Instalaciones ocultas o expuestas"]
      },

      // CATEGORÍA MEDIA - Viviendas estándar, materiales convencionales
      {
        id: "media-baja-1",
        category: "Media",
        type: "Baja 1", 
        title: "Categoría Media — Baja 1",
        img: "https://images.unsplash.com/photo-1518780664697-55e3ad937233?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q800–Q1,100/m²",
        pricePerM2: 1100,
        bullets: ["Estructura de mampostería con block y pines fundidos", "Paredes de block con repello y cernido", "Techo de lámina de zinc sin cielo falso", "Piso de cemento líquido", "Fachada tipo corredor"]
      },
      {
        id: "media-baja-2",
        category: "Media",
        type: "Baja 2",
        title: "Categoría Media — Baja 2",
        img: "https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q800–Q1,100/m²", 
        pricePerM2: 1100,
        bullets: ["Estructura de mampostería con columnas para un nivel", "Paredes de block sizado visto con repello y pintura parcial", "Techo de tejas de barro y lámina de zinc con cielo falso de madera", "Piso de cemento líquido", "Fachada sin diseño arquitectónico"]
      },
      {
        id: "media-media-1",
        category: "Media",
        type: "Media 1",
        title: "Categoría Media — Media 1",
        img: "https://images.unsplash.com/photo-1571068316344-75bc76f77890?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q900–Q1,200/m²",
        pricePerM2: 1200,
        bullets: ["Estructura de mampostería reforzada para un nivel", "Paredes de block con repello y cernido", "Techo metálico con lámina troquelada", "Piso de cemento líquido", "Fachada tipo corredor interno", "Instalaciones semi ocultas"]
      },
      {
        id: "media-media-2",
        category: "Media",
        type: "Media 2",
        title: "Categoría Media — Media 2", 
        img: "https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,000–Q1,300/m²",
        pricePerM2: 1300,
        bullets: ["Estructura de mampostería reforzada", "Paredes de block normado con repello, cernido y pintura", "Techo de madera con lámina de zinc", "Piso de granito y cemento líquido", "Fachada tradicional sin diseño arquitectónico", "Instalaciones ocultas o semi ocultas"]
      },
      {
        id: "media-alta-1",
        category: "Media",
        type: "Alta 1",
        title: "Categoría Media — Alta 1",
        img: "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,300–Q1,700/m²", 
        pricePerM2: 1700,
        bullets: ["Estructura de mampostería reforzada con columnas para dos niveles", "Paredes de ladrillo sisado visto con pintura", "Techo de losa de concreto armado", "Piso de granito", "Fachada de casas de ladrillo", "Instalaciones ocultas"]
      },
      {
        id: "media-alta-2",
        category: "Media",
        type: "Alta 2",
        title: "Categoría Media — Alta 2",
        img: "https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,400–Q1,800/m²",
        pricePerM2: 1800,
        bullets: ["Estructura de mampostería reforzada con pines", "Paredes de block normado con repello, alisado y pintura", "Techo metálico con lámina de zinc", "Piso cerámico", "Fachada tipo colonial con balcones", "Instalaciones ocultas"]
      },

      // CATEGORÍA ALTA - Viviendas premium, materiales de alta calidad
      {
        id: "alta-baja-1",
        category: "Alta", 
        type: "Baja 1",
        title: "Categoría Alta — Baja 1",
        img: "https://images.unsplash.com/photo-1512918728675-ed5a9ecdebfd?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,400–Q1,700/m²",
        pricePerM2: 1700,
        bullets: ["Columnas y paredes de carga", "Repello, alisado y pintura", "Losa de concreto o prefabricada", "Piso cerámico, granito o porcelanato", "Ventanas de aluminio o PVC", "Puertas de madera, metal o prefabricadas", "Fachada tipo corredor", "Instalaciones ocultas"]
      },
      {
        id: "alta-baja-2",
        category: "Alta",
        type: "Baja 2",
        title: "Categoría Alta — Baja 2", 
        img: "https://images.unsplash.com/photo-1580587771525-78b9dba3b914?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,500–Q1,800/m²",
        pricePerM2: 1800,
        bullets: ["Columnas y paredes de carga", "Repello, alisado y pintura", "Losa de concreto o prefabricada", "Piso cerámico, granito o porcelanato", "Ventanas de aluminio o PVC", "Puertas de madera, metal o prefabricadas", "Fachada con acabados y pintura", "Instalaciones ocultas"]
      },
      {
        id: "alta-media-1",
        category: "Alta",
        type: "Media 1",
        title: "Categoría Alta — Media 1",
        img: "https://images.unsplash.com/photo-1567496898669-ee935f5f647a?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,800–Q2,100/m²",
        pricePerM2: 2100,
        bullets: ["Mampostería reforzada con columnas para dos niveles", "Paredes de block normado con repello, alisado y pintura", "Losa de concreto o prefabricada", "Piso cerámico, granito o porcelanato", "Ventanas de aluminio y uPVC", "Fachada con detalles arquitectónicos", "Instalaciones ocultas"]
      },
      {
        id: "alta-media-2",
        category: "Alta",
        type: "Media 2", 
        title: "Categoría Alta — Media 2",
        img: "https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?auto=format&fit=crop&w=800&q=80",
        priceRange: "Q1,900–Q2,200/m²",
        pricePerM2: 2200,
        bullets: ["Mampostería reforzada con columnas", "Paredes de block normado con repello, alisado y pintura", "Losa de concreto o prefabricada", "Piso cerámico, granito o porcelanato", "Ventanas de aluminio y uPVC", "Fachada con diseño arquitectónico", "Instalaciones ocultas"]
      }
    ];

    function __getTipos(){try{return Array.isArray(window.TIPOLOGIAS)&&window.TIPOLOGIAS.length?window.TIPOLOGIAS:__FALLBACK_TIPOLOGIAS;}catch{return __FALLBACK_TIPOLOGIAS;}}

    // FUNCIÓN CORREGIDA - Campo de precio editable FUNCIONAL
    function __selectTipo(id) {
      const s = __getTipos().find(z => z.id === id);
      if (!s) return;
      
      // Obtener rango completo
      const rango = RANGOS_PRECIO[s.category]?.[s.type] || { min: 500, max: 1000 };
      const rangoTexto = `Q${rango.min.toLocaleString('es-GT')}–Q${rango.max.toLocaleString('es-GT')}/m²`;
      
      const img = document.getElementById('selectedImage');
      const tp = document.getElementById('selectedType');
      const ti = document.getElementById('selectedTitle');
      const pr = document.getElementById('selectedPrice');
      const hd = document.getElementById('typology');
      
      if (img) img.src = s.img;
      if (tp) tp.textContent = `Categoría ${s.category} — ${s.type}`;
      if (ti) ti.textContent = s.title;
      if (pr) pr.textContent = rangoTexto;
      if (hd) hd.value = s.id;
      
      // MOSTRAR Y CONFIGURAR EL CAMPO DE PRECIO EDITABLE
      const precioContainer = document.getElementById('precio-editable-container');
      const precioInput = document.getElementById('precio-editable-input');
      const helpText = document.getElementById('precio-help-text');
      
      if (precioContainer) {
          precioContainer.style.display = 'block';
          if (precioInput) {
              precioInput.value = s.pricePerM2 || rango.max;
              precioInput.min = rango.min;
              precioInput.max = rango.max * 2;
          }
          if (helpText) {
              helpText.textContent = `Rango sugerido: ${rangoTexto} - Puede modificar el precio manualmente`;
          }
      }
      
      s.pricePerM2 = s.pricePerM2 || rango.max;
      
      // Recalcular si estamos en resultados
      if (document.getElementById('resultSection').classList.contains('active')) {
          calculateRealAppraisal();
      }
      
      __closeTypology();
    }

    // MODIFICACIÓN: Función __renderTipos actualizada para mostrar rangos completos
    function __renderTipos(){
      const t=__getTipos();
      const b=t.reduce((a,x)=>{((a[x.category]??=[]).push(x));return a;},{});for(const k in b) b[k].sort((a,c)=>a.type.localeCompare(c.type));
      const d=document.getElementById('modalCatalogContent');if(!d) return;let h='';
      for(const c of ['Baja','Media','Alta']){
        if(!b[c])continue;
        h+=`<div class="catalog-item-modal" style="background:var(--bg)"><div class="catalog-item-content"><div class="catalog-text-modal"><div class="catalog-type-modal">Categoría ${c}</div><div class="catalog-title-modal" style="color:var(--text-light)">Seleccione Tipología - Ver rangos de precio</div></div></div></div>`;
        for(const it of b[c]){
          // Obtener rango completo para cada item
          const rango = RANGOS_PRECIO[it.category]?.[it.type] || { min: 500, max: 1000 };
          const rangoTexto = `Q${rango.min.toLocaleString('es-GT')}–Q${rango.max.toLocaleString('es-GT')}/m²`;
          
          h+=`<div class="catalog-item-modal" data-id="${it.id}"><div class="catalog-item-content"><img class="catalog-image-modal" src="${it.img}" alt="${it.title}"><div class="catalog-text-modal"><div class="catalog-type-modal">${it.type}</div><div class="catalog-title-modal">${it.title}</div><div class="catalog-price-modal" style="color: var(--primary); font-weight: 600;">${rangoTexto}</div><div class="catalog-description-modal"><ul class="catalog-features-modal">${(it.bullets||[]).map(m=>`<li><i class="fas fa-check"></i>${m}</li>`).join('')}</ul></div><button class="select-button" data-select="${it.id}"><i class="fas fa-hand-pointer"></i> Seleccionar esta tipología</button></div></div></div>`;
        }
      }
      d.innerHTML=h;
      d.querySelectorAll('.catalog-item-modal').forEach(c=>{
        const id=c.getAttribute('data-id');if(!id)return;
        c.addEventListener('click',e=>{if(e.target.closest('button'))return;__selectTipo(id);});
      });
      d.querySelectorAll('[data-select]').forEach(b=>{
        b.addEventListener('click',e=>{e.stopPropagation();__selectTipo(b.getAttribute('data-select'));});
      });
    }
    function __openTypology(){const m=document.getElementById('catalogModal');const t=document.getElementById('typologyTrigger');if(!m) return alert('No se encontró el modal (#catalogModal).');m.classList.add('active');t?.classList.add('active');__renderTipos();const hb=e=>{if(e.target===m){__closeTypology();m.removeEventListener('click',hb);}};m.addEventListener('click',hb);const x=document.getElementById('closeModal');if(x) x.onclick=__closeTypology;}
    function __closeTypology(){const m=document.getElementById('catalogModal');const t=document.getElementById('typologyTrigger');if(!m) return;m.classList.remove('active');t?.classList.remove('active');}
    window.__openTypology=__openTypology; window.__closeTypology=__closeTypology;
  </script>

  <!-- EL RESTO DEL CÓDIGO JAVASCRIPT PERMANECE IGUAL -->
  <script>
    function formatMoneyGTQ(v){
      return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ',minimumFractionDigits:2}).format(Number(v||0));
    }

    function recalcularFila(tr){
      const area = parseFloat(tr.querySelector('.area-input')?.value)||0;
      const vbase = parseFloat(tr.querySelector('.vbase-input')?.value)||0;
      const coef = parseFloat(tr.querySelector('.coef-input')?.value)||0;
      const monto = area * vbase * coef;
      const out = tr.querySelector('.monto-output');
      if(out){ out.value = monto.toFixed(2); }
      return monto;
    }

    function recalcularTablaConstruccion(){
      const rows = Array.from(document.querySelectorAll('#tbBodyConstruccion tr'));
      let total = 0, sumaArea = 0;
      rows.forEach(tr=>{
        total += recalcularFila(tr);
        const area = parseFloat(tr.querySelector('.area-input')?.value)||0;
        sumaArea += area;
      });
      const totalEl = document.getElementById('totalConstruccion');
      if(totalEl) totalEl.value = total.toFixed(2);

      if(document.getElementById('resultSection').classList.contains('active')){
        document.getElementById('resultBuildValue').textContent = formatMoneyGTQ(total);
        
        const fallbackArea = parseFloat(document.getElementById('construction-area').value)||0;
        const areaMostrar = (sumaArea>0? sumaArea : fallbackArea).toFixed(2);
        document.getElementById('resultArea').textContent = `${areaMostrar} m²`;

        const estado = document.getElementById('estado-inmueble').value || 'No especificado';
        document.getElementById('resultCondition').textContent = estado;

        const anioConstruccion=parseInt(document.getElementById('anio-construccion').value)||0;
        const antiguedad = anioConstruccion? (new Date().getFullYear()-anioConstruccion) : 0;
        document.getElementById('resultAge').textContent = `${antiguedad} años`;

        const tipId=document.getElementById('typology').value;
        let tipText='No seleccionada';
        try{
          const t = (Array.isArray(window.TIPOLOGIAS)&&window.TIPOLOGIAS.length?window.TIPOLOGIAS:__FALLBACK_TIPOLOGIAS).find(x=>x.id===tipId);
          if(t) tipText = `${t.category}-${t.type}`;
        }catch{}
        document.getElementById('resultTypology').textContent = tipText;

        const land=parseFloat(document.getElementById('totalTerreno')?.value)||0;
        document.getElementById('resultLandValue').textContent = formatMoneyGTQ(land);
        document.getElementById('resultLandAppraisal').textContent = formatMoneyGTQ(land);
        document.getElementById('resultGrandTotal').textContent = formatMoneyGTQ(land + total);
        document.getElementById('resultTotal').textContent = formatMoneyGTQ(land + total);
      }
    }

    function bindRowEvents(tr){
      ['input','change'].forEach(evt=>{
        tr.addEventListener(evt, e=>{
          if(e.target.matches('.area-input,.vbase-input,.coef-input')){
            recalcularTablaConstruccion();
            integrarValores(); 
          }
        });
      });
    }

    function agregarFilaConstruccion(){
      const tbody = document.getElementById('tbBodyConstruccion');
      const n = tbody.querySelectorAll('tr').length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="Nivel ${n}" class="planta-input"></td>
        <td><input type="number" min="0" step="0.01" class="area-input" placeholder="0"></td>
        <td><input type="number" min="0" step="0.01" class="vbase-input" placeholder="0"></td>
        <td><input type="number" min="0" step="0.01" value="1" class="coef-input"></td>
        <td><input type="text" class="tipo-input" placeholder="Ej.: Block y Concreto"></td>
        <td><input type="text" class="monto-output" value="0.00" readonly></td>
      `;
      tbody.appendChild(tr);
      bindRowEvents(tr);
    }

    function eliminarUltimaFilaConstruccion(){
      const tbody = document.getElementById('tbBodyConstruccion');
      const rows = tbody.querySelectorAll('tr');
      if(rows.length>1){
        tbody.removeChild(rows[rows.length-1]);
        recalcularTablaConstruccion();
        integrarValores(); 
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const firstRow = document.querySelector('#tbBodyConstruccion tr');
      if(firstRow) bindRowEvents(firstRow);
    });
  </script>

  <script>
    function recalcularTerreno() {
      const row = document.querySelector('#tablaTerreno tbody tr');
      if (!row) return 0;

      const num = (sel) => {
        const value = row.querySelector(sel)?.value;
        return value === '' ? 0 : parseFloat(value) || 0;
      };

      const fac = (sel) => {
        const v = parseFloat(row.querySelector(sel)?.value);
        return isNaN(v) || v <= 0 ? 1 : v;
      };

      let area = num('.t-area');
      const frente = num('.t-frente');
      const fondo = num('.t-fondo');
      
      if ((area === 0 || isNaN(area)) && frente > 0 && fondo > 0) {
        area = frente * fondo;
        const tAreaEl = row.querySelector('.t-area');
        if (tAreaEl) tAreaEl.value = area.toFixed(2);
      }
      else if (area > 0 && (frente === 0 || fondo === 0)) {
        area = num('.t-area');
      }

      const vbase = num('.t-vbase');
      const ffte  = fac('.t-ffte');
      const ffdo  = fac('.t-ffdo');
      const ffma  = fac('.t-ffma');
      const fext  = fac('.t-fext');
      const fotros= fac('.t-fotros');

      const monto = area * vbase * ffte * ffdo * ffma * fext * fotros;

      const out = document.getElementById('t-monto');
      if (out) out.value = monto.toFixed(2);

      const totalTerrenoEl = document.getElementById('totalTerreno');
      if (totalTerrenoEl) totalTerrenoEl.value = monto.toFixed(2);

      const ivTerrenoEl = document.getElementById('ivTerreno');
      if (ivTerrenoEl) ivTerrenoEl.textContent = formatMoneyGTQ(monto);

      if (document.getElementById('resultSection').classList.contains('active')) {
        document.getElementById('resultLandValue').textContent = formatMoneyGTQ(monto);
        document.getElementById('resultLandAppraisal').textContent = formatMoneyGTQ(monto);
      }

      return monto;
    }

    function integrarValores() {
      const terreno = parseFloat(document.getElementById('totalTerreno')?.value) || 0;
      const construccion = parseFloat(document.getElementById('totalConstruccion')?.value) || 0;
      const total = terreno + construccion;

      const ivT = document.getElementById('ivTerreno');
      const ivTot = document.getElementById('ivTotal');
      if (ivT) ivT.textContent = formatMoneyGTQ(terreno);
      if (ivTot) ivTot.textContent = formatMoneyGTQ(total);

      if (document.getElementById('resultSection').classList.contains('active')) {
        document.getElementById('resultGrandTotal').textContent = formatMoneyGTQ(total);
        document.getElementById('resultTotal').textContent = formatMoneyGTQ(total);
        document.getElementById('resultBuildValue').textContent = formatMoneyGTQ(construccion);
      }
    }

    const __origCalculateRealAppraisal = window.calculateRealAppraisal;
    window.calculateRealAppraisal = function() {
      if (typeof __origCalculateRealAppraisal === 'function') {
        __origCalculateRealAppraisal();
      }
      recalcularTerreno();
      integrarValores();
    };

    document.addEventListener('DOMContentLoaded', () => {
      const row = document.querySelector('#tablaTerreno tbody tr');
      if (row) {
        row.querySelectorAll('input').forEach(inp => {
          ['input','change'].forEach(evt => {
            inp.addEventListener(evt, () => {
              recalcularTerreno();
              integrarValores();
            });
          });
        });
      }
     
      recalcularTerreno();
      integrarValores();
    });
  </script>

  <script>
    let gMap=null,gMarker=null,gGeocoder=null,gAutocomplete=null;
    
    function setLatLngInputs(lat,lng){
      const latEl=document.getElementById('geo-lat');
      const lngEl=document.getElementById('geo-lng');
      if(latEl) latEl.value=Number(lat).toFixed(6); 
      if(lngEl) lngEl.value=Number(lng).toFixed(6);
    }
    
    function setGMarker(lat,lng,center=true){
      if(!gMap) return;
      const pos={lat:Number(lat),lng:Number(lng)};
      if(!gMarker){
        gMarker=new google.maps.Marker({
          position:pos,
          map:gMap,
          draggable:true,
          animation:google.maps.Animation.DROP
        });
        gMarker.addListener('dragend',()=>{
          const p=gMarker.getPosition();
          const la=p.lat(),ln=p.lng();
          setLatLngInputs(la,ln);
          reverseGeocodeGoogle(la,ln);
        });
      }else{
        gMarker.setPosition(pos);
      }
      if(center) gMap.setCenter(pos);
    }
    
    async function reverseGeocodeGoogle(lat,lng){
      if(!gGeocoder) gGeocoder=new google.maps.Geocoder();
      const addressEl=document.getElementById('address');
      try{
        const {results}=await gGeocoder.geocode({location:{lat,lng}});
        if(results&&results[0]&&addressEl){
          addressEl.value=results[0].formatted_address;
        }
      }catch(e){
        console.warn('Geocoder error:',e);
      }
    }
    
    function attachAutocomplete(){
      const addressEl=document.getElementById('address');
      if(!addressEl) return;
      try{
        gAutocomplete=new google.maps.places.Autocomplete(addressEl,{
          fields:['geometry','formatted_address']
        });
        gAutocomplete.addListener('place_changed',()=>{
          const place=gAutocomplete.getPlace();
          if(!place?.geometry?.location) return;
          const lat=place.geometry.location.lat();
          const lng=place.geometry.location.lng();
          setLatLngInputs(lat,lng);
          setGMarker(lat,lng,true);
        });
      }catch(e){
        console.warn('Places Autocomplete no disponible.',e);
      }
    }
    
    function locateMeOnce(){
      if(!('geolocation'in navigator)){
        alert('Geolocalización no disponible.');
        return;
      }
      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat=pos.coords.latitude;
        const lng=pos.coords.longitude;
        setLatLngInputs(lat,lng);
        if(gMap) setGMarker(lat,lng,true);
        await reverseGeocodeGoogle(lat,lng);
      },err=>{
        const msgs={1:'Permiso denegado',2:'Posición no disponible',3:'Tiempo agotado'};
        alert('No se pudo obtener la ubicación: '+(msgs[err.code]||err.message));
      },{
        enableHighAccuracy:true,
        timeout:15000,
        maximumAge:0
      });
    }
    
    function initGMap(){
      const container=document.getElementById('gmap');
      const start={
        lat:Number(document.getElementById('geo-lat')?.value)||14.6349,
        lng:Number(document.getElementById('geo-lng')?.value)||-90.5069
      };
      
      gMap=new google.maps.Map(container,{
        center:start,
        zoom:14,
        mapTypeControl:false,
        streetViewControl:false,
        fullscreenControl:true,
        gestureHandling:'greedy'
      });
      
      gMap.addListener('click', function(event) {
        const lat = event.latLng.lat();
        const lng = event.latLng.lng();
        setGMarker(lat, lng, false);
        setLatLngInputs(lat, lng);
        reverseGeocodeGoogle(lat, lng);
      });
      
      setGMarker(start.lat,start.lng,true);
      attachAutocomplete();
    }
    
    window.locateMeOnce=locateMeOnce;
    window.initGMap=initGMap;
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCsWVTI4PKDqGp-wJgWZnD2IbOvd0wKPhQ&libraries=places&callback=initGMap" async defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    function calculateRealAppraisal(){
      const totalConstruccion = parseFloat(document.getElementById('totalConstruccion')?.value)||0;

      let sumaArea = 0;
      document.querySelectorAll('#tbBodyConstruccion .area-input').forEach(i=>{
        sumaArea += parseFloat(i.value)||0;
      });
      const areaConstruccion = sumaArea>0 ? sumaArea : (parseFloat(document.getElementById('construction-area').value)||0);

      const estado=document.getElementById('estadoble').value||-inmueble').value||'No especificado';
      const'No especificado';
      const anioConst anioConstruccionruccion=parseInt(document.getElementById=parseInt(document.getElementById('anio-('anio-construccion').construccion').value)value)||0||0;
      const antigued;
      const antiguedad=anad=anioConstruioConstruccion? new Dateccion? new Date().getFull().getFullYear()-Year()-anioConstruccionanioConstruccion :  : 0;

      const0;

      const tipologiaId=document tipologiaId=document.getElementById('.getElementById('typologytypology').value;
      let').value;
      let tipText='No tipText='No seleccion seleccionadaada';
      try{
        const t=(Array.isArray';
      try{
        const t=(Array.isArray(window(window.TIPOLOG.TIPOLOGIAS)&&window.TIPIAS)&&window.TIPOLOGIAS.length?OLOGIAS.length?window.Twindow.TIPOLOGIPOLOGIAS:__FALLBACKIAS:__FALLBACK_TIPOLOGIAS).find_TIPOLOGIAS).find(x=>x.id===tip(x=>x.id===tipologiaId);
        if(t) tipologiaId);
        if(t)Text=` tipText=`${t.category}-${t.category}-${t.type}`${t.type}`;
     ;
      }catch{}

      const formatCurrency=(v }catch{}

      const formatCurrency=(v)=> new)=> new Intl.Number Intl.NumberFormat('Format('es-Ges-GT',{style:'currencyT',{style:'currency',currency',currency:'GTQ',:'GTQ',minimumFractionminimumFractionDigits:2}).Digits:2}).format(v);

      document.getElementById('format(v);

      document.getElementById('resultArea').resultArea').textContent=`${textContent=`${areaConstruccion.toFixedareaConstruccion.toFixed(2)} m²`;
      document(2)} m²`;
      document.getElementById('.getElementById('resultTypology').resultTypology').textContent=tipText;
textContent=tipText;
      document      document.getElementById('resultCondition').text.getElementById('resultCondition').textContent=Content=estado;
     estado;
      document.getElementById('resultAge'). document.getElementById('resultAge').textContenttextContent=`${antiguedad} años=`${antiguedad`;

     } años`;

      const terreno = const terreno = parseFloat(document parseFloat(document.getElementById('totalTer.getElementById('totalTerrenoreno')?.value) ||')?.value) || 0;
      0;
      document.getElementById('result document.getElementById('resultLandValueLandValue').textContent=').textContent=formatCurrency(formatCurrency(terreno);
      document.getElementById('resultLandterreno);
      document.getElementById('resultLandAppraisal').textContent=formatCurrencyAppraisal').textContent=formatCurrency(terreno);

     (terreno);

      document document.getElementById('.getElementById('resultBuildValue').textContentresultBuildValue').textContent=formatCurrency(total=formatCurrency(totalConstruConstruccion);
      document.getElementById('ccion);
      document.getElementById('resultGrandTotalresultGrandTotal').textContent=format').textContent=formatCurrency(terrenoCurrency(terreno + total + totalConstruccion);
     Construccion);
      document.getElementById(' document.getElementById('resultTotal').textContent=resultTotal').textContent=formatCurrencyformatCurrency(terreno +(terreno + totalConstruccion totalConstruccion);
    }

   );
    }

    async function generateReport async function generateReport(){
      const loading(){
      const loadingOverlay=documentOverlay=document.getElementById('loadingOverlay');.getElementById('loadingOverlay'); loading loadingOverlay.style.display='flex';
Overlay.style.display='flex';
      try      try{
        if(typeof window{
        if(typeof window.jspdf==.jspdf==='undefined'){ await loadScript('https='undefined'){ await loadScript('https://://cdnjs.cloudcdnjs.cloudflare.com/ajaxflare.com/ajax/libs/jspdf/2.5.1/libs/jspdf/2.5.1/jspdf/jspdf.umd..min.js'); }
        if(typeofumd.min.js'); }
        if(typeof window.jspdf window.jspdfAutoTableAutoTable==='undefined'){ await load==='undefined'){ awaitScript('https://cdnjs.cloudflare.com loadScript('https://cdnjs.cloudflare.com/ajax/libs/j/ajax/libs/jspdf-autspdf-autototable/3.5able/3.5.28/jspdf.plugin.autotable.min.js'); }
       .28/jspdf.plugin.autotable.min.js'); }
 const { jsPDF }=        const { jsPDF }=windowwindow.jspdf; const.jspdf; const doc=new js doc=new jsPDF(); constPDF(); const pageWidth=doc pageWidth=doc.internal.pageSize.getWidth();.internal.pageSize.getWidth(); const margin= const margin=20; const20; const contentWidth=pageWidth-( contentWidth=pageWidth-(margin*2);
        doc.setFillmargin*2);
        doc.setFillColor(Color(91,123,12291,123,122); doc.); doc.rect(0,rect(0,0,pageWidth0,pageWidth,60,60,'F');
       ,'F');
        doc.setTextColor doc.setTextColor(255,255,(255,255,255);255); doc.setFontSize(20 doc.setFontSize(20);); doc doc.setFont('helvetica','.setFont('helvetica','bold'); doc.text('REbold'); doc.text('REPORTE DE AVALÚPORTE DE AVALÚO',margin,30);
        doc.setFontO',margin,30);
        docSize(.setFontSize(10); doc10); doc.setFont.setFont('hel('helvetica','normal'); docvetica','normal'); doc.text(`Generado.text(`Generado: ${new Date: ${new Date().to().toLocaleDateString('es-GLocaleDateString('es-GT')}`,T')}`,margin,45);margin,45); doc.text('Sistema doc.text('Sistema de de Avalúos Profesional Avalúos Profesional', page', pageWidth - margin - 80Width - margin - 80, , 45);

       45);

        let y=80;
        doc.setFill let y=80;
        doc.setFillColor(240,240,Color(240,240,240); doc.240); doc.rect(margin,yrect(margin,y-10,contentWidth,-10,contentWidth,15,'F'); doc.setTextColor(15,'F'); doc.setText91,123,Color(91,123,122);122); doc.setFontSize doc.setFontSize(14(14); doc); doc.setFont('helvetica.setFont('helvetica','bold'); doc.text','bold'); doc.text('IN('INFORMACIÓNFORMACIÓN DE LA PROPI DE LA PROPIEDADEDAD',margin,y',margin,y); y+=20;
       ); y+=20;
        const basicData const basicData=[
=[
          ['Asociado:',          ['Asociado:',document.getElementById('associate-name').value||document.getElementById('associate-name').value||'No espec'No especificado'],
          ['Direcciónificado'],
          ['Dirección:',:',document.getElementByIddocument.getElementById('address').value||'No especificado'],
          ['('address').value||'No especificado'],
          ['PropietPropietario:',document.getElementById('owner-name').value||ario:',document.getElementById('owner-name').value||'No especificado'],
          ['Á'No especificado'],
          ['Área Construida:',document.getElementById('rea Construida:',document.getElementById('resultArea').textresultArea').textContent||'NoContent||'No especificado'],
          especificado'],
          ['Área Terreno ['Área Terreno:',:',document.getElementById('land-area').valuedocument.getElementById('land-area').value??document.getElementById('landdocument.getElementById('land-area').value+' m²':'No especificado-area').value+' m²':'No espec']
        ];
        doc.setTextificado']
        ];
        doc.setTextColor(Color(0,0,0); doc.setFont0,0,0); doc.setFontSize(10); doc.setFont('Size(10); doc.setFont('helvetica','normal');
        basichelvetica','normal');
        basicData.forEach((Data.forEach(([l,v])=[l,v])=>{doc.setFont('hel>{doc.setFont('helvetica','bold');vetica','bold'); doc.text(l,margin,y); doc.setFont(' doc.text(l,margin,y); doc.setFonthelvetica','normal'); doc.text('helvetica','normal');(v,margin doc.text(v,margin+45,y+45,y); y+=8;}); y+=); y+=8;});10 y+=10;

        doc.set;

        doc.setFillColor(240,240FillColor(240,240,,240); doc.rect(m240); doc.rect(margin,y-10,contentWidth,argin,y-10,contentWidth,15,'F15,''); doc.setTextColorF'); doc.setTextColor(91,123,122(91,123,122); doc.set); doc.setFontSize(14FontSize(14); doc.setFont('hel); doc.setFont('helvetica','bold'); doc.text('RESULTADvetica','bold'); doc.text('OS DEL AVALRESULTADOS DEL AVALÚO',margin,y); yÚO',margin,y+=20;
       ); y+=20;
        const resultsData const resultsData=[
          ['Tipología=[
          ['Tipología',',document.getElementById('resultTypology').textdocument.getElementById('resultTypology').Content],
          ['textContent],
          ['Estado',Estado',document.getElementById('resultCondition').document.getElementById('resultCondition').textContent],
          ['Antigüedad',textContent],
          ['Antigdocument.getElementByIdüedad',document.getElementById('resultAge').textContent('resultAge').textContent],
         ],
          ['Valor Terreno',document ['Valor Terreno',.getElementByIddocument.getElementById('('resultLandValue').textContent],
resultLandValue').textContent],
          ['Val          ['Valor Construcción',document.getElementByIdor Construcción',document.getElementById('resultBuildValue('resultBuildValue').textContent').textContent],
          ['TOTAL],
          ['TOTAL',document',document.getElementById('.getElementById('resultTotal').textContent]
        ];
resultTotal').textContent]
        ];
        doc.auto        doc.autoTable({startY:yTable({startY:y, head:[['Concepto','Val, head:[['Concepto','or']], bodyValor']], body:results:resultsData, theme:'grid', headStylesData, theme:'grid', headStyles:{fillColor:{fillColor:[91,123,:[91,123,122],122], textColor:255, textColor:255, fontStyle:'bold' fontStyle:'bold'},}, styles:{fontSize:10, styles:{fontSize:10, cellPadding:5 cellPadding:5}, column}, columnStyles:{0:{fontStyleStyles:{0:{fontStyle:'bold:'bold', cellWidth:100},1:{', cellWidth:100},1cellWidth:{cellWidth:80}}, margin:80}}, margin:{left:margin:{left:margin,right,right:margin:margin}});
        y=}});
        y=doc.lastAutodoc.lastAutoTable.finalTable.finalY+15;

       Y+15;

        doc.set doc.setFillColorFillColor(91,123,(91,123,122); doc.rect122); doc.rect(margin(margin,y,contentWidth,25,y,contentWidth,25,'F');,'F'); doc.setTextColor(255 doc.setTextColor(255,255,255);,255,255); doc doc.setFontSize(16);.setFontSize(16); doc.setFont('helvetica','bold'); doc doc.setFont('helvetica','bold.text(''); doc.text('VALORVALOR TOTAL ESTIMADO',margin TOTAL ESTIMADO',margin+10,y+15+10,y+15); doc.set); doc.setFontSize(20); docFontSize(20); doc.text(document.getElementById('resultTotal').textContent, pageWidth - margin - 80, y+.text(document.getElementById('resultTotal').textContent, pageWidth - margin - 80, y+15); y+=40;

        if15); y+=40;

        if(y>240){ doc.addPage();(y>240){ doc.add y=20; }

        doc.setFillColor(240Page(); y=20; }

        doc.setFillColor(,240,240,240,240240); doc); doc.rect(margin,y-10.rect(margin,y-10,contentWidth,contentWidth,15,'F,15,'F'); doc.setTextColor'); doc.setTextColor(91,(91,123,122);123,122); doc.setFont doc.setFontSize(Size(14); doc.set14); doc.setFont('helvetica','Font('helvetica','bold'); docbold'); doc.text('COLIND.text('COLINDANCIANCIAS',margin,y); y+=20AS',margin,y); y+=20;
        const colData=[
          ['Norte',;
        const colData=[
          ['Norte',document.getElementById('norte-propdocument.getElementById('norte-propietario').value||'',(ietario').value||'',(document.getElementById('norte-metros').value||'')+' m'],
document.getElementById('norte-metros').value||'')+' m'],
          ['Sur          ['Sur',document.getElementById('',document.getElementById('sur-propsur-propietarioietario').value||'',(document').value||'',(document.getElementById('sur-met.getElementById('sur-metros').ros').value||'')+'value||'')+' m'],
 m'],
          ['Oriente',document.getElementById('or          ['Oriente',document.getElementById('oriente-propietiente-propietario').value||'',(documentario').value||'',(document.getElementById('oriente.getElementById('oriente-metros-metros').value||'')+' m'],
').value||'')+' m'],
          ['Poniente',document.getElementById          ['Poniente',('pondocument.getElementById('poniente-propietarioiente-propietario').value||'',').value||'',(document(document.getElementById('pon.getElementById('poniente-metrosiente-metros').value||'')').value||'')+' m']
+' m']
        ];
        doc.        ];
        doc.autoautoTable({startY:y, head:[Table({startY:y, head:[['Dirección','['Dirección','Propietario','MetPropietario','Metros']ros']], body:col], body:colData,Data, theme:'grid', headStyles theme:'grid', headStyles:{fill:{fillColor:[91,123,122Color:[91,123,],textColor122],textColor:255,font:255,fontStyle:'Style:'bold'}, stylesbold'}, styles:{font:{fontSize:9,Size:9, cellPadding:4}, cellPadding:4}, margin:{left margin:{left:margin,right::margin,right:marginmargin}});

       }});

        const totalPages= const totalPages=doc.internal.getNumberOfPagesdoc.internal.getNumberOfPages();
       ();
        for(let i=1;i for(let i=1;i<=totalPages;i<=totalPages;i++){
          doc.set++){
          doc.setPage(iPage(i); doc.setFontSize(8); doc.setTextColor(); doc.setFontSize(8); doc.setText128,128,128);
          doc.text(`Color(128,128,128);
P          doc.text(`Páginaágina ${i} de ${totalPages} - Sistema ${i} de ${total de AvalúosPages} - Sistema de Avalúos`, pageWidth/2, doc.internal`, pageWidth/2,.pageSize.getHeight()-10, {align doc.internal.pageSize.getHeight()-10:'center'});
, {align:'center'        }
        const fileName=`Avaluo});
        }
        const fileName_${document.getElementById('associate-name=`Avaluo_${document.getElementById('associate-name').value').value||'||'Propiedad'}_${Propiedad'}_${new Date().new Date().toISOString().toISOString().slice(slice(0,0,10)}.pdf10)}.pdf`;
        doc.save(fileName`;
        doc.save(fileName);
);
      }catch(error      }catch(error){
        console.error){
        console.error('Error generando PDF:',error('Error generando PDF:',error); alert('Error al generar el PDF:); alert('Error al generar el PDF: '+error '+error.message);
      }
      finally{ loadingOverlay.style.display='none'; }
   .message);
      }
      finally{ loadingOverlay.style.display=' }
    function loadScript(src){none'; }
    }
    function loadScript(src){return new Promisereturn new Promise((resolve,((resolve,reject)=reject)=>{const s=document.createElement('script');s>{const s=document.createElement('script');s.src=.src=src; s.onload=resolve; s.onsrc; s.onload=resolve; s.onerror=reject; documenterror=reject; document.head.head.appendChild(s);});}

.appendChild(s);});}

    class    class FormW FormWizard{
      constructor(){this.currentStep=1; this.totalStepsizard{
      constructor(){this.currentStep=1; this=4; this.totalSteps=4; this.init();}
      init(){.init();}
      init(){this.bindEvents();this.bindEvents(); this.updateUI(); this.updateUI();}
     }
      bindEvents(){
        bindEvents(){
        document document.getElementById('next-step').add.getElementById('next-step').addEventListener('clickEventListener('click',()=>this',()=>this.next());
.next());
        document.getElementById('        document.getElementById('prev-stepprev-step').addEventListener('click',').addEventListener('click',()=>this()=>this.previous());
.previous());
        document.querySelectorAll        document.querySelectorAll('.step('.step').forEach').forEach(step=>{
          step(step=>{
          step.addEventListener('click',.addEventListener('click',(e(e)=>{
            const n=parseInt)=>{
            const n=parseInt(e.currentTarget.dat(e.currentTarget.dataset.stepaset.step);
            if(n<this);
            if(n<this.currentStep){this.goToStep(n.currentStep){this.goToStep);}
          });
(n);}
          });
        });
        });
      }
      validateStep(step){
      }
      validateStep(step        const req=document.querySelectorAll){
        const req=(`[data-step="${document.querySelectorAll(`[data-step="${step}"] [required]`);
       step}"] [required]`);
        let ok=true; req.forEach(f=> let ok=true; req.forEach{if(f=>{if(!f.value(!f.value.trim()){f.style.border.trim()){f.style.bColor='var(--error)orderColor='var(--error)'; ok=false;} else{f'; ok=false;} else{f.style.b.style.borderColor='';}});
       orderColor='';}} if(!ok){alert('Por favor completa);
        if(!ok){alert('Por todos los campos requeridos favor completa todos los campos requer marcados con *');}
        return ok;
idos marcados con *');}
             }
      next(){
        if return ok;
      }
     (this.currentStep next(){
        if(this.currentStep<this.totalSteps){
          if(this.validate<this.totalSteps){
          ifStep(this.currentStep)){ this.currentStep++;(this.validateStep(this.currentStep this.update)){ this.currentStep++; this.updateUI(); }
        } else { this.calculateUI(); }
        } elseAppraisal { this.calculateAppraisal(); }
(); }
      }
           }
      previous(){ if(this.currentStep>1){ this previous(){ if(this.currentStep>1){ this.currentStep--.currentStep--; this.updateUI; this.updateUI(); } }
      go(); } }
      goToToStep(Step(step){ ifstep){ if(step>=1&&(step>=1&&step<=this.totalSteps){ this.currentStep=step<=this.totalSteps){ this.currentStep=stepstep; this.updateUI();; this.updateUI(); } }
      updateUI(){
 } }
      updateUI(){
        document.querySelectorAll        document.querySelectorAll('.step').('.step').forEach(s=>{
forEach(s=>{
          const n          const n=parseInt(s.dat=parseInt(s.datasetaset.step);
          s.classList.remove('active','completed');
          if.step);
          s.classList.remove('active','completed');
          if(n===this.currentStep){s(n===this.currentStep){s.classList.add('.classList.add('active');}
active');}
          else if(n          else if(n<this.current<this.currentStep){s.classList.addStep){s.classList.add('completed('completed');}
        });
        document');}
        });
        document.querySelector.querySelectorAll('.form-section').forEach(All('.form-section').forEachsec=>{
          sec.classList.remove(sec=>{
          sec.classList.remove('('active'); if(parseactive'); if(parseInt(sec.dataset.stepInt(sec.dataset.step)===this.current)===this.currentStep){sec.classList.addStep){sec.classList.add('active('active');}
        });
');}
        });
        const prevBtn=        const prevBtn=documentdocument.getElementById('prev-step');
        const nextBtn=document.getElementById('prev-step');
        const nextBtn=document.getElementById('next-step');
        prevBtn.style.display=.getElementById('next-step');
        prevBtn.style.display=this.currentStep>1?'flex':'none';
        nextthis.currentStep>1?'flex':'Btnnone';
        nextBtn.innerHTML=this.innerHTML=this.currentStep===this.currentStep===this.totalSteps?'<i class="fas.totalSteps?'<i class="fas fa fa-calculator"></i> Cal-calculator"></i> Calcular Avalúo':'Sigucular Avalúo':'Siente <iguiente <i class="i class="fas fa-arrow-right"></ifas fa-arrow-right"></i>';
>';
      }
      calculateAppraisal      }
      calculateAppraisal(){
        if(this.validateStep(){
        if(this.validateStep(this(this.currentStep)){
          const nextBtn.currentStep)){
          const nextBtn=document.getElementById('next-step');
          const=document.getElementById('next-step');
 original=nextBtn          const original=nextBtn.innerHTML.innerHTML;
          nextBtn.innerHTML='<i;
          nextBtn.innerHTML=' class="fas fa<i class="fas fa-sp-spinner fa-spin"></i>inner fa-spin"></i> Calculando...'; nextBtn.disabled=true Calculando...'; nextBtn.dis;
          setTimeout(()abled=true;
          setTimeout(()=>=>{
            calculateRealAppraisal();
           {
            calculateRealAppraisal document.getElementById('resultSection').classList();
            document.getElementById('resultSection')..add('classList.add('active');
            document.getElementById('active');
save-btn').style.display='flex';
            document.getElementById('pdf-btn            document.getElementById('save-btn').style.display='flex';
            document').style.getElementById('pdf-btn').style.display='flex';
            nextBtn.innerHTML=original.display='flex';
            nextBtn.innerHTML; nextBtn.disabled=false;
          },800=original; nextBtn.disabled=false;
          },800);
        }
);
        }
      }
    }
         }
    }
    function newAppraisal(){
      document.getElementById('result function newAppraisal(){
      document.getElementById('resultSection').classListSection').classList.remove('active');
.remove('active');
      document.getElementById('      document.getElementById('save-btnsave-btn').style').style.display='none';
      document.display='none';
      document.getElementById('pdf.getElementById('pdf-btn').style-btn').style.display='none';
      window.form.display='none';
      window.formWizard.goWizard.goToStep(1);
    }
    document.addEventListenerToStep(1);
    }
    document.addEventListener('('DOMContentLoaded',function(){
     DOMContentLoaded',function(){
      window.formWizard window.formWizard=new Form=new FormWizard();
      document.getElementById('saveWizard();
      document.getElementById('save-btn').addEventListener('click',function-btn').addEventListener('click(){ 
        saveCurrentAppraisal();
        alert',function(){ 
        save('DCurrentAppraisal();
        alert('Datos guardados exitosamente'); 
atos guardados exitosamente      });
'); 
      });
      document.getElementById('pdf-btn').addEventListener('click',      document.getElementById('pdf-btn').addEventListener('function(){ generateReportclick',function(){ generateReport();(); });
      document.getElementById(' });
      document.getElementById('catalogModal').addEventListener('catalogModal').addEventListener('click',click',function(e){ if(e.target===function(e){ if(e.target===thisthis){ __closeTypology){ __closeTypology(); }(); } });
      document.getElementById(' });
      document.getElementById('closeModal').closeModal').addEventListener('clickaddEventListener('click',function(){ __closeTypology(); });
    });
',function(){ __closeTyp ology(); });
    });
  </script>

  <script type=" </script>

  <script type="module">
module">
    import { create    import { createClient } from "https://Client } from "https://esesm.sh/@m.sh/@supabasesupabase/supabase-js@2";

/supabase-js@2";

       const SUPABASE_URL = " const SUPABASE_URL = "https://csinbmcauhttps://csinbmcauuyljjqshawiuyljjqshawi.supabase.co";
    const SUPABASE.supabase.co";
    const SUPABASE_AN_ANON_KEY = "ON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCIeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ey6IkpXVCJ9.eyJJpc3MiOiJzdXBhpc3MiOiJzdYmFzZSIsInXBhYmFzZSIsJlInJlZiI6ImNzaW5ibZiI6ImNzaW5ibWNhdXV5bGpqcWNhdXV5bGpqcXNoXNoYXdpIiwicmYXdpIiwicm9sZ9sZSI6ImSI6ImFub24iFub24iLCJpYXLCJpYXQQiOjE3NTiOjE3NTk1MjMyk1MjMyNTcsImV4cCI6MjA3NTA5NTcsImV4cCI6MjA3NTA5OTI1NOTI1N30._0c30._0cV_TgcHMV_TgcHMjkixjkixigFEMcigFEMcS34MGbtS34MGbtz7pcz7pcupog5-LuupKoPA";

    let PUBLICog5-LuKoPA";

    let PUBLIC_APP_URL = window.location.origin +_APP_URL = window.location.origin + window.location window.location.pathname;
    if.pathname;
    if (!PUBLIC_ (!PUBLIC_APP_URLAPP_URL.ends.endsWith("/")) PUBLICWith("/")) PUBLIC_APP_URL += "/";

_APP_URL += "/";

    window    window.supabase = createClient(SUP.supabase = createClient(ABASE_URL, SUPSUPABASE_URL, SUPABASE_ANON_KEY);

ABASE_ANON_KEY);

    function __update    function __updateAuthUI(isLogged){
     AuthUI(isLogged){
      const overlay = document const overlay = document.getElementById('.getElementById('authauth-overlay');
      const-overlay');
      const userBox = document.getElementById(' userBox = document.getElementById('user-box');
      if(overlayuser-box');
      if(overlay) overlay.style.display) overlay.style.display = isLogged ? = isLogged ? 'none' : 'flex';
      'none' : 'flex if(userBox){
';
      if(userBox){
        userBox.style.display = isLogged ?        userBox.style.display = isLogged 'flex' : 'none';
        if(isLogged ? 'flex' : 'none';
        if(isLogged){
         ){
          const email const email = window.__session?.user?.email || "";
 = window.__session?.user?.email || "";
                   const username = window.__session?.user?. const username = window.__session?.user?.user_metadata?.user_metadata?.username ||username || "";
          userBox.querySelector('[data-user- "";
          userBox.querySelector('[data-user-email]').textContent = emailemail]').textContent = email;
         ;
          userBox.querySelector('[data-user-name] userBox.querySelector('[data-user-name]').textContent = username || "(sin username)').textContent =";
 username || "(sin username)        }
      }
      const nextBtn = document.getElementById('next";
        }
      }
      const nextBtn =-step');
 document.getElementById('next-step');
      if(nextBtn      if(nextBtn) nextBtn.disabled = !) nextBtn.disabled = !isLogged;
isLogged;
    }

    (async () => {
    }

    (async ()      const => {
      const { data: { { data: { session} session} } } = await window = await window.supabase.auth.getSession();
      window.supabase.auth.getSession();
      window.__session.__session = session || null;
      = session || null;
      __updateAuthUI(!!session);
 __updateAuthUI(!!session);
    })();

    window.supabase.auth.onAuthState    })();

    window.supabase.auth.onAuthStateChange((Change((_event, session) => {
      window.__session_event, session) => {
      window.__ = session || null;
     session = session || null;
      __updateAuthUI(!!session);
    __updateAuthUI(!!session);
    });

    window });

    window.__signUpWithEmail = async (email,.__signUpWithEmail = async ( password, username) => {
      try {
       email, password, username) const { => {
      try {
        const { data, error } = await window.supabase.auth.signUp data, error }({
          = await window.supabase.auth.signUp({
          email,
          password,
          email,
          password,
          options: { data options: { data:: { username }, emailRedirectTo: PUBLIC_APP_URL { username }, emailRedirectTo: PUBLIC }
        });
       _APP_URL }
        });
        if (error) if (error) {
          if ( {
          if (String(error.message || '').String(error.message || '').toLowerCase().includes('alreadytoLowerCase().includes('already'))')) {
            const {
            const { error: e { error: e2 } = await window.supabase.auth2 } = await window.sup.signInWithPassword({ email, passwordabase.auth.signInWithPassword({ });
            if (e2 email, password });
            if (e2) throw e2;
) throw e2;
                       return;
          }
          throw error;
        }
        if return;
          }
          throw error;
        }
        if (!data?.session (!data?.session) {
) {
          alert("Te enviamos un          alert("Te enviamos un correo correo de confirmación. de confirmación. Revisa spam/promoc Revisa spam/promocionesiones.\nDespués de confirmar, vuelve.\nDespués de confirm a estaar, vuelve a esta página página.");
        }
      } catch (e) {
       .");
        }
      } catch ( console.error("signUp error:", e);
       e) {
        console.error("signUp error:", e);
 alert("Error al crear cuenta: " + (        alert("Error al creare?. cuenta: " + (e?.message || e));
      }
    };

    window.__signmessage || e));
      }
InWithEmail    };

    window.__signInWith = async (email, password) => {
Email = async (email, password)      try {
        const { error } = await => {
      try {
        const { error } = await window.supabase.auth.sign window.supabase.auth.signInWithPasswordInWithPassword({ email, password });
       ({ email, password });
        if if (error) throw error;
      } catch (error) throw error;
      (e) {
        } catch (e) {
 const msg = String(e?.message        const msg = String(e || '').toLowerCase();
        if (msg.includes('?.message || '').toLowerCase();
        if (msg.includes('emailemail')') && msg.includes('confirm')) && msg.includes('confirm')) {
          alert {
          alert("Tu correo aún no está confirm("Tu correo aún no estáado. Revisa tu email y confirma la cuenta confirmado. Revisa tu email y confirma la cuenta.");
        } else {
          alert("Error al.");
        } else {
          alert("Error al iniciar sesión iniciar sesión: " + (e?.message || e));
       : " + (e?.message || e));
        }
        console.error }
        console.error("signIn error("signIn error:", e);
      }
   :", e);
      }
    };

    // FUNCIÓN CORREGIDA PARA };

    // FUNCIÓN CORREG GOOGLE OAIDA PARA GOOGLE OAUTH
    window.__signInWithGoogle =UTH
    window.__sign async () => {
      try {
        const {InWithGoogle = async () => {
      try {
        const { data, error } data, error } = await window = await window.supabase.auth.signInWithO.supabase.auth.signInWithOAuthAuth({
          provider: "google",
          options({
          provider: "google",
: { 
                     options: { 
            redirectTo: window.location.origin,
            query redirectTo: window.location.origin,
Params: {
              access_type: 'offline            queryParams: {
              access_type: 'offline',
             ',
              prompt: prompt: 'consent'
 'consent'
            }
          }
        });
            }
          }
        });
        
        if (error) {
                 
        if (error) {
          console.error("Error Google O console.error("Error Google OAuth:", error);
          
          // Si fallaAuth:", error);
          
          // OAuth, mostrar instrucciones alternativas
          Si falla OAuth, mostrar instrucciones alternativas
          if if (error.message?.includes (error.message?.includes('provider')) {
            alert("Google('provider')) {
            alert("Google OAuth no está configurado. Contacte OAuth no está configu al administrador pararado. Contacte al administrador para configurar Google OAuth en configurar Google OAuth en Supabase Supabase.\n\nMientras tanto, puede usar registro con email.\n\nMientras tanto, puede usar registro con email.");
          }.");
          } else {
            else {
            alert("Error con Google: alert("Error con Google: " + " + error.message);
 error.message);
          }
                   }
          return;
        }
        
        return;
        }
        
 // Éxito - la        // Éxito - redirección se la redirección se mane maneja automáticamente
        consoleja automáticamente
       .log("Google OAuth inici console.log("Google OAuth iniciado correctamenteado correctamente");
        
      } catch (e) {
        console.error");
        
      } catch (e) {
        console("Error completo Google OAuth:", e);
        alert("Error al.error("Error completo Google OAuth:", e);
        conectar con alert("Error al conectar con Google. Intente con otro método o Google. Intente con otro método o contacte al administrador.");
      contacte al administrador.");
      }
    };

    function showUsernameModal(userId }
    };

    function showUsernameModal(userId)) {
      {
      const modal = document.getElementById('username-modal');
      const usernameInput const modal = document.getElementById('username-modal');
      const username = document.getElementById('google-Input = document.getElementById('google-username');
      constusername');
      const saveButton = document.getElementById('save saveButton = document.getElementById('save--google-username');
google-username');
      
      if (!modal || !username      
      if (!modal || !usernameInputInput || !saveButton) || !saveButton) return;
      
      modal return;
      
      modal.classList.add.classList.add('active');
('active');
      
      saveButton      
      saveButton.replaceWith(saveButton.clone.replaceWith(saveButton.cloneNode(true));
      const newSaveButton = document.getElementById('Node(true));
      const newsave-googleSaveButton = document.getElementById('save-google-username');
      
     -username');
      
      newSaveButton.addEventListener('click newSaveButton.addEventListener('click', async () => {
        const username = usernameInput.value.trim', async () => {
        const username();
        
        if (!username) {
          alert('Por favor = usernameInput.value.trim();
        
        if (!username) {
          ingresa un nombre de usuario');
          return;
 alert('Por favor ingresa un nombre de usuario');
          return;
        }
        }
        
        
        if (username.length < 3) {
                 if (username.length < 3) {
          alert(' alert('El username debe tener al menos 3 caracteres');
El username debe tener al menos 3 caracteres');
          return          return;
        }
        
       ;
        }
        
        try {
          new try {
          newSaveButtonSaveButton.innerHTML =.innerHTML = '<i class=" '<i class="fas fa-spinner fa-spin"></fas fa-spinner fa-spin"></i> Guardando...';
          newSaveButton.disabledi> Guardando...';
          = true;
          
 newSaveButton.disabled = true;
          
          const { error          const { error } = await window.sup } = await window.supabase.authabase.auth.updateUser({
            data: { username:.updateUser({
            data: { username }
          });
 username: username }
          });
          
          if (error) throw error          
          if (error) throw error;
          
;
          
          modal          modal.classList.remove('active');
         .classList.remove('active');
          usernameInput usernameInput.value = '';
          
.value = '';
          
          const { data          const { data: { session } } =: { session } } = await await window.supabase.auth.getSession();
          window.__session window.supabase.auth.getSession = session;
         ();
          window.__session = session;
          __update __updateAuthUI(!!session);
          
         AuthUI(!!session);
          
          alert(` alert(`¡Bienvenido ${username}! Tu per¡Bienvenido ${fil ha sido actualusername}! Tu perfil ha sido actualizado.`);
          
        }izado.`);
          
        } catch ( catch (error) {
         error) {
          console.error('Error updating username:', error);
          console.error('Error updating username:', error alert('Error al);
          alert('Error al guardar username: guardar username: ' + (error.message || error));
          ' + (error.message || error));
          newSaveButton newSaveButton.innerHTML.innerHTML = '<i class="fas fa-check"></i = '<i class="fas fa-check"></> Guardar y continuar';
          newSaveButton.disabled = false;
        }
      });
      
      modal.addEventListener('click', function(e) {
       i> Guardar y continuar';
          newSaveButton.disabled = false;
        }
      });
      
      modal.addEventListener('click', function if (e.target === modal)(e) {
        if (e.target === modal) {
          {
          modal.classList.remove('active');
        }
      });
 modal.classList.remove('active');
      
             }
      });
      
      usernameInput.addEventListener('keypress', function usernameInput.addEventListener('keypress', function(e) {
       (e) {
        if (e.key === 'Enter') {
          if (e.key === 'Enter') {
          newSave newSaveButton.clickButton.click();
        }
      });
      
      setTimeout();
        }
      });
      
      setTimeout(()(() => usernameInput.focus => usernameInput.focus(), (), 300);
    }

    document.addEventListener('300);
    }

    documentDOMContentLoaded', async () => {
      const.addEventListener('DOMContentLoaded', async () { data: { => {
      const { data: { session } } = await session } } = await window.supabase.auth.get window.supabase.auth.getSessionSession();
      if (session?.user && !session.user.user_();
      if (session?.usermetadata?.username) {
        setTimeout(() => {
          showUsernameModal(session.user.id);
        }, 1500);
      && !session.user.user_metadata?.username) {
        setTimeout(() => {
          showUsernameModal(session.user.id);
        }, 1500);
      }
    }
    });

    window.__resendVerification = async (email) => });

    window.__resendVerification = async (email) => {
      try {
 {
      try {
        if        if (!email) return (!email) return alert("E alert("Escribe tu correo primero.");
scribe tu correo primero.");
               const { data, error } = await window.sup const { data, error }abase.auth.resend = await window.supabase.auth.resend({ type: 'signup({ type: 'signup', email });
       ', email });
        if (error if (error) throw) throw error;
        error;
        alert("Listo, alert("Listo, te reenv te reenviamos el correoiamos el correo. Revis. Revisa bandeja y spam.");
      } catch (e) {
a bandeja y spam.");
      } catch (e)        console.error("resend {
        console.error("resend error:", e);
        alert("No error:", e);
        alert(" se pudo reenviar: "No se pudo reenvi + (e?.message || e));
     ar: " + (e }
    };

    window.__?.message || e));
      }
signOut    };

    window.__sign = async () => { await window.supabase.auth.signOut(); };
    windowOut = async () => { await window.supabase.auth.signOut(); };
    window.__canUseApp.__canUseApp = () => !! = () => !!window.__session;

    document.addEventListener('DOMContentwindow.__session;

    document.addEventListener('DOMContentLoaded', ()Loaded', () => => {
      const next {
      const nextBtnBtn = document.getElementById('next-step');
      if(nextBtn){
 = document.getElementById('next-step');
      if(nextBtn){
        nextBtn.addEventListener('click', (e) => {
          if(!window        nextBtn.addEventListener('click', (e) => {
          if(!window.__canUseApp()){
           .__canUseApp()){
            e.stopImmediatePropagation();
 e.stopImmediatePropagation();
            e.preventDefault();
            document            e.preventDefault();
            document.getElementById('auth.getElementById('auth-overlay').style.display='flex-overlay').style.display='flex';
           ';
            alert("Inicia ses alert("Inicia sesiónión para continuar.");
 para continuar.");
          }
                 }
        }, true);
      }
    }, true);
      }
    });

    const });

    const _origCalculate = window.calculateRealAppraisal _origCalculate = window.calculateRealAppraisal;
    if(_;
    if(_origCalculate){
      window.calculateorigCalculate){
      window.calculateRealAppraisalRealAppraisal = function(){
        if(!window.__canUseApp = function(){
        if(!()){
          documentwindow.__canUseApp()){
          document.getElementById('auth-overlay')..getElementById('auth-overlay').style.displaystyle.display='='flex';
          alert("Inicia sesión para calcular el avflex';
          alert("Inicia sesión para calcularalúo.");
          return el avalúo.");
;
        }
        return _origCalculate          return;
        }
        return _origCalculate.apply(this, arguments);
      };
    }
  </.apply(this, arguments);
      };
    }
  </script>

  <scriptscript>

  <script>
    (function () {
>
    (function ()      const url = new URL(window.location {
      const url = new URL(window.location.href);
      const hashStr =.href);
      const hashStr = url.hash url.hash.startsWith('#').startsWith('#') ? url.hash.slice(1 ? url.hash.slice(1)) : url.hash : url.hash;
      const hash;
      const hash = new URLSearchParams(hashStr = new URLSearchParams(hash);
      const qs = new URLSearchParamsStr);
      const qs = new URLSearchParams(url.search(url.search);
      const);
      const msg = hash.get msg = hash.get("error_description") || hash.get("error_description") || hash.get("error") || q("error") || qs.get("s.get("error_description") || qserror_description") || qs.get("error.get("error");
      if");
      if (msg) {
 (msg) {
        console.error        console.error("Auth callback error:", msg);
        alert("Auth callback error:", msg("Autenticación: " + msg);
);
        alert("Autenticación: " + msg);
      }
      }
    })    })();
  </script();
  </script>
</body>
</html>

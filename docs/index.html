<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#5B7B7A" />
  <title>Sistema de Avalúos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #5B7B7A; --primary-light: #8AA6A5; --primary-dark: #3A5958;
      --secondary: #A6B5A5; --accent: #8C9B9A;
      --success: #10B981; --warning: #F59E0B; --error: #EF4444;
      --text: #2D3748; --text-light: #718096; --text-lighter: #A0AEC0;
      --bg: #F9FAFB; --bg-card: #FFFFFF; --bg-hover: #F8FAFC;
      --border: #E2E8F0; --border-light: #F1F5F9;
      --shadow: 0 1px 3px 0 rgba(0,0,0,.02), 0 1px 2px 0 rgba(0,0,0,.03);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,.03), 0 2px 4px -1px rgba(0,0,0,.02);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.03), 0 4px 6px -2px rgba(0,0,0,.02);
      --radius: 12px; --radius-sm: 8px; --radius-lg: 16px;
      --space-xs: 8px; --space-sm: 16px; --space-md: 24px; --space-lg: 32px; --space-xl: 48px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
    body { background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
    .app-container { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-md); }
    .app-header { background: rgba(255,255,255,.95); padding: var(--space-md) 0; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); margin-bottom: var(--space-lg); backdrop-filter: blur(10px); }
    .app-header h1 { font-size: 1.75rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); color: var(--primary); }
    .app-header h1 i { background: rgba(91,123,122,.1); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .form-steps { display: flex; justify-content: space-between; margin-bottom: var(--space-xl); position: relative; padding: 0 var(--space-md); }
    .form-steps::before { content: ''; position: absolute; top: 24px; left: var(--space-md); right: var(--space-md); height: 2px; background: var(--border); z-index: 1; }
    .step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; cursor: pointer; transition: .3s; flex: 1; }
    .step-number { width: 48px; height: 48px; border-radius: 50%; background: var(--bg); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: var(--space-xs); transition: .3s; }
    .step-label { font-size: .875rem; font-weight: 500; color: var(--text-light); text-align: center; transition: .3s; }
    .step.active .step-number { background: var(--primary); border-color: var(--primary); color:#fff; }
    .step.active .step-label { color: var(--primary); font-weight: 600; }
    .step.completed .step-number { background: var(--success); border-color: var(--success); color:#fff; }
    .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--space-xl); margin: var(--space-lg) 0; box-shadow: var(--shadow); border: 1px solid var(--border); transition: .3s; }
    .card h2 { font-size: 1.5rem; color: var(--text); margin-bottom: var(--space-lg); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); }
    .card h2 i { background: rgba(91,123,122,.1); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .form-section { margin-bottom: var(--space-xl); display: none; animation: fadeIn .5s ease; }
    .form-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to{ opacity:1; transform:translateY(0);} }
    .form-section-title { font-size: 1.25rem; color: var(--text); margin-bottom: var(--space-md); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border-light); }
    .form-section-title i { background: rgba(91,123,122,.1); width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: var(--space-md); }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: .9rem; font-weight: 500; color: var(--text); margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs); }
    .required::after { content:'*'; color: var(--error); margin-left: 4px; }
    .form-group input,.form-group select,.form-group textarea { padding: 14px 16px; border:1px solid var(--border); border-radius: var(--radius); font-size:1rem; transition:.2s; background: var(--bg-card); color: var(--text); }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91,123,122,.1); }
    .form-help { font-size: .85rem; color: var(--text-light); margin-top: var(--space-xs); }
    .table-ui{ width:100%; border-collapse:collapse; margin: var(--space-md) 0; background: var(--bg-card); border-radius: var(--radius); overflow:hidden; border:1px solid var(--border); }
    .table-ui th{ background: rgba(91,123,122,.05); color: var(--text); padding:16px; text-align:left; font-weight:600; font-size:.9rem; }
    .table-ui td{ padding:16px; border-bottom:1px solid var(--border-light); }
    .table-ui input, .table-ui select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); }
    .btn-primary{ background: var(--primary); color:#fff; border:none; border-radius: var(--radius); padding:16px 24px; font-size:1rem; font-weight:500; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:10px; margin-top: var(--space-sm); }
    .btn-primary:hover{ background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary{ background:transparent; color: var(--primary); border:2px solid var(--primary); border-radius: var(--radius); padding:14px 22px; font-size:1rem; font-weight:500; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:10px; }
    .btn-secondary:hover{ background: var(--primary); color:#fff; }
    .btn-small{ padding:10px 14px; font-size:.9rem; border-radius:10px; }
    .form-navigation{ display:flex; justify-content:space-between; margin-top: var(--space-xl); padding-top: var(--space-md); border-top:1px solid var(--border-light); }
    .result-section{ display:none; animation: fadeIn .5s ease; }
    .result-section.active{ display:block; }
    .result-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom: var(--space-lg); }
    .result-item{ text-align:center; padding:24px 16px; background: rgba(91,123,122,.03); border-radius: var(--radius); border:1px solid var(--border-light); }
    .result-item .label{ font-size:.85rem; color: var(--text-light); margin-bottom:8px; font-weight:500;}
    .result-item .value{ font-size:1.2rem; font-weight:700; color: var(--primary); }
    .result-total{ text-align:center; padding:32px; background: rgba(91,123,122,.05); border-radius: var(--radius); margin-top:24px; border:1px solid var(--border-light); }
    .result-total .label{ font-size:1rem; margin-bottom:12px; color: var(--text); font-weight:500;}
    .result-total .value{ font-size:2rem; font-weight:700; color: var(--primary); }
    #save-btn,#pdf-btn{ position:fixed; right:24px; z-index:100; background: var(--primary); color:#fff; border:none; border-radius:50px; padding:14px 20px; font-weight:500; box-shadow: var(--shadow-md); display:none; cursor:pointer; transition:.2s; align-items:center; gap:8px; font-size:.9rem; }
    #save-btn:hover,#pdf-btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    #save-btn{ bottom:100px; }
    #pdf-btn{ bottom:170px; background: var(--secondary); }
    .loading-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,.9); display:none; justify-content:center; align-items:center; z-index:2000; flex-direction:column; gap: var(--space-md); }
    .loading-spinner{ width:48px; height:48px; border:4px solid var(--border); border-left:4px solid var(--primary); border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
    @media (max-width:768px){
      .app-container{ padding:0 var(--space-sm); }
      .card{ padding: var(--space-md); margin: var(--space-md) 0; }
      .form-grid,.characteristics-grid,.result-grid{ grid-template-columns:1fr; }
      .form-steps{ flex-direction:column; gap: var(--space-md); }
      .form-steps::before{ display:none; }
      .step{ flex-direction:row; gap: var(--space-sm); }
      .step-label{ text-align:left; }
      #save-btn,#pdf-btn{ right:16px; bottom:80px; }
      #pdf-btn{ bottom:140px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1><i class="fas fa-home"></i> Sistema de Avalúos</h1>
    </header>

    <div class="form-steps">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-label">Información general</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-label">Características</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-label">Cálculos</div>
      </div>
      <div class="step" data-step="4">
        <div class="step-number">4</div>
        <div class="step-label">Resultados</div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fas fa-edit"></i> Datos de la propiedad</h2>

      <!-- Paso 1 -->
      <div class="form-section active" data-step="1">
        <div class="form-section-title"><i class="fas fa-info-circle"></i> Información general</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="required">Nombre del asociado</label>
            <input id="associate-name" type="text" required />
          </div>
          <div class="form-group">
            <label class="required">Dirección</label>
            <input id="address" type="text" required />
          </div>
          <div class="form-group">
            <label>Área construida (m²)</label>
            <input id="construction-area" type="number" min="0" step="0.01" />
          </div>
          <div class="form-group">
            <label>Área terreno (m²)</label>
            <input id="land-area" type="number" min="0" step="0.01" />
          </div>
        </div>
      </div>

      <!-- Paso 2 -->
      <div class="form-section" data-step="2">
        <div class="form-section-title"><i class="fas fa-file-contract"></i> Datos registrales</div>
        <div class="form-grid">
          <div class="form-group"><label>Propietario</label><input id="owner-name" type="text" /></div>
          <div class="form-group"><label>Número de escritura</label><input id="deed-number" type="text" /></div>
          <div class="form-group"><label>Fecha de escritura</label><input id="deed-date" type="date" /></div>
          <div class="form-group"><label>Notario</label><input id="notary" type="text" /></div>
        </div>

        <div class="form-section-title"><i class="fas fa-map-marker-alt"></i> Colindancias</div>
        <table class="table-ui">
          <thead><tr><th>Dirección</th><th>Propietario</th><th>Metros</th></tr></thead>
          <tbody>
            <tr><td><strong>Norte</strong></td><td><input id="norte-propietario" type="text" /></td><td><input id="norte-metros" type="number" step="0.01" /></td></tr>
            <tr><td><strong>Sur</strong></td><td><input id="sur-propietario" type="text" /></td><td><input id="sur-metros" type="number" step="0.01" /></td></tr>
            <tr><td><strong>Oriente</strong></td><td><input id="oriente-propietario" type="text" /></td><td><input id="oriente-metros" type="number" step="0.01" /></td></tr>
            <tr><td><strong>Poniente</strong></td><td><input id="poniente-propietario" type="text" /></td><td><input id="poniente-metros" type="number" step="0.01" /></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Paso 3: Cálculos -->
      <div class="form-section" data-step="3">

        <!-- 1. Terreno -->
        <div class="form-section-title"><i class="fas fa-mountain"></i> Cálculo del valor del terreno</div>
        <table class="table-ui" id="tablaTerreno">
          <thead>
            <tr>
              <th style="width:140px">V/Base (Q/m²)</th>
              <th style="width:120px">Frente</th>
              <th style="width:120px">Fondo</th>
              <th style="width:140px">Área m²</th>
              <th style="width:120px">Fac. Fte.</th>
              <th style="width:120px">Fac. Fdo.</th>
              <th style="width:120px">Fac. Fma.</th>
              <th style="width:120px">Fac. Ext.</th>
              <th style="width:140px">Otros Fac.</th>
              <th style="width:160px">MONTO</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="number" min="0" step="0.01" class="t-vbase" placeholder="1500"></td>
              <td><input type="number" min="0" step="0.01" class="t-frente" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-fondo" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-area" id="t-area" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffte" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffdo" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffma" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-fext" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-fotros" placeholder="1" value="1"></td>
              <td><input type="text" class="t-monto" id="t-monto" value="0.00" readonly></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="9" style="text-align:right; font-weight:600;">TOTAL TERRENO</td>
              <td><input type="text" id="totalTerreno" value="0.00" readonly></td>
            </tr>
          </tfoot>
        </table>

        <!-- 2. Construcción -->
        <div class="form-section-title"><i class="fas fa-building-user"></i> Cálculo del valor de la construcción</div>
        <table class="table-ui" id="tablaConstruccion">
          <thead>
            <tr>
              <th style="width:160px">Planta</th>
              <th style="width:140px">Área m²</th>
              <th style="width:140px">V/Base</th>
              <th style="width:120px">%</th>
              <th>Tipo de Construcción</th>
              <th style="width:160px">MONTO</th>
            </tr>
          </thead>
          <tbody id="tbBodyConstruccion">
            <tr>
              <td><input type="text" value="Primer Nivel" class="planta-input"></td>
              <td><input type="number" min="0" step="0.01" class="area-input" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="vbase-input" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" value="1" class="coef-input"></td>
              <td><input type="text" class="tipo-input" placeholder="Ej.: Block y Concreto"></td>
              <td><input type="text" class="monto-output" value="0.00" readonly></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align:right; font-weight:600;">TOTAL</td>
              <td><input type="text" id="totalConstruccion" value="0.00" readonly></td>
            </tr>
          </tfoot>
        </table>

        <div style="display:flex; gap:12px; margin-top:8px;">
          <button class="btn-secondary btn-small" type="button" onclick="agregarFilaConstruccion()">
            <i class="fas fa-plus"></i> Agregar nivel
          </button>
          <button class="btn-secondary btn-small" type="button" onclick="eliminarUltimaFilaConstruccion()">
            <i class="fas fa-minus"></i> Quitar último nivel
          </button>
        </div>

        <div class="form-help" style="margin-top:8px;">
          El MONTO se calcula como: <strong>Área m² × V/Base × %</strong>.
        </div>

        <!-- 3. Integración -->
        <div class="form-section-title"><i class="fas fa-layer-group"></i> Integración de valores</div>
        <div class="result-grid" id="integracionValores">
          <div class="result-item">
            <div class="label">Valor del Terreno</div>
            <div class="value" id="ivTerreno">Q0.00</div>
          </div>
          <div class="result-item">
            <div class="label">Valor Construcciones</div>
            <div class="value" id="ivConstruccion">Q0.00</div>
          </div>
          <div class="result-item">
            <div class="label">Total Avalúo</div>
            <div class="value" id="ivTotal">Q0.00</div>
          </div>
        </div>
      </div>

      <!-- Paso 4 -->
      <div class="form-navigation">
        <button class="btn-secondary" id="prev-step"><i class="fas fa-arrow-left"></i> Anterior</button>
        <button class="btn-primary" id="next-step">Siguiente <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Resultados -->
    <div class="result-section" id="resultSection">
      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> Valor final del inmueble</h2>
        <div class="result-grid">
          <div class="result-item"><div class="label">Área Construida</div><div class="value" id="resultArea">0 m²</div></div>
          <div class="result-item"><div class="label">Tipología</div><div class="value" id="resultTypology">-</div></div>
          <div class="result-item"><div class="label">Estado</div><div class="value" id="resultCondition">-</div></div>
          <div class="result-item"><div class="label">Antigüedad</div><div class="value" id="resultAge">0 años</div></div>
          <div class="result-item"><div class="label">Valor Terreno</div><div class="value" id="resultLandValue">Q0.00</div></div>
          <div class="result-item"><div class="label">Valor Construcción</div><div class="value" id="resultBuildValue">Q0.00</div></div>
          <div class="result-item"><div class="label">TOTAL Terreno + Construcción</div><div class="value" id="resultGrandTotal">Q0.00</div></div>
        </div>
        <div class="result-total"><div class="label">VALOR TOTAL ESTIMADO</div><div class="value" id="resultTotal">Q0.00</div></div>
        <div style="display:flex; gap:12px; margin-top:24px;">
          <button class="btn-primary" onclick="generateReport()" style="flex:1;"><i class="fas fa-file-pdf"></i> Generar PDF</button>
          <button class="btn-secondary" onclick="newAppraisal()" style="flex:1;"><i class="fas fa-redo"></i> Nuevo Avalúo</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div style="color: var(--primary); font-weight: 500;">Generando PDF...</div>
  </div>

  <button id="save-btn" type="button"><i class="fas fa-save"></i> Guardar</button>
  <button id="pdf-btn" type="button"><i class="fas fa-file-pdf"></i> PDF</button>

  <script>
    function formatMoneyGTQ(v){
      return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ',minimumFractionDigits:2}).format(Number(v||0));
    }

    // Construcción: Área × V/Base × %
    function recalcularFila(tr){
      const area = parseFloat(tr.querySelector('.area-input')?.value)||0;
      const vbase = parseFloat(tr.querySelector('.vbase-input')?.value)||0;
      const coef = parseFloat(tr.querySelector('.coef-input')?.value)||0;
      const monto = area * vbase * coef;
      const out = tr.querySelector('.monto-output');
      if(out){ out.value = monto.toFixed(2); }
      return monto;
    }

    function recalcularTablaConstruccion(){
      const rows = Array.from(document.querySelectorAll('#tbBodyConstruccion tr'));
      let total = 0, sumaArea = 0;
      rows.forEach(tr=>{
        total += recalcularFila(tr);
        const area = parseFloat(tr.querySelector('.area-input')?.value)||0;
        sumaArea += area;
      });
      const totalEl = document.getElementById('totalConstruccion');
      if(totalEl) totalEl.value = total.toFixed(2);

      const fallbackArea = parseFloat(document.getElementById('construction-area').value)||0;
      const areaMostrar = (sumaArea>0? sumaArea : fallbackArea).toFixed(2);
      const areaEl = document.getElementById('resultArea'); if(areaEl) areaEl.textContent = `${areaMostrar} m²`;

      const buildEl = document.getElementById('resultBuildValue'); if(buildEl) buildEl.textContent = formatMoneyGTQ(total);
      integrarValores();
    }

    function bindRowEvents(tr){
      ['input','change'].forEach(evt=>{
        tr.addEventListener(evt, e=>{
          if(e.target.matches('.area-input,.vbase-input,.coef-input')){
            recalcularTablaConstruccion();
          }
        });
      });
    }

    function agregarFilaConstruccion(){
      const tbody = document.getElementById('tbBodyConstruccion');
      const n = tbody.querySelectorAll('tr').length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="Nivel ${n}" class="planta-input"></td>
        <td><input type="number" min="0" step="0.01" class="area-input" placeholder="0"></td>
        <td><input type="number" min="0" step="0.01" class="vbase-input" placeholder="0"></td>
        <td><input type="number" min="0" step="0.01" value="1" class="coef-input"></td>
        <td><input type="text" class="tipo-input" placeholder="Ej.: Block y Concreto"></td>
        <td><input type="text" class="monto-output" value="0.00" readonly></td>
      `;
      tbody.appendChild(tr);
      bindRowEvents(tr);
      recalcularTablaConstruccion();
    }

    function eliminarUltimaFilaConstruccion(){
      const tbody = document.getElementById('tbBodyConstruccion');
      const rows = tbody.querySelectorAll('tr');
      if(rows.length>1){
        tbody.removeChild(rows[rows.length-1]);
        recalcularTablaConstruccion();
      }
    }

    // Terreno: Área × V/Base × FacFte × FacFdo × FacFma × FacExt × Otros
    function recalcularTerreno() {
      const row = document.querySelector('#tablaTerreno tbody tr');
      if (!row) return 0;
      const num = (sel) => parseFloat(row.querySelector(sel)?.value) || 0;
      const fac = (sel) => {
        const v = parseFloat(row.querySelector(sel)?.value);
        return isNaN(v) || v <= 0 ? 1 : v;
      };

      let area = num('.t-area');
      const frente = num('.t-frente');
      const fondo = num('.t-fondo');
      if (area <= 0 && frente > 0 && fondo > 0) {
        area = frente * fondo;
        const tAreaEl = row.querySelector('.t-area');
        if (tAreaEl) tAreaEl.value = area.toFixed(2);
      }

      const vbase = num('.t-vbase');
      const ffte  = fac('.t-ffte');
      const ffdo  = fac('.t-ffdo');
      const ffma  = fac('.t-ffma');
      const fext  = fac('.t-fext');
      const fotros= fac('.t-fotros');

      const monto = area * vbase * ffte * ffdo * ffma * fext * fotros;

      const out = document.getElementById('t-monto'); if (out) out.value = monto.toFixed(2);
      const totalTerrenoEl = document.getElementById('totalTerreno'); if (totalTerrenoEl) totalTerrenoEl.value = monto.toFixed(2);
      const ivTerrenoEl = document.getElementById('ivTerreno'); if (ivTerrenoEl) ivTerrenoEl.textContent = formatMoneyGTQ(monto);

      const resultLand = document.getElementById('resultLandValue'); if (resultLand) resultLand.textContent = formatMoneyGTQ(monto);
      integrarValores();
      return monto;
    }

    function integrarValores() {
      const terreno = parseFloat(document.getElementById('totalTerreno')?.value) || 0;
      const construccion = parseFloat(document.getElementById('totalConstruccion')?.value) || 0;
      const total = terreno + construccion;

      const ivT = document.getElementById('ivTerreno');
      const ivC = document.getElementById('ivConstruccion');
      const ivTot = document.getElementById('ivTotal');
      if (ivT) ivT.textContent = formatMoneyGTQ(terreno);
      if (ivC) ivC.textContent = formatMoneyGTQ(construccion);
      if (ivTot) ivTot.textContent = formatMoneyGTQ(total);

      const rg = document.getElementById('resultGrandTotal'); if (rg) rg.textContent = formatMoneyGTQ(total);
      const rt = document.getElementById('resultTotal'); if (rt) rt.textContent = formatMoneyGTQ(total);
    }

    function calculateRealAppraisal(){
      recalcularTerreno();
      recalcularTablaConstruccion();
      integrarValores();

      const estado = document.getElementById('estado-inmueble')?.value || 'No especificado';
      const anioConstruccion = parseInt(document.getElementById('anio-construccion')?.value)||0;
      const antiguedad = anioConstruccion? (new Date().getFullYear()-anioConstruccion) : 0;
      const rc = document.getElementById('resultCondition'); if(rc) rc.textContent = estado;
      const ra = document.getElementById('resultAge'); if(ra) ra.textContent = `${antiguedad} años`;
      const rt = document.getElementById('resultTypology'); if(rt) rt.textContent = '—';
    }

    async function generateReport(){
      const overlay=document.getElementById('loadingOverlay'); overlay.style.display='flex';
      try{
        const { jsPDF }=window.jspdf || await (await fetch('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')).text() && window.jspdf;
        const doc=new jsPDF(); const pageWidth=doc.internal.pageSize.getWidth(); const margin=20; const contentWidth=pageWidth-(margin*2);
        doc.setFillColor(91,123,122); doc.rect(0,0,pageWidth,60,'F');
        doc.setTextColor(255,255,255); doc.setFontSize(20); doc.setFont('helvetica','bold'); doc.text('REPORTE DE AVALÚO',margin,30);
        doc.setFontSize(10); doc.setFont('helvetica','normal'); doc.text(`Generado: ${new Date().toLocaleDateString('es-GT')}`,margin,45); doc.text('Sistema de Avalúos Profesional', pageWidth - margin - 80, 45);
        let y=80;

        doc.setFillColor(240,240,240); doc.rect(margin,y-10,contentWidth,15,'F'); doc.setTextColor(91,123,122); doc.setFontSize(14); doc.setFont('helvetica','bold'); doc.text('INFORMACIÓN DE LA PROPIEDAD',margin,y); y+=20;
        const basicData=[
          ['Asociado:',document.getElementById('associate-name').value||'No especificado'],
          ['Dirección:',document.getElementById('address').value||'No especificado'],
          ['Área Construida:',document.getElementById('resultArea').textContent||'No especificado'],
          ['Área Terreno:',document.getElementById('land-area').value?document.getElementById('land-area').value+' m²':'No especificado']
        ];
        doc.setTextColor(0,0,0); doc.setFontSize(10); doc.setFont('helvetica','normal');
        basicData.forEach(([l,v])=>{doc.setFont('helvetica','bold'); doc.text(l,margin,y); doc.setFont('helvetica','normal'); doc.text(v,margin+45,y); y+=8;}); y+=10;

        doc.setFillColor(240,240,240); doc.rect(margin,y-10,contentWidth,15,'F'); doc.setTextColor(91,123,122); doc.setFontSize(14); doc.setFont('helvetica','bold'); doc.text('RESULTADOS DEL AVALÚO',margin,y); y+=20;
        const resultsData=[
          ['Valor Terreno',document.getElementById('resultLandValue').textContent],
          ['Valor Construcción',document.getElementById('resultBuildValue').textContent],
          ['TOTAL',document.getElementById('resultTotal').textContent]
        ];
        doc.autoTable({startY:y, head:[['Concepto','Valor']], body:resultsData, theme:'grid', headStyles:{fillColor:[91,123,122], textColor:255, fontStyle:'bold'}, styles:{fontSize:10, cellPadding:5}, columnStyles:{0:{fontStyle:'bold', cellWidth:100},1:{cellWidth:80}}, margin:{left:margin,right:margin}});
        y=doc.lastAutoTable.finalY+15;

        doc.setFillColor(91,123,122); doc.rect(margin,y,contentWidth,25,'F'); doc.setTextColor(255,255,255); doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.text('VALOR TOTAL ESTIMADO',margin+10,y+15); doc.setFontSize(20); doc.text(document.getElementById('resultTotal').textContent, pageWidth - margin - 80, y+15);

        const totalPages=doc.internal.getNumberOfPages();
        for(let i=1;i<=totalPages;i++){ doc.setPage(i); doc.setFontSize(8); doc.setTextColor(128,128,128); doc.text(`Página ${i} de ${totalPages} - Sistema de Avalúos`, pageWidth/2, doc.internal.pageSize.getHeight()-10, {align:'center'}); }
        const fileName=`Avaluo_${document.getElementById('associate-name').value||'Propiedad'}_${new Date().toISOString().slice(0,10)}.pdf`;
        doc.save(fileName);
      }catch(error){
        alert('Error al generar el PDF: '+(error?.message || error));
      }finally{ overlay.style.display='none'; }
    }

    class FormWizard{
      constructor(){this.currentStep=1; this.totalSteps=4; this.init();}
      init(){this.bindEvents(); this.updateUI();}
      bindEvents(){
        document.getElementById('next-step').addEventListener('click',()=>this.next());
        document.getElementById('prev-step').addEventListener('click',()=>this.previous());
        document.querySelectorAll('.step').forEach(step=>{
          step.addEventListener('click',(e)=>{
            const n=parseInt(e.currentTarget.dataset.step);
            if(n<this.currentStep){this.goToStep(n);}
          });
        });
        // Bind terreno changes
        const row = document.querySelector('#tablaTerreno tbody tr');
        if (row) {
          row.querySelectorAll('input').forEach(inp => {
            ['input','change'].forEach(evt => {
              inp.addEventListener(evt, () => { recalcularTerreno(); integrarValores(); });
            });
          });
        }
        // Bind construcción first row
        const firstRow = document.querySelector('#tbBodyConstruccion tr');
        if(firstRow) bindRowEvents(firstRow);
      }
      validateStep(step){
        const req=document.querySelectorAll(`[data-step="${step}"] [required]`);
        let ok=true; req.forEach(f=>{if(!f.value.trim()){f.style.borderColor='var(--error)'; ok=false;} else{f.style.borderColor='';}});
        if(!ok){alert('Completa los campos requeridos marcados con *');}
        return ok;
      }
      next(){ if(this.currentStep<this.totalSteps){ if(this.validateStep(this.currentStep)){ this.currentStep++; this.updateUI(); } } else { this.calculateAppraisal(); } }
      previous(){ if(this.currentStep>1){ this.currentStep--; this.updateUI(); } }
      goToStep(step){ if(step>=1&&step<=this.totalSteps){ this.currentStep=step; this.updateUI(); } }
      updateUI(){
        document.querySelectorAll('.step').forEach(s=>{
          const n=parseInt(s.dataset.step);
          s.classList.remove('active','completed');
          if(n===this.currentStep){s.classList.add('active');}
          else if(n<this.currentStep){s.classList.add('completed');}
        });
        document.querySelectorAll('.form-section').forEach(sec=>{
          sec.classList.remove('active'); if(parseInt(sec.dataset.step)===this.currentStep){sec.classList.add('active');}
        });
        const prevBtn=document.getElementById('prev-step');
        const nextBtn=document.getElementById('next-step');
        prevBtn.style.display=this.currentStep>1?'flex':'none';
        nextBtn.innerHTML=this.currentStep===this.totalSteps?'<i class="fas fa-calculator"></i> Calcular Avalúo':'Siguiente <i class="fas fa-arrow-right"></i>';
      }
      calculateAppraisal(){
        if(this.validateStep(this.currentStep)){
          const nextBtn=document.getElementById('next-step');
          const original=nextBtn.innerHTML;
          nextBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Calculando...'; nextBtn.disabled=true;
          setTimeout(()=>{
            calculateRealAppraisal();
            document.getElementById('resultSection').classList.add('active');
            document.getElementById('save-btn').style.display='flex';
            document.getElementById('pdf-btn').style.display='flex';
            nextBtn.innerHTML=original; nextBtn.disabled=false;
          },600);
        }
      }
    }
    function newAppraisal(){
      document.getElementById('resultSection').classList.remove('active');
      document.getElementById('save-btn').style.display='none';
      document.getElementById('pdf-btn').style.display='none';
      window.formWizard.goToStep(1);
    }
    document.addEventListener('DOMContentLoaded',function(){
      window.formWizard=new FormWizard();
      document.getElementById('save-btn').addEventListener('click',function(){ alert('Datos guardados'); });
      document.getElementById('pdf-btn').addEventListener('click',function(){ generateReport(); });
    });
  </script>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#5B7B7A" />
  <title>Sistema de Avalúos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --primary: #5B7B7A;
      --primary-light: #8AA6A5;
      --primary-dark: #3A5958;
      --secondary: #A6B5A5;
      --accent: #8C9B9A;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --text: #2D3748;
      --text-light: #718096;
      --text-lighter: #A0AEC0;
      --bg: #F9FAFB;
      --bg-card: #FFFFFF;
      --bg-hover: #F8FAFC;
      --border: #E2E8F0;
      --border-light: #F1F5F9;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.02), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.03), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --space-xs: 8px;
      --space-sm: 16px;
      --space-md: 24px;
      --space-lg: 32px;
      --space-xl: 48px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }

    body { background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }

    .app-container { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-md); }

    .app-header {
      background: var(--bg-card);
      padding: var(--space-md) 0;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      margin-bottom: var(--space-lg);
    }
    .app-header h1 { font-size: 1.75rem; font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); color: var(--primary); }
    .app-header h1 i { background: rgba(91,123,122,.1); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }

    
    .app-header h1 img {
        background: transparent !important;
    }

    .floating-actions {
      position: fixed;
      top: 100px;
      right: 24px;
      z-index: 99;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .floating-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }
    .floating-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .floating-btn:active {
      transform: translateY(0);
    }
    @media (max-width: 768px){
      .floating-actions {
        top: 90px;
        right: 16px;
      }
      .floating-btn {
        width: 50px;
        height: 50px;
        font-size: 1.1rem;
      }
    }

    .form-steps { display: flex; justify-content: space-between; margin-bottom: var(--space-xl); position: relative; padding: 0 var(--space-md); }
    .form-steps::before { content: ''; position: absolute; top: 24px; left: var(--space-md); right: var(--space-md); height: 2px; background: var(--border); z-index: 1; }
    .step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; cursor: pointer; transition: .3s; flex: 1; }
    .step-number { width: 48px; height: 48px; border-radius: 50%; background: var(--bg); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: var(--space-xs); transition: .3s; }
    .step-label { font-size: .875rem; font-weight: 500; color: var(--text-light); text-align: center; transition: .3s; }
    .step.active .step-number { background: var(--primary); border-color: var(--primary); color:#fff; }
    .step.active .step-label { color: var(--primary); font-weight: 600; }
    .step.completed .step-number { background: var(--success); border-color: var(--success); color:#fff; }

    .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--space-xl); margin: var(--space-lg) 0; box-shadow: var(--shadow); border: 1px solid var(--border); transition: .3s; }
    .card:hover { box-shadow: var(--shadow-lg); }
    .card h2 { font-size: 1.5rem; color: var(--text); margin-bottom: var(--space-lg); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); }
    .card h2 i { background: rgba(91,123,122,.1); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }

    .form-section { margin-bottom: var(--space-xl); display: none; animation: fadeIn .5s ease; }
    .form-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to{ opacity:1; transform:translateY(0);} }
    .form-section-title { font-size: 1.25rem; color: var(--text); margin-bottom: var(--space-md); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border-light); }
    .form-section-title i { background: rgba(91,123,122,.1); width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: var(--space-md); }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: .9rem; font-weight: 500; color: var(--text); margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs); }
    .required::after { content:'*'; color: var(--error); margin-left: 4px; }
    .form-group input,.form-group select,.form-group textarea { padding: 14px 16px; border:1px solid var(--border); border-radius: var(--radius); font-size:1rem; transition:.2s; background: var(--bg-card); color: var(--text); }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91,123,122,.1); }
    .form-help { font-size: .85rem; color: var(--text-light); margin-top: var(--space-xs); }

    .typology-selector{ margin-top: var(--space-md); }
    .typology-trigger{ background: var(--bg-card); border:1px solid var(--border); border-radius: var(--radius); padding:20px; cursor:pointer; display:flex; align-items:center; gap:var(--space-sm); transition:.2s; }
    .typology-trigger:hover{ border-color: var(--primary); background: var(--bg-hover); }
    .typology-trigger:after{ content:"▼"; font-size:.8rem; margin-left:auto; transition: transform .3s; color: var(--primary); }
    .typology-trigger.active:after{ transform: rotate(180deg); }
    .selected-image{ width:60px; height:60px; border-radius: var(--radius); object-fit: cover; flex-shrink: 0; }
    .selected-text{ display:flex; flex-direction:column; flex:1; }
    .selected-type{ font-weight: 600; color: var(--primary); font-size:1rem; margin-bottom:4px; }
    .selected-title{ font-weight: 500; color: var(--text); font-size:.9rem; }
    .selected-price{ font-size:.85rem; color: var(--text-light); margin-top:4px; }

    #norte-propietario,#sur-propietario,#oriente-propietario,#poniente-propietario,
    #norte-metros,#sur-metros,#oriente-metros,#poniente-metros{
      background: var(--bg-card)!important; border:1px solid var(--border)!important; color: var(--text)!important;
    }

    .table-ui{ width:100%; border-collapse:collapse; margin: var(--space-md) 0; background: var(--bg-card); border-radius: var(--radius); overflow:hidden; border:1px solid var(--border); }
    .table-ui th{ background: rgba(91,123,122,.05); color: var(--text); padding:16px; text-align:left; font-weight:600; font-size:.9rem; }
    .table-ui td{ padding:16px; border-bottom:1px solid var(--border-light); }
    .table-ui input, .table-ui select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); }

    .form-section-title + .form-grid + .form-section-title{ margin-top: var(--space-lg); }

    .btn-primary{ background: var(--primary); color:#fff; border:none; border-radius: var(--radius); padding:16px 24px; font-size:1rem; font-weight:500; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:10px; margin-top: var(--space-sm); }
    .btn-primary:hover{ background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary{ background:transparent; color: var(--primary); border:2px solid var(--primary); border-radius: var(--radius); padding:14px 22px; font-size:1rem; font-weight:500; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; gap:10px; }
    .btn-secondary:hover{ background: var(--primary); color:#fff; }

    .btn-small{ padding:10px 14px; font-size:.9rem; border-radius:10px; }

    .form-navigation{ display:flex; justify-content:space-between; margin-top: var(--space-xl); padding-top: var(--space-md); border-top:1px solid var(--border-light); }

    .result-section{ display:none; animation: fadeIn .5s ease; }
    .result-section.active{ display:block; }
    .result-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom: var(--space-lg); }
    .result-item{ text-align:center; padding:24px 16px; background: rgba(91,123,122,.03); border-radius: var(--radius); border:1px solid var(--border-light); }
    .result-item .label{ font-size:.85rem; color: var(--text-light); margin-bottom:8px; font-weight:500;}
    .result-item .value{ font-size:1.2rem; font-weight:700; color: var(--primary); }
    .result-total{ text-align:center; padding:32px; background: rgba(91,123,122,.05); border-radius: var(--radius); margin-top:24px; border:1px solid var(--border-light); }
    .result-total .label{ font-size:1rem; margin-bottom:12px; color: var(--text); font-weight:500;}
    .result-total .value{ font-size:2rem; font-weight:700; color: var(--primary); }

    .catalog-modal{ position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; z-index:1000; padding:20px; }
    .catalog-modal.active{ display:flex; }
    .modal-content{ background: var(--bg-card); border-radius: var(--radius-lg); width:100%; max-width:600px; max-height:80vh; overflow-y:auto; padding:0; }
    .modal-header{ padding:24px; border-bottom:1px solid var(--border-light); position:sticky; top:0; background: var(--bg-card); border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    .modal-header h3{ color: var(--text); font-size:1.3rem; display:flex; align-items:center; gap:12px; font-weight:600; }
    .modal-close{ position:absolute; top:24px; right:24px; background:none; border:none; font-size:1.2rem; cursor:pointer; color: var(--text-light); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:.2s; }
    .modal-close:hover{ background: var(--border-light); }

    .catalog-item-modal{ padding:20px; border-bottom:1px solid var(--border-light); cursor:pointer; transition:.2s; }
    .catalog-item-modal:last-child{ border-bottom:none; }
    .catalog-item-modal:hover{ background: rgba(91,123,122,.03); }
    .catalog-item-content{ display:flex; gap:16px; align-items:flex-start; }
    .catalog-image-modal{ width:80px; height:80px; border-radius: var(--radius); object-fit:cover; flex-shrink:0; }
    .catalog-text-modal{ flex:1; }
    .catalog-type-modal{ font-weight:600; color: var(--primary); font-size:1.1rem; margin-bottom:4px; }
    .catalog-title-modal{ font-weight:500; color: var(--text); font-size:1rem; margin-bottom:4px; }
    .catalog-price-modal{ font-size:1rem; font-weight:600; color: var(--text); margin-bottom:8px; }
    .catalog-description-modal{ font-size:.9rem; color: var(--text-light); line-height:1.5; margin-bottom:12px; }
    .catalog-features-modal{ list-style:none; }
    .catalog-features-modal li{ padding:4px 0; display:flex; align-items:center; gap:8px; font-size:.85rem; color: var(--text); }
    .catalog-features-modal li i{ color: var(--primary); font-size:.8rem; }

    .select-button{ background: var(--primary); color:#fff; border:none; border-radius: var(--radius); padding:12px 20px; font-weight:500; cursor:pointer; margin-top:12px; width:100%; transition:.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
    .select-button:hover{ background: var(--primary-dark); }

    #save-btn,#pdf-btn{ position:fixed; right:24px; z-index:100; background: var(--primary); color:#fff; border:none; border-radius:50px; padding:14px 20px; font-weight:500; box-shadow: var(--shadow-md); display:none; cursor:pointer; transition:.2s; align-items:center; gap:8px; font-size:.9rem; }
    #save-btn:hover,#pdf-btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    #save-btn{ bottom:100px; }
    #pdf-btn{ bottom:170px; background: var(--secondary); }

    .loading-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,.9); display:none; justify-content:center; align-items:center; z-index:2000; flex-direction:column; gap: var(--space-md); }
    .loading-spinner{ width:48px; height:48px; border:4px solid var(--border); border-left:4px solid var(--primary); border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }

    .auth-overlay{ position:fixed; inset:0; background: rgba(0,0,0,.45); display:none; z-index:1500; align-items:center; justify-content:center; padding:24px; }
    .auth-panel{ width:100%; max-width:880px; }
    .auth-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
    .auth-col{ border:1px solid var(--border); border-radius: var(--radius); padding:12px; background:#fff; }
    .auth-col-title{ font-weight:600; margin-bottom:8px; }
    .auth-input{ width:100%; margin-bottom:8px; padding:10px; border:1px solid var(--border); border-radius:8px; }
    .auth-close{ position:absolute; top:18px; right:18px; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer; }
    
    @media (max-width:768px){
      .app-container{ padding:0 var(--space-sm); }
      .card{ padding: var(--space-md); margin: var(--space-md) 0; }
      .form-grid,.characteristics-grid,.result-grid{ grid-template-columns:1fr; }
      .form-steps{ flex-direction:column; gap: var(--space-md); }
      .form-steps::before{ display:none; }
      .step{ flex-direction:row; gap: var(--space-sm); }
      .step-label{ text-align:left; }
      #save-btn,#pdf-btn{ right:16px; bottom:80px; }
      #pdf-btn{ bottom:140px; }
    }

    #username-modal .modal-content {
      max-width: 400px;
    }
    #username-modal .form-group {
      margin-bottom: 0;
    }

    .appraisal-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .appraisal-item:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    .appraisal-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 8px;
    }

    .appraisal-date {
      font-weight: 600;
      color: var(--primary);
    }

    .appraisal-actions {
      display: flex;
      gap: 8px;
    }

    .appraisal-details {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .appraisal-details div {
      margin-bottom: 4px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    
    #user-box {
      display: none;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      margin-top: 16px;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    #user-box[style*="display: flex"] {
      margin-top: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      #user-box {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      #user-box .btn-secondary {
        width: 100%;
        justify-content: center;
      }
    }

    
    @media (max-width: 768px){
      .catalog-modal .modal-content {
        max-width: 95vw;
        max-height: 90vh;
        margin: 20px 10px;
      }
      
      .catalog-item-content {
        flex-direction: column;
        text-align: center;
      }
      
      .catalog-image-modal {
        width: 100%;
        height: 150px;
        margin-bottom: 12px;
      }
      
      .catalog-text-modal {
        width: 100%;
      }
      
      .catalog-features-modal {
        text-align: left;
        max-height: 120px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 0 10px;
      }

      .table-ui {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 0.8rem;
      }
      
      .table-ui th,
      .table-ui td {
        padding: 12px 8px;
        min-width: 80px;
      }
      
      #tablaTerreno th,
      #tablaTerreno td {
        min-width: 70px;
        font-size: 0.75rem;
      }
      
      #tablaTerreno th:nth-child(1),
      #tablaTerreno td:nth-child(1) {
        min-width: 100px;
      }
      
      #tablaTerreno th:nth-child(9),
      #tablaTerreno td:nth-child(9),
      #tablaTerreno th:nth-child(10),
      #tablaTerreno td:nth-child(10) {
        min-width: 90px;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: var(--space-sm);
      }
      
      .characteristics-grid {
        grid-template-columns: 1fr;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px;
        font-size: 16px;
      }
      
      .card {
        padding: var(--space-md);
        margin: var(--space-sm) 0;
      }
      
      .card h2 {
        font-size: 1.3rem;
        margin-bottom: var(--space-md);
      }

      .form-navigation {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-navigation button {
        width: 100%;
        padding: 14px 20px;
      }
      
      .floating-actions {
        top: 80px;
        right: 12px;
      }
      
      .floating-btn {
        width: 48px;
        height: 48px;
        font-size: 1rem;
      }
      
      #save-btn, #pdf-btn {
        right: 12px;
        bottom: 70px;
        padding: 12px 16px;
        font-size: 0.8rem;
      }
      
      #pdf-btn {
        bottom: 130px;
      }

      .result-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .result-item {
        padding: 16px 12px;
      }
      
      .result-total {
        padding: 24px 16px;
      }
      
      .result-total .value {
        font-size: 1.5rem;
      }
      
      .appraisal-item {
        padding: 12px;
      }
      
      .appraisal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .appraisal-actions {
        width: 100%;
        justify-content: space-between;
      }

      .typology-trigger {
        padding: 16px;
      }
      
      .selected-image {
        width: 50px;
        height: 50px;
      }
      
      .selected-text {
        min-width: 0;
      }
      
      .selected-type {
        font-size: 0.9rem;
      }
      
      .selected-title {
        font-size: 0.8rem;
      }
      
      .selected-price {
        font-size: 0.75rem;
      }

      .auth-grid {
        grid-template-columns: 1fr;
      }
      
      .auth-panel {
        margin: 10px;
      }
      
      .auth-overlay {
        padding: 10px;
      }

      .form-steps {
        flex-direction: column;
        gap: var(--space-sm);
        padding: 0;
      }
      
      .form-steps::before {
        display: none;
      }
      
      .step {
        flex-direction: row;
        gap: var(--space-sm);
        width: 100%;
        padding: 8px 0;
      }
      
      .step-number {
        width: 40px;
        height: 40px;
        margin-bottom: 0;
      }
      
      .step-label {
        text-align: left;
        flex: 1;
      }

      .app-header h1 {
        font-size: 1.4rem;
      }
      
      .app-header h1 i {
        width: 40px;
        height: 40px;
      }
      
      .form-section-title {
        font-size: 1.1rem;
      }
      
      .form-section-title i {
        width: 32px;
        height: 32px;
      }

      #gmap {
        height: 300px;
      }

      .btn-primary, .btn-secondary {
        padding: 14px 20px;
        font-size: 0.9rem;
      }
      
      .btn-small {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      #all-appraisals-list,
      #my-appraisals-list {
        max-height: 50vh;
      }
    }

    
    #image-viewer-modal .modal-content {
      background: transparent !important;
      box-shadow: none !important;
    }

    #image-viewer-modal .modal-close {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 1001;
      border: 2px solid rgba(255,255,255,0.5);
    }

    #image-viewer-modal .modal-close:hover {
      background: rgba(0,0,0,0.9);
      transform: scale(1.1);
    }

    .catalog-image-modal {
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 2px solid transparent;
    }

    .catalog-image-modal:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    
    .catalog-item-content {
      position: relative;
    }

    .catalog-image-modal::after {
      content: '\f002';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      color: white;
      background: rgba(91, 123, 122, 0.8);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
      opacity: 0;
    }

    .catalog-image-modal:hover::after {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

   
    .image-upload-container {
      margin-top: 12px;
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: var(--space-lg);
      text-align: center;
      transition: all 0.3s ease;
      background: var(--bg-hover);
      cursor: pointer;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(91, 123, 122, 0.05);
    }

    .image-preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .image-preview-item {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .image-preview-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
    }

    .image-preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: var(--error);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-preview-info {
      padding: 8px;
      background: var(--bg-card);
      font-size: 0.75rem;
      color: var(--text-light);
    }

   /
    #image-viewer-modal {
      z-index: 2000 !important;
    }
    
    #image-viewer-modal .modal-content {
      z-index: 2001 !important;
    }

    
    .typology-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .typology-tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: var(--text-light);
    }

    .typology-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: rgba(91, 123, 122, 0.05);
    }

    .typology-tab:hover:not(.active) {
      background: var(--bg-hover);
      color: var(--text);
    }

    .typology-tab-content {
      display: none;
      padding: 20px;
    }

    .typology-tab-content.active {
      display: block;
    }

    .typology-accordion {
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .typology-accordion-header {
      padding: 16px 20px;
      background: var(--bg-hover);
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: var(--text);
      transition: all 0.3s ease;
    }

    .typology-accordion-header:hover {
      background: rgba(91, 123, 122, 0.1);
    }

    .typology-accordion-header.active {
      background: rgba(91, 123, 122, 0.15);
      color: var(--primary);
    }

    .typology-accordion-icon {
      transition: transform 0.3s ease;
    }

    .typology-accordion-header.active .typology-accordion-icon {
      transform: rotate(180deg);
    }

    .typology-accordion-content {
      display: none;
      padding: 0;
      background: var(--bg-card);
    }

    .typology-accordion-content.active {
      display: block;
    }

    .typology-variants {
      display: grid;
      gap: 0;
    }

    .typology-variant {
      padding: 20px;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }

    .typology-variant:last-child {
      border-bottom: none;
    }

    .typology-variant:hover {
      background: rgba(91, 123, 122, 0.03);
    }

    .variant-content {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .variant-images {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .variant-image {
      width: 100px;
      height: 80px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
      border: 1px solid var(--border);
    }

    .variant-image:hover {
      transform: scale(1.05);
      border-color: var(--primary);
    }

    .variant-details {
      flex: 1;
    }

    .variant-title {
      font-weight: 600;
      color: var(--primary);
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .variant-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    .variant-features {
      list-style: none;
      margin-bottom: 12px;
    }

    .variant-features li {
      padding: 4px 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text);
      line-height: 1.4;
    }

    .variant-features li i {
      color: var(--primary);
      font-size: 0.8rem;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .variant-description {
      font-size: 0.8rem;
      color: var(--text-light);
      line-height: 1.5;
      margin-bottom: 12px;
      padding: 12px;
      background: rgba(91, 123, 122, 0.03);
      border-radius: var(--radius-sm);
    }

    @media (max-width: 768px) {
      .typology-tabs {
        flex-direction: column;
      }
      
      .typology-tab {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        border-left: 3px solid transparent;
      }
      
      .typology-tab.active {
        border-left-color: var(--primary);
        border-bottom-color: var(--border);
      }
      
      .variant-content {
        flex-direction: column;
      }
      
      .variant-images {
        justify-content: center;
      }
      
      .variant-image {
        width: 120px;
        height: 90px;
      }
    }

    
    .typology-breadcrumbs {
      padding: 16px 24px;
      background: rgba(91, 123, 122, 0.03);
      border-bottom: 1px solid var(--border-light);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .typology-breadcrumbs .crumb {
      color: var(--text-light);
      transition: color 0.2s ease;
    }

    .typology-breadcrumbs .crumb.current {
      color: var(--primary);
      font-weight: 600;
    }

    .typology-breadcrumbs .separator {
      color: var(--text-lighter);
    }

    .nav-indicators {
      padding: 12px 24px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .position-indicator {
      color: var(--text);
      font-weight: 500;
    }

    .types-count {
      color: var(--text-light);
      background: rgba(91, 123, 122, 0.1);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    @media (max-width: 768px) {
      .typology-breadcrumbs {
        padding: 12px 16px;
        font-size: 0.8rem;
      }
      .nav-indicators {
        padding: 8px 16px;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  
  <div class="app-container">
    <header class="app-header">
      <h1><img src="http://visione.gt/wp-content/uploads/2020/12/Logo-sitio.png" alt="Logo" style="width: 200px; height: 60px; border-radius: 12px; object-fit: contain; background: rgba(91,123,122,.1); padding: 4px;"> Sistema de Avalúos</h1>
    </header>

    <div class="floating-actions">
      <button class="floating-btn" id="all-appraisals-btn" title="Lista de Avalúos">
        <i class="fas fa-list"></i>
      </button>
      <button class="floating-btn" id="my-appraisals-btn" title="Mis Avalúos">
        <i class="fas fa-user"></i>
      </button>
    </div>

    
    <div class="catalog-modal" id="username-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user-plus"></i> Completa tu perfil</h3>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <div class="form-group">
            <label for="google-username" class="required">Elige un nombre de usuario</label>
            <input type="text" id="google-username" placeholder="Ingresa tu username" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius);" />
            <div class="form-help">Este nombre se mostrará en tus avalúos</div>
          </div>
          <button class="btn-primary" id="save-google-username" style="width: 100%; margin-top: 16px;">
            <i class="fas fa-check"></i> Guardar y continuar
          </button>
        </div>
      </div>
    </div>

    
    <div class="catalog-modal" id="all-appraisals-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-list"></i> Lista de Avalúos</h3>
          <button class="modal-close" onclick="closeModal('all-appraisals-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group">
            <input type="text" id="search-appraisals" placeholder="Buscar avalúos..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius);">
          </div>
          <div id="all-appraisals-list" style="max-height: 400px; overflow-y: auto;">
            
          </div>
        </div>
      </div>
    </div>

    
    <div class="catalog-modal" id="my-appraisals-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user"></i> Mis Avalúos</h3>
          <button class="modal-close" onclick="closeModal('my-appraisals-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div id="my-appraisals-list" style="max-height: 400px; overflow-y: auto;">
            
          </div>
        </div>
      </div>
    </div>

    
    <div class="catalog-modal" id="image-viewer-modal" style="z-index: 2000;">
      <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; box-shadow: none; z-index: 2001;">
        <button class="modal-close" onclick="closeImageViewer()" style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; z-index: 2002;">
          &times;
        </button>
        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
          <img id="full-size-image" src="" alt="Imagen en tamaño completo" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: var(--radius);">
        </div>
      </div>
    </div>

    <div class="auth-overlay" id="auth-overlay">
      <button class="auth-close" title="Cerrar" onclick="/* no permitir cerrar sin login */void(0)">×</button>
      <div class="auth-panel card">
        <h2><i class="fas fa-user-lock"></i> Acceso requerido</h2>
        <p style="margin-bottom:12px;color:var(--text-light)">
          Inicia sesión para usar el Sistema de Avalúos. Si creas cuenta con correo, debes confirmar desde tu email.
        </p>
        <div class="auth-grid">
          <div class="auth-col">
            <div class="auth-col-title">Con correo</div>
            <input id="auth-email" type="email" placeholder="tu@correo.com" class="auth-input">
            <input id="auth-pass" type="password" placeholder="Contraseña" class="auth-input">
            <input id="auth-username" type="text" placeholder="Username (nuevo)" class="auth-input">
            <button class="btn-primary" type="button" onclick="__signInWithEmail(
              document.getElementById('auth-email').value,
              document.getElementById('auth-pass').value
            )">
              <i class="fas fa-right-to-bracket"></i> Iniciar sesión
            </button>
            <button class="btn-secondary" type="button" style="margin-top:8px" onclick="__signUpWithEmail(
              document.getElementById('auth-email').value,
              document.getElementById('auth-pass').value,
              document.getElementById('auth-username').value
            )">
              <i class="fas fa-user-plus"></i> Crear cuenta
            </button>
            <button class="btn-secondary" type="button" style="margin-top:8px"
              onclick="__resendVerification(document.getElementById('auth-email').value)">
              <i class="fas fa-envelope"></i> Reenviar correo de verificación
            </button>
          </div>

          <div class="auth-col">
            <div class="auth-col-title">Con Google</div>
            <button class="btn-primary" type="button" onclick="__signInWithGoogle()">
              <i class="fab fa-google"></i> Continuar con Google
            </button>
            <div class="form-help" style="margin-top:8px">
              Requiere configurar Google OAuth en Supabase/Google Cloud.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="user-box" style="display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:16px;margin-bottom:24px;padding:16px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);">
      <div style="color:var(--text-light)">
        <i class="fas fa-circle-user"></i>
        <span data-user-name></span> · <span data-user-email></span>
      </div>
      <button class="btn-secondary" type="button" onclick="__signOut()">
        <i class="fas fa-arrow-right-from-bracket"></i> Cerrar sesión
      </button>
    </div>

    <div class="form-steps">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-label">Información General</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-label">Características</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-label">Cálculos</div>
      </div>
      <div class="step" data-step="4">
        <div class="step-number">4</div>
        <div class="step-label">Resultados</div>
      </div>
    </div>

    <div class="card">
      

      <div class="form-section active" data-step="1">
        <h2><i class="fas fa-info-circle"></i> Información General</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="associate-name" class="required">Nombre del Asociado</label>
            <input type="text" id="associate-name" placeholder="Ingrese el nombre completo" required />
            <div class="form-help">Nombre completo del solicitante</div>
          </div>
          <div class="form-group">
            <label for="address" class="required">Dirección de la Propiedad</label>
            <input type="text" id="address" placeholder="Escriba y elija de las sugerencias" required />
            <div class="form-help">La dirección se completará automáticamente</div>
          </div>
          <div class="form-group">
            <label for="geo-lat">Latitud</label>
            <input type="text" id="geo-lat" placeholder="-" readonly />
          </div>
          <div class="form-group">
            <label for="geo-lng">Longitud</label>
            <input type="text" id="geo-lng" placeholder="-" readonly />
          </div>
          <div class="form-group">
            <label for="construction-area" class="required">Área Construida (m²)</label>
            <input type="number" id="construction-area" placeholder="Ej: 120" min="1" required />
          </div>
          <div class="form-group">
            <label for="land-area" class="required">Área del Terreno (m²)</label>
            <input type="number" id="land-area" placeholder="Ej: 200" min="1" required />
          </div>
        </div>
        
        <div style="margin: var(--space-md) 0;">
          <button class="btn-primary" type="button" onclick="locateMeOnce()">
            <i class="fas fa-location-crosshairs"></i> Usar mi ubicación
          </button>
          <div class="form-help">Requiere HTTPS o localhost y permiso del navegador</div>
        </div>

        <div class="form-section-title"><i class="fas fa-map"></i> Ubicación en Mapa</div>
        <div id="gmap" style="height: 360px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border);"></div>
        <div class="form-help">Arrastre el pin para ajustar la posición o <strong>toque/cliquee en cualquier lugar del mapa</strong> para colocar el marcador</div>
      </div>

      <div class="form-section" data-step="2">
        <h2><i class="fas fa-home"></i> Características de la Propiedad</h2>
        
        <div class="form-section-title"><i class="fas fa-file-contract"></i> Datos Registrales</div>
        <div class="form-grid">
          <div class="form-group"><label for="owner-name">Nombre del Propietario</label><input type="text" id="owner-name" placeholder="Ingrese el nombre del propietario" /></div>
          <div class="form-group"><label for="deed-number">Número de Escritura</label><input type="text" id="deed-number" placeholder="Número de escritura" /></div>
          <div class="form-group"><label for="deed-date">Fecha de Escritura</label><input type="date" id="deed-date" /></div>
          <div class="form-group"><label for="notary">Notario</label><input type="text" id="notary" placeholder="Nombre del notario" /></div>
        </div>

        <div class="form-section-title"><i class="fas fa-map-marked-alt"></i> Finca Registrada</div>
        <div class="form-grid">
          <div class="form-group"><label for="finca">Finca</label><input type="text" id="finca" placeholder="Número de finca" /></div>
          <div class="form-group"><label for="folio">Folio</label><input type="text" id="folio" placeholder="Folio" /></div>
          <div class="form-group"><label for="libro">Libro</label><input type="text" id="libro" placeholder="Libro" /></div>
          <div class="form-group"><label for="department">Departamento</label><input type="text" id="department" placeholder="Departamento" /></div>
        </div>

        <div class="form-section-title" style="margin-top: var(--space-lg);"><i class="fas fa-map-marker-alt"></i> Colindancias</div>
        <table class="table-ui">
          <thead><tr><th>Dirección</th><th>Propietario</th><th>Metros</th></tr></thead>
          <tbody>
            <tr><td><strong>Norte:</strong></td><td><input type="text" id="norte-propietario" placeholder="Propietario" /></td><td><input type="number" id="norte-metros" placeholder="Metros" step="0.01" /></td></tr>
            <tr><td><strong>Sur:</strong></td><td><input type="text" id="sur-propietario" placeholder="Propietario" /></td><td><input type="number" id="sur-metros" placeholder="Metros" step="0.01" /></td></tr>
            <tr><td><strong>Oriente:</strong></td><td><input type="text" id="oriente-propietario" placeholder="Propietario" /></td><td><input type="number" id="oriente-metros" placeholder="Metros" step="0.01" /></td></tr>
            <tr><td><strong>Poniente:</strong></td><td><input type="text" id="poniente-propietario" placeholder="Propietario" /></td><td><input type="number" id="poniente-metros" placeholder="Metros" step="0.01" /></td></tr>
          </tbody>
        </table>

<div class="form-section-title" style="margin-top: var(--space-lg);">
  <i class="fas fa-map-marked-alt"></i> Información del Solar
</div>

<div class="form-grid">
  
  <div class="form-group">
    <label style="font-weight: 600; color: var(--text); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
      <i class="fas fa-road" style="color: var(--primary);"></i> Calles
    </label>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Concreto:</span>
      <input type="text" id="calle-concreto" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Adoquín:</span>
      <input type="text" id="calle-adoquin" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Servidumbre de Paso:</span>
      <input type="text" id="calle-servidumbre" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Vereda:</span>
      <input type="text" id="calle-vereda" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Tierra:</span>
      <input type="text" id="calle-tierra" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Asfalto:</span>
      <input type="text" id="calle-asfalto" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
  </div>

  
  <div class="form-group">
    <label style="font-weight: 600; color: var(--text); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
      <i class="fas fa-bolt" style="color: var(--primary);"></i> Servicios Públicos
    </label>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Energía Eléctrica:</span>
      <input type="text" id="servicio-electricidad" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Red de Agua:</span>
      <input type="text" id="servicio-agua" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Ducto Teléfono:</span>
      <input type="text" id="servicio-telefono" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Drenaje:</span>
      <input type="text" id="servicio-drenaje" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Acera:</span>
      <input type="text" id="servicio-acera" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Bordillo:</span>
      <input type="text" id="servicio-bordillo" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
  </div>
</div>

<div class="form-grid" style="margin-top: var(--space-md);">
  
  <div class="form-group">
    <label style="font-weight: 600; color: var(--text); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
      <i class="fas fa-location-dot" style="color: var(--primary);"></i> Ubicación del terreno
    </label>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Esquina:</span>
      <input type="text" id="ubicacion-esquina" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Medial:</span>
      <input type="text" id="ubicacion-medial" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
  </div>

 
  <div class="form-group">
    <label style="font-weight: 600; color: var(--text); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
      <i class="fas fa-tag" style="color: var(--primary);"></i> Clasificación del terreno
    </label>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Urbano:</span>
      <input type="text" id="clasificacion-urbano" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; padding: var(--space-xs) 0;">
      <span style="color: var(--text); font-size: 0.9rem;">Rústico:</span>
      <input type="text" id="clasificacion-rustico" placeholder="x" style="width: 60px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text); text-align: center; font-size: 0.9rem;">
    </div>
  </div>
</div>

<div class="form-help" style="margin-top: var(--space-lg); margin-bottom: var(--space-lg); color: var(--text-light); font-size: 0.85rem;">
  <i class="fas fa-info-circle" style="color: var(--primary-light);"></i> Marque con "x" los elementos que correspondan al solar. Deje en blanco los que no apliquen.
</div>

        <div class="form-section-title"><i class="fas fa-hammer"></i> Características Constructivas</div>
        <div class="characteristics-grid">
          <div class="form-group"><label for="uso-destino">Uso y Destino</label><select id="uso-destino"><option value="">Seleccionar</option><option value="residencia">Residencia</option><option value="cultivo">Cultivo</option><option value="industrial">Industrial</option><option value="comercial">Comercial</option><option value="edificio">Edificio</option></select></div>
          <div class="form-group"><label for="estructura">Estructura</label><select id="estructura"><option value="">Seleccionar</option><option value="acero">Acero</option><option value="hierro">Hierro</option><option value="concreto">Concreto</option><option value="madera">Madera</option><option value="pre-fab">Pre-Fab</option><option value="adobe">Adobe</option></select></div>
          <div class="form-group"><label for="cimiento">Cimiento</label><select id="cimiento"><option value="">Seleccionar</option><option value="concreto">Concreto</option><option value="adobe">Adobe</option><option value="block">Block</option><option value="ladrillo">Ladrillo</option><option value="piedra">Piedra</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="techos">Techos</label><select id="techos"><option value="">Seleccionar</option><option value="concreto">Concreto</option><option value="lam-zinc">Lam. Zinc</option><option value="dural-roja">Dural. Roja</option><option value="dural-gris">Dural. Gris</option><option value="teja-barro">Teja de barro</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="pisos">Pisos</label><select id="pisos"><option value="">Seleccionar</option><option value="tota-ceramico">Tota-Cerámico</option><option value="ceramico">Cerámico</option><option value="granito">Granito</option><option value="porcelanato">Porcelanato</option><option value="madera">Madera</option><option value="tierra">Tierra</option></select></div>
          <div class="form-group"><label for="acabados">Acabados Interiores</label><select id="acabados"><option value="">Seleccionar</option><option value="repello">Repello</option><option value="cernido">Cernido</option><option value="alisado">Alisado</option><option value="estuco">Estuco</option><option value="tapiz">Tapiz</option><option value="otro">Otro</option></select></div>
          <div class="form-group"><label for="paredes">Paredes</label><select id="paredes"><option value="">Seleccionar</option><option value="block">Block</option><option value="adobe">Adobe</option><option value="madera">Madera</option><option value="bahareque">Bahareque</option><option value="prefabricado">Prefabricado</option><option value="concreto">Concreto</option></select></div>
          <div class="form-group"><label for="ventanas">Ventanas</label><select id="ventanas"><option value="">Seleccionar</option><option value="upvc">UPVC</option><option value="aluminio">Aluminio</option><option value="metal">Metal</option><option value="madera">Madera</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="puertas">Puertas</label><select id="puertas"><option value="">Seleccionar</option><option value="upvc">UPVC</option><option value="madera">Madera</option><option value="metal">Metal</option><option value="pre-fab">Pre-Fab</option><option value="rustica">Rústica</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="cielos">Cielos</label><select id="cielos"><option value="">Seleccionar</option><option value="concreto">Concreto</option><option value="prefabricado">Prefabricado</option><option value="machimbre">Machimbre</option><option value="madera">Madera</option><option value="falsa-terraza">Falsa terraza</option><option value="sin-cielo">Sin Cielo</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="sanitario">Sanitario</label><select id="sanitario"><option value="">Seleccionar</option><option value="bueno">Bueno</option><option value="medio">Medio</option><option value="bajo">Bajo</option><option value="letrina">Letrina</option><option value="pozo">Pozo</option></select></div>
          <div class="form-group"><label for="red-electric">Red Eléctrica</label><select id="red-electric"><option value="">Seleccionar</option><option value="municipal">Municipal</option><option value="energuate">Energuate</option><option value="solar">Solar</option><option value="solar-fed">Solar/Fed</option><option value="sin-elec">Sin Electricidad</option></select></div>
          <div class="form-group"><label for="agua">Servicio de Agua</label><select id="agua"><option value="">Seleccionar</option><option value="municipal">Municipal</option><option value="comunal">Comunal</option><option value="pozo">Pozo</option><option value="otros">Otros</option></select></div>
          <div class="form-group"><label for="estado-inmueble">Estado de Conservación</label><select id="estado-inmueble"><option value="">Seleccionar</option><option value="Excelente">Excelente</option><option value="Bueno">Bueno</option><option value="Regular">Regular</option><option value="Malo">Malo</option></select></div>
          <div class="form-group"><label for="anio-construccion">Año de Construcción</label><input type="number" id="anio-construccion" min="1900" max="2025" placeholder="Ej: 2018" /></div>
        </div>

        <div class="form-group" style="margin-top:24px;">
          <label for="otros-detalles">Otros Detalles Específicos</label>
          <textarea id="otros-detalles" placeholder="Describa otros detalles como: Aire Acondicionado, Car-port, Garaje, Chimeneas, etc."></textarea>
        </div>

        <div class="form-section-title" style="margin-top: var(--space-lg);"><i class="fas fa-list"></i> Catalogo de categorías y tipologías</div>
        <div class="form-group">
          <label>Tipología constructiva</label>
          <div class="typology-selector" onclick="__openTypology()">
            <div id="typologyTrigger" class="typology-trigger">
              <img id="selectedImage" class="selected-image" src="https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=200&q=60" alt="Tipología" />
              <div class="selected-text">
                <div id="selectedType" class="selected-type">Catálogo</div>
                <div id="selectedTitle" class="selected-title">Pulsa para elegir del catálogo</div>
                <div id="selectedPrice" class="selected-price">—</div>
              </div>
            </div>
          </div>
          <input type="hidden" id="typology" value="">
          <div class="form-help">Toca el recuadro para abrir el catálogo de tipologías</div>
        </div>

        
        <div class="form-section-title" style="margin-top: var(--space-lg);">
          <i class="fas fa-camera"></i> Evidencia Fotográfica del Inmueble
        </div>
        <div class="form-group">
          <label>Subir imágenes de evidencia</label>
          <div class="image-upload-container">
            <input type="file" id="image-upload" multiple accept="image/*" style="display: none;">
            <div class="upload-area" id="upload-area">
              <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary-light); margin-bottom: 12px;"></i>
              <div style="font-weight: 500; color: var(--text); margin-bottom: 8px;">Arrastra imágenes aquí o haz clic para seleccionar</div>
              <div style="font-size: 0.85rem; color: var(--text-light);">Formatos: JPG, PNG, GIF • Máx. 25MB por imagen</div>
              <button type="button" class="btn-secondary" onclick="document.getElementById('image-upload').click()" style="margin-top: 16px;">
                <i class="fas fa-folder-open"></i> Seleccionar Archivos
              </button>
            </div>
            <div id="image-preview" class="image-preview-container"></div>
          </div>
          <div class="form-help">Suba fotografías que sirvan como evidencia para el avalúo (fachada, interiores, detalles constructivos, etc.)</div>
        </div>
      </div>

      <div class="form-section" data-step="3">
        <h2><i class="fas fa-calculator"></i> Datos de propiedad</h2>
        
        <div class="form-section-title"><i class="fas fa-mountain"></i> Cálculo del Valor del Terreno</div>
        <table class="table-ui" id="tablaTerreno">
          <thead>
            <tr>
              <th style="width:140px">V/Base (Q/m²)</th>
              <th style="width:140px">Área m²</th>
              <th style="width:120px">Fac. Fte.</th>
              <th style="width:120px">Fac. Fdo.</th>
              <th style="width:120px">Fac. Fma.</th>
              <th style="width:120px">Fac. Ext.</th>
              <th style="width:140px">Otros Fac.</th>
              <th style="width:160px">MONTO</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="number" min="0" step="0.01" class="t-vbase" placeholder="1500"></td>
              <td><input type="number" min="0" step="0.01" class="t-area" id="t-area" placeholder="0"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffte" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffdo" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-ffma" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-fext" placeholder="1" value="1"></td>
              <td><input type="number" min="0" step="0.01" class="t-fotros" placeholder="1" value="1"></td>
              <td><input type="text" class="t-monto" id="t-monto" value="0.00" readonly></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="7" style="text-align:right; font-weight:600;">TOTAL TERRENO</td>
              <td><input type="text" id="totalTerreno" value="0.00" readonly></td>
            </tr>
          </tfoot>
        </table>

        <div class="form-section-title"><i class="fas fa-building-user"></i> Cálculo del Valor de la Construcción</div>
        <table class="table-ui" id="tablaConstruccion">
  <thead>
    <tr>
      <th style="width:160px">Planta</th>
      <th style="width:140px">Área m²</th>
      <th style="width:140px">V/Base</th>
      <th style="width:120px">%</th>
      <th>Categoria y Tipologia</th>
      <th style="width:160px">MONTO</th>
    </tr>
  </thead>
  <tbody id="tbBodyConstruccion">
    <tr>
      <td><input type="text" value="Primer Nivel" class="planta-input"></td>
      <td><input type="number" min="0" step="0.01" class="area-input" placeholder="0"></td>
      <td><input type="number" min="0" step="0.01" class="vbase-input" placeholder="0"></td>
      <td><input type="number" min="0" step="0.01" value="1" class="coef-input"></td>
      <td>
        <div class="typology-selector" onclick="__openTypologyForConstruction(this)">
          <div class="typology-trigger">
            <img class="selected-image" src="https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=200&q=60" alt="Tipología" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
            <div class="selected-text">
              <div class="selected-type">Catálogo</div>
              <div class="selected-title">Pulsa para elegir tipología</div>
              <div class="selected-price">—</div>
            </div>
          </div>
        </div>
        <input type="hidden" class="typology-id-input" value="">
      </td>
      <td><input type="text" class="monto-output" value="0.00" readonly></td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td colspan="5" style="text-align:right; font-weight:600;">TOTAL</td>
      <td><input type="text" id="totalConstruccion" value="0.00" readonly></td>
    </tr>
  </tfoot>
</table>
        
        <div style="display:flex; gap:12px; margin-top:8px;">
          <button class="btn-secondary btn-small" type="button" onclick="agregarFilaConstruccion()">
            <i class="fas fa-plus"></i> Agregar nivel
          </button>
          <button class="btn-secondary btn-small" type="button" onclick="eliminarUltimaFilaConstruccion()">
            <i class="fas fa-minus"></i> Quitar último nivel
          </button>
        </div>

        <div class="form-help" style="margin-top:8px;">
          El MONTO se calcula como: <strong>Área m² × V/Base × %</strong>. Todos los campos son manuales (editables), excepto MONTO.
        </div>

        <div class="form-section-title"><i class="fas fa-layer-group"></i> Integración de Valores</div>
        <div class="result-grid" id="integracionValores">
          <div class="result-item">
            <div class="label">Valor del Terreno</div>
            <div class="value" id="ivTerreno">Q0.00</div>
          </div>
          <div class="result-item">
            <div class="label">Valor de Construcción</div>
            <div class="value" id="ivConstruccion">Q0.00</div>
          </div>
          <div class="result-item">
            <div class="label">Total Avalúo</div>
            <div class="value" id="ivTotal">Q0.00</div>
          </div>
        </div>
      </div>

      <div class="form-navigation">
        <button class="btn-secondary" id="prev-step"><i class="fas fa-arrow-left"></i> Anterior</button>
        <button class="btn-primary" id="next-step">Siguiente <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <div class="result-section" id="resultSection">
      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> Calculo final</h2>
        <div class="result-grid">
          <div class="result-item"><div class="label">Área Construida</div><div class="value" id="resultArea">0 m²</div></div>
          <div class="result-item"><div class="label">Tipología</div><div class="value" id="resultTypology">-</div></div>
          <div class="result-item"><div class="label">Estado</div><div class="value" id="resultCondition">-</div></div>
          <div class="result-item"><div class="label">Antigüedad</div><div class="value" id="resultAge">0 años</div></div>
          <div class="result-item"><div class="label">Valor Terreno (sin ajuste)</div><div class="value" id="resultLandValue">Q0.00</div></div>
          <div class="result-item"><div class="label">Avaluó Terreno (con ajuste)</div><div class="value" id="resultLandAppraisal">Q0.00</div></div>
          <div class="result-item"><div class="label">Valor Construcción</div><div class="value" id="resultBuildValue">Q0.00</div></div>
          <div class="result-item"><div class="label">TOTAL Terreno + Construcción</div><div class="value" id="resultGrandTotal">Q0.00</div></div>
        </div>
        <div class="result-total"><div class="label">VALOR TOTAL ESTIMADO</div><div class="value" id="resultTotal">Q0.00</div></div>
        <div style="display:flex; gap:12px; margin-top:24px;">
          <button class="btn-primary" onclick="generateReport()" style="flex:1;"><i class="fas fa-file-pdf"></i> Generar Reporte PDF</button>
          <button class="btn-secondary" onclick="newAppraisal()" style="flex:1;"><i class="fas fa-redo"></i> Nuevo Avalúo</button>
        </div>
      </div>
    </div>

    <div class="catalog-modal" id="catalogModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-home"></i> Seleccionar Tipología Constructiva</h3>
          <button class="modal-close" id="closeModal" type="button">&times;</button>
        </div>
        
        <nav class="typology-breadcrumbs">
          <span class="crumb">Catálogo</span>
          <span class="separator">›</span>
          <span class="crumb" id="breadcrumb-category">Categoría</span>
          <span class="separator">›</span>
          <span class="crumb current" id="breadcrumb-type">Tipología</span>
        </nav>

        <div class="nav-indicators">
          <span class="position-indicator" id="position-indicator">Selecciona una categoría</span>
          <span class="types-count" id="types-count">0 tipos disponibles</span>
        </div>
        
        <div class="modal-body" style="padding: 0;">
          <div class="typology-tabs">
            <button class="typology-tab active" data-tab="baja">Categoría Baja</button>
            <button class="typology-tab" data-tab="media">Categoría Media</button>
            <button class="typology-tab" data-tab="alta">Categoría Alta</button>
          </div>
          
          <div class="typology-tab-content active" id="tab-baja">
           
          </div>
          
          <div class="typology-tab-content" id="tab-media">
            
          </div>
          
          <div class="typology-tab-content" id="tab-alta">
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div style="color: var(--primary); font-weight: 500;">Generando PDF...</div>
  </div>

  <button id="save-btn" type="button"><i class="fas fa-save"></i> Guardar</button>
  <button id="pdf-btn" type="button"><i class="fas fa-file-pdf"></i> PDF</button>

  <script>
    
    function __updateBreadcrumbs(category, type) {
      const categoryCrumb = document.getElementById('breadcrumb-category');
      const typeCrumb = document.getElementById('breadcrumb-type');
      const positionIndicator = document.getElementById('position-indicator');
      const typesCount = document.getElementById('types-count');
      
      if (categoryCrumb) categoryCrumb.textContent = `Categoría ${category}`;
      if (typeCrumb) typeCrumb.textContent = type ? `Tipología ${type}` : 'Selecciona tipo';
      if (positionIndicator) {
        positionIndicator.textContent = type ? 
          `Categoría ${category} - Tipología ${type}` : 
          `Explorando Categoría ${category}`;
      }
      if (typesCount) {
        const tipologias = __getTipos();
        const tiposEnCategoria = tipologias.filter(t => t.category === category);
        const totalVariantes = tiposEnCategoria.reduce((acc, curr) => acc + curr.variants.length, 0);
        typesCount.textContent = `${totalVariantes} variantes disponibles`;
      }
    }

    
    function modificarPrecioTipologia(tipologiaId, nuevoPrecio) {
        const tipologias = __getTipos();
        const tipologia = tipologias.find(t => t.id === tipologiaId);
        
        if (!tipologia) {
            console.error('Tipología no encontrada:', tipologiaId);
            return false;
        }
        
        const rango = RANGOS_PRECIO[tipologia.category]?.[tipologia.type];
        
        if (!rango) {
            console.error('Rango de precios no encontrado para:', tipologia.category, tipologia.type);
            return false;
        }
        
        const precioMaximo = rango.max;
        
        if (nuevoPrecio > precioMaximo) {
            console.warn(`El precio no puede superar Q${precioMaximo}. Se establecerá en el máximo permitido.`);
            nuevoPrecio = precioMaximo;
        }
        
        if (nuevoPrecio < rango.min) {
            console.warn(`El precio no puede ser menor a Q${rango.min}. Se establecerá en el mínimo permitido.`);
            nuevoPrecio = rango.min;
        }
        
        tipologia.pricePerM2 = nuevoPrecio;
        
        const tipologiaActual = document.getElementById('typology').value;
        if (tipologiaActual === tipologiaId) {
            const precioInput = document.getElementById('precio-editable-input');
            if (precioInput) {
                precioInput.value = nuevoPrecio;
                
                const pr = document.getElementById('selectedPrice');
                if (pr) {
                    pr.textContent = `Q${nuevoPrecio.toLocaleString('es-GT')}/m²`;
                }
                
                if (document.getElementById('resultSection').classList.contains('active')) {
                    calculateRealAppraisal();
                }
            }
        }
        
        console.log(`Precio de ${tipologia.title} actualizado a: Q${nuevoPrecio}/m²`);
        return true;
    }

    
    window.avaluosStorage = {
      getAllAppraisals: function() {
        try {
          const stored = localStorage.getItem('sistema_avaluos');
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          console.error('Error al cargar avalúos:', e);
          return [];
        }
      },

      saveAppraisal: function(avaluoData) {
        try {
          const avaluos = this.getAllAppraisals();
          const newAppraisal = {
            id: 'av-' + Date.now(),
            usuario_id: window.__session?.user?.id || 'anonimo',
            usuario_nombre: window.__session?.user?.user_metadata?.username || 'Anónimo',
            fecha_creacion: new Date().toISOString(),
            fecha_formateada: new Date().toLocaleDateString('es-GT'),
            datos: avaluoData,
            estado: 'completado'
          };
          
          avaluos.unshift(newAppraisal);
          localStorage.setItem('sistema_avaluos', JSON.stringify(avaluos));
          return newAppraisal;
        } catch (e) {
          console.error('Error al guardar avalúo:', e);
          return null;
        }
      },

      getMyAppraisals: function() {
        const userId = window.__session?.user?.id;
        if (!userId) return [];
        
        const allAppraisals = this.getAllAppraisals();
        return allAppraisals.filter(av => av.usuario_id === userId);
      },

      updateAppraisal: function(appraisalId, newData) {
        try {
          const avaluos = this.getAllAppraisals();
          const index = avaluos.findIndex(av => av.id === appraisalId);
          
          if (index !== -1) {
            avaluos[index].datos = { ...avaluos[index].datos, ...newData };
            avaluos[index].fecha_actualizacion = new Date().toISOString();
            localStorage.setItem('sistema_avaluos', JSON.stringify(avaluos));
            return true;
          }
          return false;
        } catch (e) {
          console.error('Error al actualizar avalúo:', e);
          return false;
        }
      },

      deleteAppraisal: function(appraisalId) {
        try {
          const avaluos = this.getAllAppraisals();
          const filtered = avaluos.filter(av => av.id !== appraisalId);
          localStorage.setItem('sistema_avaluos', JSON.stringify(filtered));
          return true;
        } catch (e) {
          console.error('Error al eliminar avalúo:', e);
          return false;
        }
      }
    };

    
    function showAllAppraisals() {
      const modal = document.getElementById('all-appraisals-modal');
      const listContainer = document.getElementById('all-appraisals-list');
      
      const allAppraisals = window.avaluosStorage.getAllAppraisals();
      
      if (allAppraisals.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h4>No hay avalúos registrados</h4>
            <p>Los avalúos que se realicen aparecerán aquí</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = allAppraisals.map(avaluo => `
          <div class="appraisal-item">
            <div class="appraisal-header">
              <div class="appraisal-date">
                <i class="fas fa-calendar"></i> ${avaluo.fecha_formateada}
              </div>
              <div class="appraisal-actions">
                <button class="btn-secondary btn-small" onclick="viewAppraisal('${avaluo.id}')">
                  <i class="fas fa-eye"></i> Ver
                </button>
              </div>
            </div>
            <div class="appraisal-details">
              <div><strong>Asociado:</strong> ${avaluo.datos.associateName || 'No especificado'}</div>
              <div><strong>Dirección:</strong> ${avaluo.datos.address || 'No especificado'}</div>
              <div><strong>Valor Total:</strong> ${avaluo.datos.totalValue || 'Q0.00'}</div>
              <div><strong>Usuario:</strong> ${avaluo.usuario_nombre}</div>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function showMyAppraisals() {
      if (!window.__session) {
        alert('Debes iniciar sesión para ver tus avalúos');
        document.getElementById('auth-overlay').style.display = 'flex';
        return;
      }
      
      const modal = document.getElementById('my-appraisals-modal');
      const listContainer = document.getElementById('my-appraisals-list');
      
      const myAppraisals = window.avaluosStorage.getMyAppraisals();
      
      if (myAppraisals.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-file-contract"></i>
            <h4>No tienes avalúos guardados</h4>
            <p>Los avalúos que realices aparecerán aquí</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = myAppraisals.map(avaluo => `
          <div class="appraisal-item">
            <div class="appraisal-header">
              <div class="appraisal-date">
                <i class="fas fa-calendar"></i> ${avaluo.fecha_formateada}
              </div>
              <div class="appraisal-actions">
                <button class="btn-primary btn-small" onclick="editAppraisal('${avaluo.id}')">
                  <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-secondary btn-small" onclick="viewAppraisal('${avaluo.id}')">
                  <i class="fas fa-eye"></i> Ver
                </button>
                <button class="btn-small" style="background: var(--error); color: white; border: none;" onclick="deleteAppraisal('${avaluo.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="appraisal-details">
              <div><strong>Asociado:</strong> ${avaluo.datos.associateName || 'No especificado'}</div>
              <div><strong>Dirección:</strong> ${avaluo.datos.address || 'No especificado'}</div>
              <div><strong>Valor Total:</strong> ${avaluo.datos.totalValue || 'Q0.00'}</div>
              <div><strong>Estado:</strong> <span style="color: var(--success);">${avaluo.estado}</span></div>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function viewAppraisal(appraisalId) {
      const avaluos = window.avaluosStorage.getAllAppraisals();
      const avaluo = avaluos.find(av => av.id === appraisalId);
      
      if (avaluo) {
        alert(`Detalles del Avalúo:\n\n` +
              `Fecha: ${avaluo.fecha_formateada}\n` +
              `Asociado: ${avaluo.datos.associateName || 'No especificado'}\n` +
              `Dirección: ${avaluo.datos.address || 'No especificado'}\n` +
              `Área Construida: ${avaluo.datos.constructionArea || '0'} m²\n` +
              `Valor Total: ${avaluo.datos.totalValue || 'Q0.00'}\n` +
              `Usuario: ${avaluo.usuario_nombre}`);
      }
    }

    function editAppraisal(appraisalId) {
      const avaluos = window.avaluosStorage.getAllAppraisals();
      const avaluo = avaluos.find(av => av.id === appraisalId);
      
      if (avaluo) {
        document.getElementById('associate-name').value = avaluo.datos.associateName || '';
        document.getElementById('address').value = avaluo.datos.address || '';
        document.getElementById('construction-area').value = avaluo.datos.constructionArea || '';
        document.getElementById('land-area').value = avaluo.datos.landArea || '';
        
        closeModal('my-appraisals-modal');
        window.formWizard.goToStep(1);
        
        alert('Avalúo cargado para edición. Modifica los datos y guarda los cambios.');
      }
    }

    function deleteAppraisal(appraisalId) {
      if (confirm('¿Estás seguro de que quieres eliminar este avalúo? Esta acción no se puede deshacer.')) {
        if (window.avaluosStorage.deleteAppraisal(appraisalId)) {
          alert('Avalúo eliminado correctamente');
          showMyAppraisals();
        } else {
          alert('Error al eliminar el avalúo');
        }
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    async function saveCurrentAppraisal() {
      if (!window.__session) {
        alert('Debes iniciar sesión para guardar avalúos');
        return false;
      }
      
      console.log('🟡 Iniciando guardado en ambos sistemas...');
      
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) loadingOverlay.style.display = 'flex';
      
      try {
        const appraisalData = {
          associateName: document.getElementById('associate-name').value || 'No especificado',
          address: document.getElementById('address').value || 'No especificado',
          constructionArea: parseFloat(document.getElementById('construction-area').value) || 0,
          landArea: parseFloat(document.getElementById('land-area').value) || 0,
          totalValue: document.getElementById('resultTotal').textContent || 'Q0.00',
          ownerName: document.getElementById('owner-name').value || '',
          typology: document.getElementById('typology').value || '',
          department: document.getElementById('department').value || '',
          estadoInmueble: document.getElementById('estado-inmueble').value || '',
          anioConstruccion: document.getElementById('anio-construccion').value || '',
          totalConstruccion: document.getElementById('totalConstruccion').value || '0',
          totalTerreno: document.getElementById('totalTerreno').value || '0'
        };

        console.log('📦 Datos a guardar:', appraisalData);

        const savedInLocal = window.avaluosStorage.saveAppraisal(appraisalData);
        console.log('✅ Guardado en localStorage:', savedInLocal);

        console.log('🔄 Enviando a Supabase...');
        
        const { data, error } = await window.supabase
          .from('avaluos')
          .insert([
            {
              usuario_id: window.__session.user.id,
              usuario_email: window.__session.user.email,
              usuario_nombre: window.__session.user.user_metadata?.username || 'Usuario',
              fecha_creacion: new Date().toISOString(),
              fecha_formateada: new Date().toLocaleDateString('es-GT'),
              associate_name: appraisalData.associateName,
              address: appraisalData.address,
              construction_area: appraisalData.constructionArea,
              land_area: appraisalData.landArea,
              total_value: appraisalData.totalValue,
              owner_name: appraisalData.ownerName,
              typology: appraisalData.typology,
              department: appraisalData.department,
              estado_inmueble: appraisalData.estadoInmueble,
              anio_construccion: appraisalData.anioConstruccion,
              total_construccion: appraisalData.totalConstruccion,
              total_terreno: appraisalData.totalTerreno,
              datos_completos: appraisalData
            }
          ])
          .select();

        if (error) {
          console.error('❌ Error Supabase:', error);
          console.warn('Avalúo guardado en web pero no en base de datos');
        } else {
          console.log('✅ Éxito - Datos guardados en Supabase:', data);
        }

        alert('✅ Avalúo guardado EXITOSAMENTE\n\n• En la web: Disponible en "Lista de Avalúos"\n• En base de datos: Para tu seguimiento');
        
        if (document.getElementById('all-appraisals-modal').classList.contains('active')) {
          showAllAppraisals();
        }
        if (document.getElementById('my-appraisals-modal').classList.contains('active')) {
          showMyAppraisals();
        }
        
        return true;
        
      } catch (error) {
        console.error('❌ Error completo al guardar:', error);
        alert('❌ Error al guardar: ' + error.message + '\n\nEl avalúo se guardó en la web pero no en la base de datos.');
        return false;
      } finally {
        if (loadingOverlay) loadingOverlay.style.display = 'none';
      }
    }

    document.getElementById('all-appraisals-btn').addEventListener('click', showAllAppraisals);
    document.getElementById('my-appraisals-btn').addEventListener('click', showMyAppraisals);

    document.getElementById('all-appraisals-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal('all-appraisals-modal');
    });
    document.getElementById('my-appraisals-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal('my-appraisals-modal');
    });

    
    const RANGOS_PRECIO = {
        'Baja': {
            'Baja': { min: 250, max: 500 },
            'Media': { min: 650, max: 850 },
            'Alta': { min: 850, max: 1000 }
        },
        'Media': {
            'Baja': { min: 800, max: 1100 },
            'Media': { min: 900, max: 1300 },
            'Alta': { min: 1300, max: 1800 }
        },
        'Alta': {
            'Baja': { min: 1400, max: 1800 },
            'Media': { min: 1800, max: 2200 },
            'Alta': { min: 2300, max: 2900 }
        }
    };

    
    const __FALLBACK_TIPOLOGIAS = [
      {
        category: "Baja",
        type: "Baja",
        generalDescription: 

`Como sistema constructivo encontramos:
– estructura de madera
– muro de block o adobe de 1.00 metro de alto con estructura de madera

Como recubrimiento de paredes encontramos:
– adobe
– block de cantera sin norma de construcción
– madera sin tratar

Como acabados interiores y exteriores:
– block sisado visto
– adobe visto
– madera sin tratar
– blanqueado con cal hidratada

Como cubierta encontramos:
– estructura de madera con cubierta de lámina de zinc
– estructura de costaneras de metal con cubierta de lámina de zinc
– estructura de madera cubierta con teja de barro

Como piso encontramos:
– tierra
– cemento líquido

Como puertas y ventanas encontramos:
– madera sencilla sin tratamiento
– cortinas o cedazo
– sin puertas o ventanas

Como diseño arquitectónico encontramos:
– casas diseñadas en un solo ambiente
– casas diseñadas en dos ambientes
– baño en el exterior de la vivienda (letrina o pozo ciego)

Como servicios básicos encontramos:
– agua potable
– energía eléctrica

Como acceso a este tipo de construcción encontramos:
– terracería (vehicular o vecinal)`,
        variants: [
          {
            id: "baja-baja-1",
            title: "Tipología Baja - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/tipolog%C3%ADa%20baja.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/interior%20tipolog%C3%ADa%20baja.png?raw=true",
            pricePerM2: 400,
            bullets: [
              "Estructura: sistema de adobe, madera",
              "Paredes: adobe recubierto con nylon",
              "Techos: teja de barro sin cielo falso",
              "Piso: tierra con cemento",
              "Ventanas: madera sin tratar",
              "Puertas: madera sin tratar",
              "Servicios: luz, alumbrado público",
              "Exterior: fachada con material expuesto",
              "Instalaciones: expuestas",
              "Rango de precios: Q250.00/m² a Q400.00/m²"
            ]
          },
          {
            id: "baja-baja-2",
            title: "Tipología Baja - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/tipolog%C3%ADa%20baja%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/interior%20tipolog%C3%ADa%20baja%202.png?raw=true",
            pricePerM2: 500,
            bullets: [
              "Estructura: sistema de adobe, columnas de madera",
              "Paredes: adobe, madera sin tratar, cartón",
              "Techos: teja de barro, lámina de zinc sin cielo falso",
              "Piso: tierra con cemento",
              "Ventanas: madera sin tratar",
              "Puertas: madera sin tratar",
              "Servicios: luz, alumbrado público",
              "Exterior: fachada sin mantenimiento",
              "Instalaciones: expuestas",
              "Rango de precios: Q250.00/m² a Q500.00/m²"
            ]
          }
        ]
      },
      {
        category: "Baja",
        type: "Media",
        generalDescription: 

`Como sistema constructivo encontramos:
– estructura de madera
– muro de block o adobe de 1.00 metro de alto, resto estructura de madera
– mampostería con sistema pinedo
– mampostería con columnas para un nivel

Como recubrimiento de paredes encontramos:
– adobe
– block de cantera sin norma de construcción

Como acabados interiores y exteriores:
– block sisado visto
– adobe visto
– madera sin tratar
– blanqueado con cal hidratada

Como cubierta encontramos:
– estructura de madera con cubierta de lámina de zinc
– estructura de costaneras de metal con cubierta de lámina de zinc
– estructura de madera cubierta con teja de barro
– losa de concreto armado

Como piso encontramos:
– tierra
– cemento líquido
– granito

Como puertas y ventanas encontramos:
– madera sin tratar
– metal
– prefabricadas en MDF

Como diseño arquitectónico encontramos:
– casas diseñadas en dos ambientes
– casas diseñadas en tres ambientes
– baño en el exterior de la vivienda (letrina o pozo ciego)

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– alumbrado público

Como acceso encontramos:
– terracería (vehicular o vecinal)
– adoquín
– carrileras de concreto (vehicular o vecinal)`,
        variants: [
          {
            id: "baja-media-1",
            title: "Tipología Media - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/tipolog%C3%ADa%20media.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/interior%20tipolog%C3%ADa%20media.png?raw=true",
            pricePerM2: 750,
            bullets: [
              "Estructura: sistema de adobe, block con pines fundidos",
              "Paredes: adobe con repello",
              "Techos: lámina de zinc con cielo falso de machimbre",
              "Piso: torta de cemento líquido, cerámico",
              "Ventanas: madera sin tratar",
              "Puertas: madera sin tratar",
              "Servicios: agua, luz, alumbrado público",
              "Exterior: fachada tipo corredor",
              "Instalaciones: expuestas",
              "Rango de precios: Q650.00/m² a Q750.00/m²"
            ]
          },
          {
            id: "baja-media-2",
            title: "Tipología Media - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/tipolog%C3%ADa%20media%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/interior%20tipolog%C3%ADa%20media%202.png?raw=true",
            pricePerM2: 850,
            bullets: [
              "Estructura: mampostería con columnas",
              "Paredes: block de cantera",
              "Techos: lámina de zinc",
              "Piso: torta de cemento líquido",
              "Ventanas: madera sin tratar",
              "Puertas: metal y madera sin tratar",
              "Servicios: agua, luz, drenajes",
              "Exterior: fachada sin ventanas ni diseño",
              "Instalaciones: expuestas",
              "Rango de precios: Q650.00/m² a Q850.00/m²"
            ]
          }
        ]
      },
      {
        category: "Baja",
        type: "Alta",
        generalDescription: 

`Como sistema constructivo encontramos:
– estructura de madera
– mampostería con sistema estructural pineado a cada 0.60 metros
– mampostería con columnas para un nivel
– mampostería con columnas para dos niveles (sin diseño estructural específico)

Como recubrimiento de paredes encontramos:
– adobe
– block normado estructuralmente para la construcción
– block de cantera sin norma de construcción

Como acabados interiores y exteriores:
– block sisado visto
– blanqueado con cal hidratada
– pintura sobre el block visto
– capa delgada de repello y cernido

Como cubierta encontramos:
– estructura de madera con cubierta de lámina de zinc
– estructura de costaneras de metal con cubierta de lámina de zinc
– estructura de madera cubierta con teja de barro
– losa de concreto armado

Como cielo falso encontramos:
– machimbré
– plywood

Como piso encontramos:
– granito
– cemento líquido
– cerámico

Como puertas y ventanas encontramos:
– madera sin tratar
– metal
– uPVC

Como diseño arquitectónico encontramos:
– casas diseñadas en tres ambientes
– casas diseñadas en cuatro ambientes
– baño simples en interior de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– alumbrado público
– drenaje

Como acceso encontramos:
– terracería
– adoquín
– carrileras de concreto
– pavimento de concreto`,
        variants: [
          {
            id: "baja-alta-1",
            title: "Tipología Alta - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/tipolog%C3%ADa%20alta.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/interior%20tipolog%C3%ADa%20alta.png?raw=true",
            pricePerM2: 950,
            bullets: [
              "Estructura: mampostería con pines fundidos a 0.60 metros",
              "Paredes: block de cantera con pintura",
              "Techos: lámina troquelada",
              "Piso: torta de cemento líquido",
              "Ventanas: metal, madera sin tratar",
              "Puertas: metal, madera sin tratar",
              "Servicios: agua, luz, drenajes",
              "Exterior: fachada a dos aguas",
              "Instalaciones: ocultas",
              "Rango de precios: Q850.00/m² a Q950.00/m²"
            ]
          },
          {
            id: "baja-alta-2",
            title: "Tipología Alta - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/tipolog%C3%ADa%20alta%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20baja/interior%20tipolog%C3%ADa%20alta%202.png?raw=true",
            pricePerM2: 1000,
            bullets: [
              "Estructura: sistema de adobe, mampostería reforzada",
              "Paredes: adobe con repello y cernido, block normado",
              "Techos: teja de barro, lámina de zinc, cielo falso de madera",
              "Piso: torta de cemento líquido, granito",
              "Ventanas: madera sin tratar, metal, uPVC",
              "Puertas: madera sin tratar, metal",
              "Servicios: agua, luz, drenajes",
              "Exterior: fachada tipo corredor",
              "Instalaciones: ocultas, expuestas",
              "Rango de precios: Q850.00/m² a Q1,000.00/m²"
            ]
          }
        ]
      },
      {
        category: "Media",
        type: "Baja",
        generalDescription: 

`Como sistema constructivo encontramos:
– sistema de mampostería reforzada
– sistema de block pineado a cada 60 centímetros
– algunas reforzadas para segundo nivel

Como recubrimiento de paredes encontramos:
– block de cantera fabricado sin norma
– block normado

Como acabados interiores y exteriores:
– block sisado visto
– pintura o blanqueado
– repello y cernido con capa delgada

Como cubierta encontramos:
– techo de losa de concreto
– estructura de metal cubierta con lámina de zinc o lámina troquelada
– estructura de madera cubierta con lámina de zinc

Como piso encontramos:
– cerámico
– granito

Como puertas y ventanas encontramos:
– madera
– metal
– prefabricados
– aluminio

Como diseño arquitectónico encontramos:
– casas sin presencia de diseño arquitectónico
– casas con jardín o patio
– casas con el baño dentro de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– drenajes

Como acceso encontramos:
– adoquín
– pavimento
– asfalto`,
        variants: [
          {
            id: "media-baja-1",
            title: "Tipología Baja - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/tipolog%C3%ADa%20baja.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/interior%20tipolog%C3%ADa%20baja.png?raw=true",
            pricePerM2: 1100,
            bullets: [
              "Estructura: mampostería con block con pines fundidos",
              "Paredes: block con repello y cernido",
              "Techo: lámina de zinc sin cielo falso",
              "Piso: torta de cemento líquido",
              "Ventanas: madera tratada",
              "Puertas: madera tratada, metal",
              "Servicios: agua, luz, drenajes",
              "Exterior: fachada tipo corredor",
              "Instalaciones: sobrepuestas",
              "Rango de precios: Q800.00/m² a Q1,100.00/m²"
            ]
          },
          {
            id: "media-baja-2",
            title: "Tipología Baja - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/tipolog%C3%ADa%20baja%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/interior%20tipolog%C3%ADa%20baja%202.png?raw=true",
            pricePerM2: 1100,
            bullets: [
              "Estructura: mampostería con columnas para un nivel",
              "Paredes: block sisado visto, partes con repello y pintura",
              "Techo: tejas de barro, lámina de zinc con cielo falso de madera",
              "Piso: torta de cemento líquido",
              "Ventanas: metal, madera tratada",
              "Puertas: metal, madera tratada",
              "Servicios: agua, luz, drenajes",
              "Exterior: fachada sin diseño arquitectónico",
              "Instalaciones: sobrepuestas",
              "Rango de precios: Q800.00/m² a Q1,100.00/m²"
            ]
          }
        ]
      },
      {
        category: "Media",
        type: "Media",
        generalDescription: 

`Como sistema constructivo encontramos:
– sistema de mampostería reforzada
– sistema de block pineado a cada 60 centímetros
– algunas reforzadas para segundo nivel

Como recubrimiento de paredes encontramos:
– block de cantera fabricado sin norma
– block normado

Como acabados interiores y exteriores:
– block sisado visto
– pintura o blanqueado
– repello y cernido con capa delgada

Como cubierta encontramos:
– techo de losa de concreto
– estructura de metal cubierta con lámina de zinc o lámina troquelada
– estructura de madera cubierta con lámina de zinc

Como piso encontramos:
– cerámico
– granito

Como puertas y ventanas encontramos:
– madera
– metal
– prefabricados
– aluminio

Como diseño arquitectónico encontramos:
– casas sin presencia de diseño arquitectónico
– casas con jardín o patio
– casas con el baño dentro de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– drenajes

Como acceso encontramos:
– adoquín
– pavimento
– asfalto`,
        variants: [
          {
            id: "media-media-1",
            title: "Tipología Media - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/tipolog%C3%ADa%20media.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/interior%20tipolog%C3%ADa%20media.png?raw=true",
            pricePerM2: 1200,
            bullets: [
              "Estructura: mampostería reforzada para un nivel",
              "Paredes: block con repello y cernido",
              "Techo: estructura de metal con lámina troquelada",
              "Piso: torta de cemento líquido",
              "Ventanas: metal",
              "Puertas: metal",
              "Servicios: agua, luz, drenajes",
              "Exterior: fachada tipo corredor interno",
              "Instalaciones: sobrepuestas o semi ocultas",
              "Rango de precios: Q900.00/m² a Q1,200.00/m²"
            ]
          },
          {
            id: "media-media-2",
            title: "Tipología Media - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/tipolog%C3%ADa%20media%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/interior%20tipolog%C3%ADa%20media%202.png?raw=true",
            pricePerM2: 1300,
            bullets: [
              "Estructura: mampostería reforzada para un nivel",
              "Paredes: block normado con repello y cernido, pintura",
              "Techo: madera con lámina de zinc sin cielo falso",
              "Piso: granito, torta de cemento líquido",
              "Ventanas: metal con balcones",
              "Puertas: metal",
              "Servicios: agua, luz, drenajes, cable de TV",
              "Exterior: fachada tradicional sin diseño arquitectónico",
              "Instalaciones: ocultas, semi-ocultas",
              "Rango de precios: Q1,000.00/m² a Q1,300.00/m²"
            ]
          }
        ]
      },
      {
        category: "Media",
        type: "Alta",
        generalDescription: 

`Como sistema constructivo encontramos:
– sistema de mampostería reforzada
– sistema de combinación de columnas con vigas de carga
– algunas reforzadas para segundo nivel

Como recubrimiento de paredes encontramos:
– block de cantera fabricado sin norma
– block normado

Como acabados interiores y exteriores:
– pintura o blanqueado
– repello y cernido

Como cubierta encontramos:
– techo de losa de concreto
– estructura de metal cubierta con lámina de zinc o lámina troquelada

Como piso encontramos:
– cerámico
– porcelanato
– granito

Como puertas y ventanas encontramos:
– madera
– metal
– prefabricadas
– aluminio
– uPVC

Como diseño arquitectónico encontramos:
– casas sin presencia de diseño arquitectónico
– casas con jardín o patio
– casas con el baño dentro de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– drenajes
– internet
– teléfono
– cable de TV

Como acceso encontramos:
– adoquín
– pavimento
– asfalto`,
        variants: [
          {
            id: "media-alta-1",
            title: "Tipología Alta - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/tipolog%C3%ADa%20alta.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/interior%20tipolog%C3%ADa%20alta.png?raw=true",
            pricePerM2: 1700,
            bullets: [
              "Estructura: mampostería reforzada con columnas para dos niveles",
              "Paredes: ladrillo sisado visto, pintura",
              "Techo: losa de concreto armado",
              "Piso: granito",
              "Ventanas: metal, madera tratada",
              "Puertas: madera tratada, metal",
              "Servicios: agua, luz, drenajes, cable de TV",
              "Exterior: fachada típica de casas de ladrillo",
              "Instalaciones: ocultas",
              "Rango de precios: Q1,300.00/m² a Q1,700.00/m²"
            ]
          },
          {
            id: "media-alta-2",
            title: "Tipología Alta - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/tipolog%C3%ADa%20alta%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20media/interior%20tipolog%C3%ADa%20alta%202.png?raw=true",
            pricePerM2: 1800,
            bullets: [
              "Estructura: mampostería reforzada con pines para un nivel",
              "Paredes: block normado con repello, alisado, pintura",
              "Techo: costaneras de metal con lámina de zinc, sin cielo falso",
              "Piso: cerámico",
              "Ventanas: metal con balcones",
              "Puertas: metal y madera tratada",
              "Servicios: luz, agua, drenaje, cable de TV",
              "Exterior: fachada con diseño tipo colonial",
              "Instalaciones: ocultas",
              "Rango de precios: Q1,400.00/m² a Q1,800.00/m²"
            ]
          }
        ]
      },
      {
        category: "Alta",
        type: "Baja",
        generalDescription:

`Como sistema constructivo encontramos:
– sistema de mampostería reforzada
– combinación de columnas–vigas con sistema de muros de carga
– columnas de concreto reforzado

Como recubrimiento de paredes encontramos:
– block de cantera fabricado sin norma
– block normado

Como cubierta encontramos:
– losa de concreto
– lámina en algunas áreas o segundo nivel

Como piso encontramos:
– cerámico
– granito
– porcelanato
– laminados

Como puertas y ventanas encontramos:
– madera
– metal
– prefabricadas
– aluminio
– uPVC

Como diseño arquitectónico encontramos:
– casas con un estudio en su diseño arquitectónico
– casas con jardín o patio
– casas con el baño dentro de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– drenajes
– teléfono
– internet
– cable de TV

Como acceso encontramos:
– adoquín
– pavimento
– asfalto`,
        variants: [
          {
            id: "alta-baja-1",
            title: "Tipología Baja - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/tipolog%C3%ADa%20baja.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/interior%20tipolog%C3%ADa%20baja.png?raw=true",
            pricePerM2: 1700,
            bullets: [
              "Estructura: columnas y paredes de carga",
              "Paredes: repello, alisado, pintura",
              "Techo: losa de concreto o losa prefabricada",
              "Piso: cerámico, granito o porcelanato",
              "Ventanas: ventanas de aluminio o PVC",
              "Puertas: madera, metal y prefabricadas",
              "Servicios: agua, luz, drenajes, cable de TV",
              "Exterior: fachada tipo corredor, pintura",
              "Instalaciones: ocultas",
              "Rango de precios: Q1,400.00/m² a Q1,700.00/m²"
            ]
          },
          {
            id: "alta-baja-2",
            title: "Tipología Baja - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/tipologia%20baja%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/interior%20tipologia%20baja%202.png?raw=true",
            pricePerM2: 1800,
            bullets: [
              "Estructura: columnas y paredes de carga",
              "Paredes: repello, alisado, pintura",
              "Techo: losa de concreto o losa prefabricada",
              "Piso: cerámico, granito o porcelanato",
              "Ventanas: ventanas de aluminio o PVC",
              "Puertas: madera, metal y prefabricadas",
              "Exterior: fachada con acabados y pintura",
              "Instalaciones: ocultas",
              "Rango de precios: Q1,500.00/m² a Q1,800.00/m²"
            ]
          }
        ]
      },
      {
        category: "Alta",
        type: "Media",
        generalDescription: 
`Como sistema constructivo encontramos:
– sistema de mampostería reforzada
– combinación de columnas–vigas con sistema de muros de carga
– columnas de concreto reforzado

Como recubrimiento de paredes encontramos:
– block de cantera fabricado sin norma
– block normado

Como cubierta encontramos:
– techo de losa de concreto
– techo de lámina en algunas áreas o segundo nivel

Como piso en este tipo de construcción encontramos:
– cerámico
– granito
– porcelanato
– laminado

Como puertas y ventanas encontramos:
– madera
– prefabricadas
– metal
– aluminio
– uPVC

Como diseño arquitectónico encontramos:
– casas con un estudio en su diseño arquitectónico
– casas con jardín o patio
– casas con el baño dentro de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– drenajes
– teléfono
– internet
– cable de TV

Como acceso encontramos:
– calles de adoquín
– pavimento
– asfalto`,
        variants: [
          {
            id: "alta-media-1",
            title: "Tipología Media - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/tipolog%C3%ADa%20media.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/interior%20tipologia%20media.png?raw=true",
            pricePerM2: 2100,
            bullets: [
              "Estructura: mampostería reforzada con columnas para dos niveles",
              "Paredes: block normado con repello, alisado, pintura",
              "Techo: losa de concreto, losa prefabricada",
              "Piso: cerámico, granito, porcelanato",
              "Ventanas: aluminio, uPVC",
              "Puertas: madera tratada, metal, prefabricadas",
              "Servicios: agua, luz, drenajes, cable de TV, internet",
              "Exterior: fachada con detalles arquitectónicos",
              "Instalaciones: ocultas",
              "Rango de precios: Q1,800.00/m² a Q2,100.00/m²"
            ]
          },
          {
            id: "alta-media-2",
            title: "Tipología Media - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/tipologia%20media%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/interior%20tipologia%20media%202.png?raw=true",
            pricePerM2: 2200,
            bullets: [
              "Estructura: mampostería reforzada con columnas para dos niveles",
              "Paredes: block normado con repello, alisado, pintura",
              "Techo: losa de concreto, losa prefabricada",
              "Piso: cerámico, granito, porcelanato",
              "Ventanas: aluminio, uPVC",
              "Puertas: madera tratada, metal, prefabricadas",
              "Servicios: agua, luz, drenajes, cable de TV, internet",
              "Exterior: fachada con diseño arquitectónico",
              "Instalaciones: ocultas",
              "Rango de precios: Q1,900.00/m² a Q2,200.00/m²"
            ]
          }
        ]
      },
      {
        category: "Alta",
        type: "Alta",
        generalDescription:
`Como sistema constructivo encontramos:
– sistema de mampostería reforzada
– combinación de columnas–vigas con sistema de muros de carga
– columnas de concreto reforzado

Como recubrimiento de paredes encontramos:
– block de cantera fabricado sin norma
– block normado

Como cubierta encontramos:
– techo de losa de concreto
– techo de lámina en algunas áreas o segundo nivel

Como piso en este tipo de construcción encontramos:
– cerámico
– granito
– porcelanato
– laminados

Como puertas y ventanas encontramos:
– madera
– prefabricadas
– metal
– aluminio
– uPVC

Como diseño arquitectónico encontramos:
– casas con un estudio en su diseño arquitectónico
– casas con jardín o patio
– casas con el baño dentro de la vivienda

Como servicios básicos encontramos:
– agua potable
– energía eléctrica
– drenajes
– teléfono
– internet
– cable de TV

Como acceso encontramos:
– adoquín
– pavimento
– asfalto`,
        variants: [
          {
            id: "alta-alta-1",
            title: "Tipología Alta - Variante 1",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/tipolog%C3%ADa%20alta.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/interior%20tipologia%20alta.png?raw=true",
            pricePerM2: 2800,
            bullets: [
              "Estructura: mampostería reforzada con columnas para dos niveles",
              "Paredes: block normado con repello, alisado, pintura",
              "Techo: losa de concreto, losa prefabricada, losas inclinadas",
              "Piso: cerámico, porcelanato",
              "Ventanas: uPVC, aluminio",
              "Puertas: madera tratada, metal, prefabricadas",
              "Servicios: agua, luz, drenajes, cable de TV, internet",
              "Exterior: fachada con diseño arquitectónico",
              "Instalaciones: ocultas",
              "Rango de precios: Q2,300.00/m² a Q2,800.00/m²"
            ]
          },
          {
            id: "alta-alta-2",
            title: "Tipología Alta - Variante 2",
            img: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/tipologia%20alta%202.png?raw=true",
            imgInterior: "https://github.com/Senseifizz7/Calcula-Aval-os/blob/main/categoria%20alta/interior%20tipologia%20alta%202.png?raw=true",
            pricePerM2: 2900,
            bullets: [
              "Estructura: mampostería reforzada con columnas para dos niveles",
              "Paredes: block normado con repello, alisado, pintura",
              "Techo: losa de concreto, losa prefabricada, losas inclinadas",
              "Piso: cerámico, porcelanato",
              "Ventanas: uPVC, aluminio",
              "Puertas: madera tratada, metal, prefabricadas",
              "Servicios: agua, luz, drenajes, cable de TV, internet",
              "Exterior: fachada con diseño arquitectónico",
              "Instalaciones: ocultas",
              "Rango de precios: Q2,500.00/m² a Q2,900.00/m²"
            ]
          }
        ]
      }
    ];

    function __getTipos(){try{return Array.isArray(window.TIPOLOGIAS)&&window.TIPOLOGIAS.length?window.TIPOLOGIAS:__FALLBACK_TIPOLOGIAS;}catch{return __FALLBACK_TIPOLOGIAS;}}


function llenarSelectsTipologias() {
  const selects = document.querySelectorAll('.tipo-construccion-select');
  const tipologias = __getTipos();
  
  
  selects.forEach(select => {
    select.innerHTML = '<option value="">Seleccionar tipología</option>';
  });
  
  s
  tipologias.forEach(tipologia => {
    tipologia.variants.forEach(variante => {
      const option = document.createElement('option');
      option.value = variante.id;
      option.textContent = `${tipologia.category} - ${tipologia.type}: ${variante.title} (Q${variante.pricePerM2}/m²)`;
      option.dataset.precio = variante.pricePerM2;
      
      selects.forEach(select => {
        select.appendChild(option.cloneNode(true));
      });
    });
  });
}


function actualizarValorBaseDesdeTipologia(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  const precio = selectedOption.dataset.precio;
  const row = selectElement.closest('tr');
  const vbaseInput = row.querySelector('.vbase-input');
  
  if (precio && vbaseInput) {
    vbaseInput.value = precio;
    
    recalcularFila(row);
    recalcularTablaConstruccion();
    integrarValores();
  }
}
    function __renderTipos(){
      const tipologias = __getTipos();
      
      
      const grouped = tipologias.reduce((acc, tipologia) => {
        if (!acc[tipologia.category]) {
          acc[tipologia.category] = {};
        }
        if (!acc[tipologia.category][tipologia.type]) {
          acc[tipologia.category][tipologia.type] = [];
        }
        acc[tipologia.category][tipologia.type].push(tipologia);
        return acc;
      }, {});

      
      ['baja', 'media', 'alta'].forEach(categoria => {
        const tabContent = document.getElementById(`tab-${categoria}`);
        if (!tabContent) return;

        let html = '';
        const tipos = grouped[categoria.charAt(0).toUpperCase() + categoria.slice(1)];
        
        if (!tipos) {
          html = '<div style="padding: 40px; text-align: center; color: var(--text-light);"><i class="fas fa-home" style="font-size: 3rem; margin-bottom: 16px;"></i><p>No hay tipologías disponibles para esta categoría</p></div>';
        } else {
          
          const tipoOrder = ['Baja', 'Media', 'Alta'];
          tipoOrder.forEach(tipo => {
            if (tipos[tipo]) {
              const tipologia = tipos[tipo][0]; 
              const rango = RANGOS_PRECIO[categoria.charAt(0).toUpperCase() + categoria.slice(1)]?.[tipo] || { min: 0, max: 0 };
              const rangoTexto = `Q${rango.min.toLocaleString('es-GT')}–Q${rango.max.toLocaleString('es-GT')}/m²`;
              
              html += `
                <div class="typology-accordion">
                  <button class="typology-accordion-header" onclick="__updateBreadcrumbs('${categoria.charAt(0).toUpperCase() + categoria.slice(1)}', '${tipo}')">
                    <span>Tipología ${tipo} - ${rangoTexto}</span>
                    <i class="fas fa-chevron-down typology-accordion-icon"></i>
                  </button>
                  <div class="typology-accordion-content">
                    <!-- DESCRIPCIÓN GENERAL DE LA TIPOLOGÍA -->
                    <div style="padding: 20px; background: rgba(91, 123, 122, 0.03); border-bottom: 1px solid var(--border-light);">
                      <div style="font-weight: 600; color: var(--primary); margin-bottom: 12px; font-size: 1.1rem;">
                        Descripción General - Tipología ${tipo}
                      </div>
                      <div style="white-space: pre-line; font-size: 0.9rem; line-height: 1.5; color: var(--text);">
                        ${tipologia.generalDescription}
                      </div>
                    </div>
                    
                    <div class="typology-variants">
              `;
              
              
              tipologia.variants.forEach((variante, index) => {
                html += `
                  <div class="typology-variant" data-id="${variante.id}">
                    <div class="variant-images">
                      <img class="variant-image" src="${variante.img}" alt="${variante.title}" onclick="event.stopPropagation(); openImageModal('${variante.img}', '${variante.title}')">
                      ${variante.imgInterior ? `<img class="variant-image" src="${variante.imgInterior}" alt="Interior ${variante.title}" onclick="event.stopPropagation(); openImageModal('${variante.imgInterior}', 'Interior ${variante.title}')">` : ''}
                    </div>
                    <div class="variant-content">
                      <div class="variant-details">
                        <div class="variant-title">${variante.title}</div>
                        <div class="variant-price">Q${variante.pricePerM2.toLocaleString('es-GT')}/m²</div>
                        
                        <ul class="variant-features">
                          ${variante.bullets.map(bullet => `<li><i class="fas fa-check"></i>${bullet}</li>`).join('')}
                        </ul>
                        
                        <button class="select-button" onclick="event.stopPropagation(); __selectTipo('${variante.id}')">
                          <i class="fas fa-hand-pointer"></i> Seleccionar esta variante
                        </button>
                      </div>
                    </div>
                  </div>
                `;
              });
              
              html += `
                    </div>
                  </div>
                </div>
              `;
            }
          });
        }
        
        tabContent.innerHTML = html;
      });

      
      initAccordions();
      
      
      __updateBreadcrumbs('Baja', '');
    }

    function initAccordions() {
      document.querySelectorAll('.typology-accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          const accordion = header.parentElement;
          const content = header.nextElementSibling;
          
          
          const tab = accordion.closest('.typology-tab-content');
          tab.querySelectorAll('.typology-accordion').forEach(acc => {
            if (acc !== accordion) {
              acc.querySelector('.typology-accordion-header').classList.remove('active');
              acc.querySelector('.typology-accordion-content').classList.remove('active');
            }
          });
          
          
          header.classList.toggle('active');
          content.classList.toggle('active');
        });
      });
    }

    function initTabs() {
      document.querySelectorAll('.typology-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          const categoryName = tabName.charAt(0).toUpperCase() + tabName.slice(1);
          
          
          __updateBreadcrumbs(categoryName, '');
          
          
          document.querySelectorAll('.typology-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.typology-tab-content').forEach(c => c.classList.remove('active'));
          
          
          tab.classList.add('active');
          document.getElementById(`tab-${tabName}`).classList.add('active');
        });
      });
    }

    function __selectTipo(id) {
      
      const tipologias = __getTipos();
      let varianteSeleccionada = null;
      let tipologiaPadre = null;
      
      for (const tipologia of tipologias) {
        const variante = tipologia.variants.find(v => v.id === id);
        if (variante) {
          varianteSeleccionada = variante;
          tipologiaPadre = tipologia;
          break;
        }
      }
      
      if (!varianteSeleccionada || !tipologiaPadre) return;
      
      const rango = RANGOS_PRECIO[tipologiaPadre.category]?.[tipologiaPadre.type] || { min: 500, max: 1000 };
      const rangoTexto = `Q${rango.min.toLocaleString('es-GT')}–Q${rango.max.toLocaleString('es-GT')}/m²`;
      
      const img = document.getElementById('selectedImage');
      const tp = document.getElementById('selectedType');
      const ti = document.getElementById('selectedTitle');
      const pr = document.getElementById('selectedPrice');
      const hd = document.getElementById('typology');
      
      if (img) img.src = varianteSeleccionada.img;
      if (tp) tp.textContent = `Categoría ${tipologiaPadre.category} — ${tipologiaPadre.type}`;
      if (ti) ti.textContent = varianteSeleccionada.title;
      if (pr) pr.textContent = rangoTexto;
      if (hd) hd.value = varianteSeleccionada.id;
      
      varianteSeleccionada.pricePerM2 = varianteSeleccionada.pricePerM2 || rango.max;
      
      if (document.getElementById('resultSection').classList.contains('active')) {
          calculateRealAppraisal();
      }
      
      __closeTypology();
    }

    function __openTypology(){
      const m = document.getElementById('catalogModal');
      const t = document.getElementById('typologyTrigger');
      if(!m) return alert('No se encontró el modal (#catalogModal).');
      m.classList.add('active');
      t?.classList.add('active');
      __renderTipos();
      initTabs();
      
      const hb = e => {
        if(e.target === m){
          __closeTypology();
          m.removeEventListener('click', hb);
        }
      };
      m.addEventListener('click', hb);
      const x = document.getElementById('closeModal');
      if(x) x.onclick = __closeTypology;
    }

    function __closeTypology(){
      const m = document.getElementById('catalogModal');
      const t = document.getElementById('typologyTrigger');
      if(!m) return;
      m.classList.remove('active');
      t?.classList.remove('active');
    }

    window.__openTypology = __openTypology; 
    window.__closeTypology = __closeTypology;

    
    function openImageModal(imageSrc, imageAlt) {
      const modal = document.getElementById('image-viewer-modal');
      const fullSizeImage = document.getElementById('full-size-image');
      
      if (modal && fullSizeImage) {
        fullSizeImage.src = imageSrc;
        fullSizeImage.alt = imageAlt || 'Imagen del catálogo';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeImageViewer() {
      const modal = document.getElementById('image-viewer-modal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    function initImageModalEvents() {
      const modal = document.getElementById('image-viewer-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal || e.target.classList.contains('modal-close')) {
            closeImageViewer();
          }
        });
      }
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeImageViewer();
        }
      });
    }

    
    function initImageUpload() {
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('image-upload');
      const previewContainer = document.getElementById('image-preview');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });
    }

    function handleFiles(files) {
      const previewContainer = document.getElementById('image-preview');
      
      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) {
          alert('Solo se permiten archivos de imagen');
          return;
        }

        if (file.size > 25 * 1024 * 1024) {
          alert('La imagen es demasiado grande. Máximo 25MB.');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-preview-item';
          imageItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="image-preview-remove" onclick="this.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
            <div class="image-preview-info">${file.name}</div>
          `;
          previewContainer.appendChild(imageItem);
        };
        reader.readAsDataURL(file);
      });
    }

    
    function __openTypologyForConstruction(typologyElement) {
      
      window.currentConstructionTypologyElement = typologyElement;
      
      const originalSelectTipo = window.__selectTipo;
      
      
      window.__selectTipo = function(id) {
        const tipologias = __getTipos();
        let varianteSeleccionada = null;
        let tipologiaPadre = null;
        
        
        for (const tipologia of tipologias) {
          const variante = tipologia.variants.find(v => v.id === id);
          if (variante) {
            varianteSeleccionada = variante;
            tipologiaPadre = tipologia;
            break;
          }
        }
        
        if (!varianteSeleccionada || !tipologiaPadre) return;
        
       
        const trigger = window.currentConstructionTypologyElement.querySelector('.typology-trigger');
        const hiddenInput = window.currentConstructionTypologyElement.parentElement.querySelector('.typology-id-input');
        const vbaseInput = window.currentConstructionTypologyElement.closest('tr').querySelector('.vbase-input');
        
        if (trigger && hiddenInput && vbaseInput) {
          const img = trigger.querySelector('.selected-image');
          const tp = trigger.querySelector('.selected-type');
          const ti = trigger.querySelector('.selected-title');
          const pr = trigger.querySelector('.selected-price');
          
          if (img) img.src = varianteSeleccionada.img;
          if (tp) tp.textContent = `Categoría ${tipologiaPadre.category} — ${tipologiaPadre.type}`;
          if (ti) ti.textContent = varianteSeleccionada.title;
          if (pr) pr.textContent = `Q${varianteSeleccionada.pricePerM2}/m²`;
          if (hiddenInput) hiddenInput.value = varianteSeleccionada.id;
          
          
          vbaseInput.value = varianteSeleccionada.pricePerM2 || varianteSeleccionada.pricePerM2;
          
          
          const row = window.currentConstructionTypologyElement.closest('tr');
          recalcularFila(row);
          recalcularTablaConstruccion();
          integrarValores();
        }
        
        
        __closeTypology();
        window.__selectTipo = originalSelectTipo;
        window.currentConstructionTypologyElement = null;
      };
      
      
      __openTypology();
    }

  </script>

  
  <script>
    function formatMoneyGTQ(v){
      return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ',minimumFractionDigits:2}).format(Number(v||0));
    }

    function recalcularFila(tr){
      const area = parseFloat(tr.querySelector('.area-input')?.value)||0;
      const vbase = parseFloat(tr.querySelector('.vbase-input')?.value)||0;
      const coef = parseFloat(tr.querySelector('.coef-input')?.value)||0;
      const monto = area * vbase * coef;
      const out = tr.querySelector('.monto-output');
      if(out){ out.value = monto.toFixed(2); }
      return monto;
    }

    function recalcularTablaConstruccion(){
  const rows = Array.from(document.querySelectorAll('#tbBodyConstruccion tr'));
  let total = 0, sumaArea = 0;
  
  rows.forEach(tr=>{
    total += recalcularFila(tr);
    const area = parseFloat(tr.querySelector('.area-input')?.value)||0;
    sumaArea += area;
  });
  
  const totalEl = document.getElementById('totalConstruccion');
  if(totalEl) totalEl.value = total.toFixed(2);

  if(document.getElementById('resultSection').classList.contains('active')){
    document.getElementById('resultBuildValue').textContent = formatMoneyGTQ(total);
    
    const fallbackArea = parseFloat(document.getElementById('construction-area').value)||0;
    const areaMostrar = (sumaArea>0? sumaArea : fallbackArea).toFixed(2);
    document.getElementById('resultArea').textContent = `${areaMostrar} m²`;

    
    const tipologiasSeleccionadas = [];
    rows.forEach(tr => {
      const hiddenInput = tr.querySelector('.typology-id-input');
      if (hiddenInput && hiddenInput.value) {
        const tipologias = __getTipos();
        for (const tipologia of tipologias) {
          const variante = tipologia.variants.find(v => v.id === hiddenInput.value);
          if (variante) {
            tipologiasSeleccionadas.push(`${tipologia.category}-${tipologia.type}`);
            break;
          }
        }
      }
    });
    
    const tipText = tipologiasSeleccionadas.length > 0 ? 
      tipologiasSeleccionadas.join(' | ') : 'No seleccionada';
    document.getElementById('resultTypology').textContent = tipText;

    const estado = document.getElementById('estado-inmueble').value || 'No especificado';
    document.getElementById('resultCondition').textContent = estado;

    const anioConstruccion=parseInt(document.getElementById('anio-construccion').value)||0;
    const antiguedad = anioConstruccion? (new Date().getFullYear()-anioConstruccion) : 0;
    document.getElementById('resultAge').textContent = `${antiguedad} años`;

    const land=parseFloat(document.getElementById('totalTerreno')?.value)||0;
    document.getElementById('resultLandValue').textContent = formatMoneyGTQ(land);
    document.getElementById('resultLandAppraisal').textContent = formatMoneyGTQ(land);
    document.getElementById('resultGrandTotal').textContent = formatMoneyGTQ(land + total);
    document.getElementById('resultTotal').textContent = formatMoneyGTQ(land + total);
  }
}
    function bindRowEvents(tr){
  ['input','change'].forEach(evt=>{
    tr.addEventListener(evt, e=>{
      if(e.target.matches('.area-input,.vbase-input,.coef-input')){
        recalcularTablaConstruccion();
        integrarValores(); 
      }
    });
  });
}
   function agregarFilaConstruccion() {
  const tbody = document.getElementById('tbBodyConstruccion');
  const n = tbody.querySelectorAll('tr').length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="Nivel ${n}" class="planta-input"></td>
    <td><input type="number" min="0" step="0.01" class="area-input" placeholder="0"></td>
    <td><input type="number" min="0" step="0.01" class="vbase-input" placeholder="0"></td>
    <td><input type="number" min="0" step="0.01" value="1" class="coef-input"></td>
    <td>
      <div class="typology-selector" onclick="__openTypologyForConstruction(this)">
        <div class="typology-trigger">
          <img class="selected-image" src="https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=200&q=60" alt="Tipología" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
          <div class="selected-text">
            <div class="selected-type">Catálogo</div>
            <div class="selected-title">Pulsa para elegir tipología</div>
            <div class="selected-price">—</div>
          </div>
        </div>
      </div>
      <input type="hidden" class="typology-id-input" value="">
    </td>
    <td><input type="text" class="monto-output" value="0.00" readonly></td>
  `;
  tbody.appendChild(tr);
  
  
  bindRowEvents(tr);
  
  console.log(`✅ Nivel ${n} agregado con catálogo funcional`);
}
    
    function eliminarUltimaFilaConstruccion(){
      const tbody = document.getElementById('tbBodyConstruccion');
      const rows = tbody.querySelectorAll('tr');
      if(rows.length>1){
        tbody.removeChild(rows[rows.length-1]);
        recalcularTablaConstruccion();
        integrarValores(); 
      }
    }

   document.addEventListener('DOMContentLoaded', () => {
  
  const firstRow = document.querySelector('#tbBodyConstruccion tr');
  if (firstRow) bindRowEvents(firstRow);
});
  </script>

  <script>
    function recalcularTerreno() {
      const row = document.querySelector('#tablaTerreno tbody tr');
      if (!row) return 0;

      const num = (sel) => {
        const value = row.querySelector(sel)?.value;
        return value === '' ? 0 : parseFloat(value) || 0;
      };

      const fac = (sel) => {
        const v = parseFloat(row.querySelector(sel)?.value);
        return isNaN(v) || v <= 0 ? 1 : v;
      };

      let area = num('.t-area');

      const vbase = num('.t-vbase');
      const ffte  = fac('.t-ffte');
      const ffdo  = fac('.t-ffdo');
      const ffma  = fac('.t-ffma');
      const fext  = fac('.t-fext');
      const fotros= fac('.t-fotros');

      const monto = area * vbase * ffte * ffdo * ffma * fext * fotros;

      const out = document.getElementById('t-monto');
      if (out) out.value = monto.toFixed(2);

      const totalTerrenoEl = document.getElementById('totalTerreno');
      if (totalTerrenoEl) totalTerrenoEl.value = monto.toFixed(2);

      const ivTerrenoEl = document.getElementById('ivTerreno');
      if (ivTerrenoEl) ivTerrenoEl.textContent = formatMoneyGTQ(monto);

      if (document.getElementById('resultSection').classList.contains('active')) {
        document.getElementById('resultLandValue').textContent = formatMoneyGTQ(monto);
        document.getElementById('resultLandAppraisal').textContent = formatMoneyGTQ(monto);
      }

      return monto;
    }

    function integrarValores() {
      const terreno = parseFloat(document.getElementById('totalTerreno')?.value) || 0;
      const construccion = parseFloat(document.getElementById('totalConstruccion')?.value) || 0;
      const total = terreno + construccion;

      const ivT = document.getElementById('ivTerreno');
      const ivConst = document.getElementById('ivConstruccion');
      const ivTot = document.getElementById('ivTotal');
      if (ivT) ivT.textContent = formatMoneyGTQ(terreno);
      if (ivConst) ivConst.textContent = formatMoneyGTQ(construccion);
      if (ivTot) ivTot.textContent = formatMoneyGTQ(total);

      if (document.getElementById('resultSection').classList.contains('active')) {
        document.getElementById('resultGrandTotal').textContent = formatMoneyGTQ(total);
        document.getElementById('resultTotal').textContent = formatMoneyGTQ(total);
        document.getElementById('resultBuildValue').textContent = formatMoneyGTQ(construccion);
      }
    }

    const __origCalculateRealAppraisal = window.calculateRealAppraisal;
    window.calculateRealAppraisal = function() {
      if (typeof __origCalculateRealAppraisal === 'function') {
        __origCalculateRealAppraisal();
      }
      recalcularTerreno();
      integrarValores();
    };

    document.addEventListener('DOMContentLoaded', () => {
      const row = document.querySelector('#tablaTerreno tbody tr');
      if (row) {
        row.querySelectorAll('input').forEach(inp => {
          ['input','change'].forEach(evt => {
            inp.addEventListener(evt, () => {
              recalcularTerreno();
              integrarValores();
            });
          });
        });
      }
     
      recalcularTerreno();
      integrarValores();
    });
  </script>

  <script>
    let gMap=null,gMarker=null,gGeocoder=null,gAutocomplete=null;
    
    function setLatLngInputs(lat,lng){
      const latEl=document.getElementById('geo-lat');
      const lngEl=document.getElementById('geo-lng');
      if(latEl) latEl.value=Number(lat).toFixed(6); 
      if(lngEl) lngEl.value=Number(lng).toFixed(6);
    }
    
    function setGMarker(lat,lng,center=true){
      if(!gMap) return;
      const pos={lat:Number(lat),lng:Number(lng)};
      if(!gMarker){
        gMarker=new google.maps.Marker({
          position:pos,
          map:gMap,
          draggable:true,
          animation:google.maps.Animation.DROP
        });
        gMarker.addListener('dragend',()=>{
          const p=gMarker.getPosition();
          const la=p.lat(),ln=p.lng();
          setLatLngInputs(la,ln);
          reverseGeocodeGoogle(la,ln);
        });
      }else{
        gMarker.setPosition(pos);
      }
      if(center) gMap.setCenter(pos);
    }
    
    async function reverseGeocodeGoogle(lat,lng){
      if(!gGeocoder) gGeocoder=new google.maps.Geocoder();
      const addressEl=document.getElementById('address');
      try{
        const {results}=await gGeocoder.geocode({location:{lat,lng}});
        if(results&&results[0]&&addressEl){
          addressEl.value=results[0].formatted_address;
        }
      }catch(e){
        console.warn('Geocoder error:',e);
      }
    }
    
    function attachAutocomplete(){
      const addressEl=document.getElementById('address');
      if(!addressEl) return;
      try{
        gAutocomplete=new google.maps.places.Autocomplete(addressEl,{
          fields:['geometry','formatted_address']
        });
        gAutocomplete.addListener('place_changed',()=>{
          const place=gAutocomplete.getPlace();
          if(!place?.geometry?.location) return;
          const lat=place.geometry.location.lat();
          const lng=place.geometry.location.lng();
          setLatLngInputs(lat,lng);
          setGMarker(lat,lng,true);
        });
      }catch(e){
        console.warn('Places Autocomplete no disponible.',e);
      }
    }
    
    function locateMeOnce(){
      if(!('geolocation'in navigator)){
        alert('Geolocalización no disponible.');
        return;
      }
      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat=pos.coords.latitude;
        const lng=pos.coords.longitude;
        setLatLngInputs(lat,lng);
        if(gMap) setGMarker(lat,lng,true);
        await reverseGeocodeGoogle(lat,lng);
      },err=>{
        const msgs={1:'Permiso denegado',2:'Posición no disponible',3:'Tiempo agotado'};
        alert('No se pudo obtener la ubicación: '+(msgs[err.code]||err.message));
      },{
        enableHighAccuracy:true,
        timeout:15000,
        maximumAge:0
      });
    }
    
    function initGMap(){
      const container=document.getElementById('gmap');
      const start={
        lat:Number(document.getElementById('geo-lat')?.value)||14.6349,
        lng:Number(document.getElementById('geo-lng')?.value)||-90.5069
      };
      
      gMap=new google.maps.Map(container,{
        center:start,
        zoom:14,
        mapTypeControl:false,
        streetViewControl:false,
        fullscreenControl:true,
        gestureHandling:'greedy'
      });
      
      gMap.addListener('click', function(event) {
        const lat = event.latLng.lat();
        const lng = event.latLng.lng();
        setGMarker(lat, lng, false);
        setLatLngInputs(lat, lng);
        reverseGeocodeGoogle(lat, lng);
      });
      
      setGMarker(start.lat,start.lng,true);
      attachAutocomplete();
    }
    
    window.locateMeOnce=locateMeOnce;
    window.initGMap=initGMap;
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCsWVTI4PKDqGp-wJgWZnD2IbOvd0wKPhQ&libraries=places&callback=initGMap" async defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    function calculateRealAppraisal(){
      const totalConstruccion = parseFloat(document.getElementById('totalConstruccion')?.value)||0;

      let sumaArea = 0;
      document.querySelectorAll('#tbBodyConstruccion .area-input').forEach(i=>{
        sumaArea += parseFloat(i.value)||0;
      });
      const areaConstruccion = sumaArea>0 ? sumaArea : (parseFloat(document.getElementById('construction-area').value)||0);

      const estado=document.getElementById('estado-inmueble').value||'No especificado';
      const anioConstruccion=parseInt(document.getElementById('anio-construccion').value)||0;
      const antiguedad=anioConstruccion? new Date().getFullYear()-anioConstruccion : 0;

      const tipologiaId=document.getElementById('typology').value;
      let tipText='No seleccionada';
      try{
        const t=__getTipos();
        for (const tipologia of t) {
          const variante = tipologia.variants.find(v => v.id === tipologiaId);
          if (variante) {
            tipText=`${tipologia.category}-${tipologia.type}`;
            break;
          }
        }
      }catch{}

      const formatCurrency=(v)=> new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ',minimumFractionDigits:2}).format(v);

      document.getElementById('resultArea').textContent=`${areaConstruccion.toFixed(2)} m²`;
      document.getElementById('resultTypology').textContent=tipText;
      document.getElementById('resultCondition').textContent=estado;
      document.getElementById('resultAge').textContent=`${antiguedad} años`;

      const terreno = parseFloat(document.getElementById('totalTerreno')?.value) || 0;
      document.getElementById('resultLandValue').textContent=formatCurrency(terreno);
      document.getElementById('resultLandAppraisal').textContent=formatCurrency(terreno);

      document.getElementById('resultBuildValue').textContent=formatCurrency(totalConstruccion);
      document.getElementById('resultGrandTotal').textContent=formatCurrency(terreno + totalConstruccion);
      document.getElementById('resultTotal').textContent=formatCurrency(terreno + totalConstruccion);
    }

    async function generateReport(){
  const loadingOverlay = document.getElementById('loadingOverlay'); 
  if (loadingOverlay) loadingOverlay.style.display = 'flex';

  try {
    console.log('🔄 Iniciando generación de PDF COMPLETO...');
    
    
    if (typeof window.jspdf === 'undefined') {
      console.log('📦 Cargando jsPDF...');
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
          console.log('✅ jsPDF cargado');
          resolve();
        };
        script.onerror = () => reject(new Error('No se pudo cargar jsPDF'));
        document.head.appendChild(script);
      });
    }

    if (typeof window.jspdf === 'undefined') {
      throw new Error('jsPDF no está disponible');
    }

    const { jsPDF } = window.jspdf;
    console.log('✅ jsPDF inicializado');
    
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    
    let y = 0;

    
    doc.setFillColor(91, 123, 122);
    doc.rect(0, 0, pageWidth, 60, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('REPORTE DE AVALÚO', pageWidth/2, 30, { align: 'center' });
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generado: ${new Date().toLocaleDateString('es-GT')} ${new Date().toLocaleTimeString('es-GT')}`, pageWidth/2, 45, { align: 'center' });
    doc.text('Sistema de Avalúos Profesional', pageWidth/2, 52, { align: 'center' });

    y = 80;

    
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('1. INFORMACIÓN GENERAL', margin, y);
    y += 20;

    
    const basicData = [
      ['Asociado:', document.getElementById('associate-name').value || 'No especificado'],
      ['Dirección:', document.getElementById('address').value || 'No especificado'],
      ['Propietario:', document.getElementById('owner-name').value || 'No especificado'],
      ['Área Construida:', (document.getElementById('construction-area').value || '0') + ' m²'],
      ['Área Terreno:', (document.getElementById('land-area').value || '0') + ' m²'],
      ['Coordenadas:', `Lat: ${document.getElementById('geo-lat').value || '0'}, Lng: ${document.getElementById('geo-lng').value || '0'}`],
      ['Departamento:', document.getElementById('department').value || 'No especificado']
    ];

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    basicData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      doc.setFont('helvetica', 'bold');
      doc.text(label, margin, y);
      doc.setFont('helvetica', 'normal');
      doc.text(value, margin + 45, y);
      y += 8;
    });

    y += 10;

    
    if(y > 220) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('1.1 DATOS REGISTRALES', margin, y);
    y += 20;

    const registralData = [
      ['Número de Escritura:', document.getElementById('deed-number').value || 'No especificado'],
      ['Fecha de Escritura:', document.getElementById('deed-date').value || 'No especificado'],
      ['Notario:', document.getElementById('notary').value || 'No especificado'],
      ['Finca:', document.getElementById('finca').value || 'No especificado'],
      ['Folio:', document.getElementById('folio').value || 'No especificado'],
      ['Libro:', document.getElementById('libro').value || 'No especificado']
    ];

    doc.setFontSize(10);
    registralData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      doc.setFont('helvetica', 'bold');
      doc.text(label, margin, y);
      doc.setFont('helvetica', 'normal');
      doc.text(value, margin + 55, y);
      y += 8;
    });

    
    if(y > 220) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('1.2 COLINDANCIAS', margin, y);
    y += 20;

    const colindanciasData = [
      ['Norte - Propietario:', document.getElementById('norte-propietario').value || 'No especificado'],
      ['Norte - Metros:', (document.getElementById('norte-metros').value || '0') + ' m'],
      ['Sur - Propietario:', document.getElementById('sur-propietario').value || 'No especificado'],
      ['Sur - Metros:', (document.getElementById('sur-metros').value || '0') + ' m'],
      ['Oriente - Propietario:', document.getElementById('oriente-propietario').value || 'No especificado'],
      ['Oriente - Metros:', (document.getElementById('oriente-metros').value || '0') + ' m'],
      ['Poniente - Propietario:', document.getElementById('poniente-propietario').value || 'No especificado'],
      ['Poniente - Metros:', (document.getElementById('poniente-metros').value || '0') + ' m']
    ];

    doc.setFontSize(10);
    colindanciasData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      doc.setFont('helvetica', 'bold');
      doc.text(label, margin, y);
      doc.setFont('helvetica', 'normal');
      doc.text(value, margin + 60, y);
      y += 8;
    });

    
    if(y > 220) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('1.3 INFORMACIÓN DEL SOLAR', margin, y);
    y += 20;

    const solarData = [
      ['Concreto:', document.getElementById('calle-concreto').value || ''],
      ['Adoquín:', document.getElementById('calle-adoquin').value || ''],
      ['Servidumbre:', document.getElementById('calle-servidumbre').value || ''],
      ['Vereda:', document.getElementById('calle-vereda').value || ''],
      ['Tierra:', document.getElementById('calle-tierra').value || ''],
      ['Asfalto:', document.getElementById('calle-asfalto').value || ''],
      ['Electricidad:', document.getElementById('servicio-electricidad').value || ''],
      ['Agua:', document.getElementById('servicio-agua').value || ''],
      ['Teléfono:', document.getElementById('servicio-telefono').value || ''],
      ['Drenaje:', document.getElementById('servicio-drenaje').value || ''],
      ['Acera:', document.getElementById('servicio-acera').value || ''],
      ['Bordillo:', document.getElementById('servicio-bordillo').value || ''],
      ['Esquina:', document.getElementById('ubicacion-esquina').value || ''],
      ['Medial:', document.getElementById('ubicacion-medial').value || ''],
      ['Urbano:', document.getElementById('clasificacion-urbano').value || ''],
      ['Rústico:', document.getElementById('clasificacion-rustico').value || '']
    ];

    doc.setFontSize(9);
    solarData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      if(value) {
        doc.setFont('helvetica', 'bold');
        doc.text(label, margin, y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + 35, y);
        y += 7;
      }
    });

    
    if(y > 200) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('1.4 UBICACIÓN GEOGRÁFICA', margin, y);
    y += 20;

    const lat = document.getElementById('geo-lat').value || 'No disponible';
    const lng = document.getElementById('geo-lng').value || 'No disponible';
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('Coordenadas:', margin, y);
    doc.setFont('helvetica', 'normal');
    doc.text(`Latitud: ${lat}, Longitud: ${lng}`, margin + 40, y);
    y += 12;
    doc.setFont('helvetica', 'bold');
    doc.text('Dirección:', margin, y);
    doc.setFont('helvetica', 'normal');
    const address = document.getElementById('address').value || 'No especificada';
    const addressLines = doc.splitTextToSize(address, contentWidth - 20);
    doc.text(addressLines, margin, y + 8);
    y += (addressLines.length * 8) + 15;

    
    if(y > 200) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('2. CARACTERÍSTICAS CONSTRUCTIVAS', margin, y);
    y += 20;

    
    const tipologiaId = document.getElementById('typology').value;
    if(tipologiaId) {
      try {
        const tipologias = __getTipos();
        for (const tipologia of tipologias) {
          const variante = tipologia.variants.find(v => v.id === tipologiaId);
          if (variante) {
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('2.1 TIPOLOGÍA CONSTRUCTIVA SELECCIONADA:', margin, y);
            y += 15;
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(`${tipologia.category} - ${tipologia.type}: ${variante.title}`, margin, y);
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`Precio: Q${variante.pricePerM2}/m²`, margin, y);
            y += 15;
            break;
          }
        }
      } catch (e) {
        console.warn('Error cargando tipología:', e);
      }
    }

    
    if(y > 220) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('2.2 ESPECIFICACIONES CONSTRUCTIVAS', margin, y);
    y += 20;

    const caracteristicasData = [
      ['Uso y Destino:', document.getElementById('uso-destino').value || 'No especificado'],
      ['Estructura:', document.getElementById('estructura').value || 'No especificado'],
      ['Cimiento:', document.getElementById('cimiento').value || 'No especificado'],
      ['Techos:', document.getElementById('techos').value || 'No especificado'],
      ['Pisos:', document.getElementById('pisos').value || 'No especificado'],
      ['Acabados:', document.getElementById('acabados').value || 'No especificado'],
      ['Paredes:', document.getElementById('paredes').value || 'No especificado'],
      ['Ventanas:', document.getElementById('ventanas').value || 'No especificado'],
      ['Puertas:', document.getElementById('puertas').value || 'No especificado'],
      ['Cielos:', document.getElementById('cielos').value || 'No especificado'],
      ['Sanitario:', document.getElementById('sanitario').value || 'No especificado'],
      ['Red Eléctrica:', document.getElementById('red-electric').value || 'No especificado'],
      ['Servicio de Agua:', document.getElementById('agua').value || 'No especificado'],
      ['Estado de Conservación:', document.getElementById('estado-inmueble').value || 'No especificado'],
      ['Año de Construcción:', document.getElementById('anio-construccion').value || 'No especificado']
    ];

    doc.setFontSize(9);
    caracteristicasData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      doc.setFont('helvetica', 'bold');
      doc.text(label, margin, y);
      doc.setFont('helvetica', 'normal');
      doc.text(value, margin + 55, y);
      y += 7;
    });

    
    const otrosDetalles = document.getElementById('otros-detalles').value;
    if(otrosDetalles) {
      if(y > 220) { doc.addPage(); y = 20; }
      doc.setFillColor(240, 240, 240);
      doc.rect(margin, y-10, contentWidth, 15, 'F');
      doc.setTextColor(91, 123, 122);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('2.3 OTROS DETALLES ESPECÍFICOS', margin, y);
      y += 20;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      const detallesLines = doc.splitTextToSize(otrosDetalles, contentWidth - 10);
      doc.text(detallesLines, margin, y);
      y += (detallesLines.length * 6) + 10;
    }

    
    const imagePreviews = document.querySelectorAll('#image-preview .image-preview-item img');
    if(imagePreviews.length > 0) {
      if(y > 150) { doc.addPage(); y = 20; }
      
      doc.setFillColor(240, 240, 240);
      doc.rect(margin, y-10, contentWidth, 15, 'F');
      doc.setTextColor(91, 123, 122);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('2.4 EVIDENCIA FOTOGRÁFICA', margin, y);
      y += 25;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Total de evidencias: ${imagePreviews.length} imagen(es)`, margin, y);
      y += 10;

      
      for (let i = 0; i < imagePreviews.length; i++) {
        if(y > 150 && i % 3 === 0) { 
          doc.addPage(); 
          y = 20; 
        }
        
        try {
          const imgSrc = imagePreviews[i].src;
          
          
          const imgWidth = contentWidth * 0.28; 
          const imgHeight = 45; 
          const xPos = margin + (i % 3) * (imgWidth + 8); 
          
          doc.addImage(imgSrc, 'JPEG', xPos, y, imgWidth, imgHeight);
          
          doc.setFontSize(7); 
          doc.text(`Evidencia ${i + 1}`, xPos, y + imgHeight + 4);
          
          if ((i + 1) % 3 === 0) {
            y += imgHeight + 12;
          }
        } catch (error) {
          console.warn(`Error cargando evidencia ${i + 1}:`, error);
        }
      }
      if (imagePreviews.length % 3 !== 0) {
        y += 60;
      }
    }

    
    if(y > 200) { doc.addPage(); y = 20; }
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y-10, contentWidth, 15, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('3. CÁLCULOS Y VALORACIONES', margin, y);
    y += 20;

    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('3.1 VALOR DEL TERRENO', margin, y);
    y += 15;

    const terrenoData = [
      ['Valor Base (Q/m²):', document.querySelector('.t-vbase')?.value || '0'],
      ['Área (m²):', document.querySelector('.t-area')?.value || '0'],
      ['Factor Frente:', document.querySelector('.t-ffte')?.value || '1'],
      ['Factor Fondo:', document.querySelector('.t-ffdo')?.value || '1'],
      ['Factor Forma:', document.querySelector('.t-ffma')?.value || '1'],
      ['Factor Extra:', document.querySelector('.t-fext')?.value || '1'],
      ['Otros Factores:', document.querySelector('.t-fotros')?.value || '1'],
      ['MONTO TERRENO:', document.getElementById('totalTerreno')?.value || '0.00']
    ];

    doc.setFontSize(10);
    terrenoData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      doc.setFont('helvetica', 'bold');
      doc.text(label, margin, y);
      doc.setFont('helvetica', 'normal');
      doc.text(value, margin + 60, y);
      y += 8;
    });

    y += 10;

    
    if(y > 220) { doc.addPage(); y = 20; }
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('3.2 VALOR DE CONSTRUCCIÓN - POR NIVELES', margin, y);
    y += 15;

    const construccionRows = document.querySelectorAll('#tbBodyConstruccion tr');
    
    for (let i = 0; i < construccionRows.length; i++) {
      const row = construccionRows[i];
      const planta = row.querySelector('.planta-input')?.value || `Nivel ${i + 1}`;
      const area = row.querySelector('.area-input')?.value || '0';
      const vbase = row.querySelector('.vbase-input')?.value || '0';
      const coef = row.querySelector('.coef-input')?.value || '1';
      const monto = row.querySelector('.monto-output')?.value || '0.00';
      
      if(y > 220) { doc.addPage(); y = 20; }
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text(`${planta}:`, margin, y);
      y += 8;
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.text(`Área: ${area} m² | Valor Base: Q${vbase} | Coeficiente: ${coef} | Monto: Q${monto}`, margin + 10, y);
      y += 12;

      
      const hiddenInput = row.querySelector('.typology-id-input');
      const tipologiaIdNivel = hiddenInput?.value;
      
      if (tipologiaIdNivel) {
        try {
          const tipologias = __getTipos();
          for (const tipologia of tipologias) {
            const variante = tipologia.variants.find(v => v.id === tipologiaIdNivel);
            if (variante) {
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text(`Tipología: ${tipologia.category} - ${tipologia.type}`, margin + 10, y);
              y += 6;
              doc.setFont('helvetica', 'normal');
              doc.text(`Variante: ${variante.title} (Q${variante.pricePerM2}/m²)`, margin + 10, y);
              y += 10;
              break;
            }
          }
        } catch(e) {
          console.warn(`Error cargando tipología para nivel ${i + 1}:`, e);
        }
      }
    }

    
    if(y > 220) { doc.addPage(); y = 20; }
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('TOTAL CONSTRUCCIÓN:', margin, y);
    doc.setFont('helvetica', 'normal');
    doc.text(`Q${document.getElementById('totalConstruccion')?.value || '0.00'}`, margin + 60, y);
    y += 15;

    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('INTEGRACIÓN DE VALORES:', margin, y);
    y += 8;
    
    const totalTerreno = parseFloat(document.getElementById('totalTerreno')?.value) || 0;
    const totalConstruccion = parseFloat(document.getElementById('totalConstruccion')?.value) || 0;
    const totalAvaluo = totalTerreno + totalConstruccion;
    
    doc.setFontSize(10);
    doc.text(`Valor Terreno: Q${totalTerreno.toFixed(2)}`, margin + 10, y);
    y += 6;
    doc.text(`Valor Construcción: Q${totalConstruccion.toFixed(2)}`, margin + 10, y);
    y += 6;
    doc.setFont('helvetica', 'bold');
    doc.text(`TOTAL AVALÚO: Q${totalAvaluo.toFixed(2)}`, margin + 10, y);
    y += 15;

    
    if(y > 200) { doc.addPage(); y = 20; }
    doc.setFillColor(91, 123, 122);
    doc.rect(margin, y-10, contentWidth, 20, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('4. RESULTADO FINAL DEL AVALÚO', margin + 10, y + 5);
    y += 30;

    const resultadosData = [
      ['Área Construida:', document.getElementById('resultArea').textContent || '0 m²'],
      ['Tipología:', document.getElementById('resultTypology').textContent || 'No especificada'],
      ['Estado:', document.getElementById('resultCondition').textContent || 'No especificado'],
      ['Antigüedad:', document.getElementById('resultAge').textContent || '0 años'],
      ['Valor Terreno (sin ajuste):', document.getElementById('resultLandValue').textContent || 'Q0.00'],
      ['Avalúo Terreno (con ajuste):', document.getElementById('resultLandAppraisal').textContent || 'Q0.00'],
      ['Valor Construcción:', document.getElementById('resultBuildValue').textContent || 'Q0.00'],
      ['TOTAL Terreno + Construcción:', document.getElementById('resultGrandTotal').textContent || 'Q0.00']
    ];

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(11);
    resultadosData.forEach(([label, value]) => {
      if(y > 250) { doc.addPage(); y = 20; }
      doc.setFont('helvetica', 'bold');
      doc.text(label, margin, y);
      doc.setFont('helvetica', 'normal');
      doc.text(value, margin + 70, y);
      y += 10;
    });

    y += 10;

    
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y, contentWidth, 25, 'F');
    doc.setTextColor(91, 123, 122);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('VALOR TOTAL ESTIMADO:', margin + 10, y + 10);
    doc.setFontSize(20);
    doc.text(document.getElementById('resultTotal').textContent || 'Q0.00', margin + 10, y + 25);

    
    const totalPages = doc.internal.getNumberOfPages();
    for(let i = 1; i <= totalPages; i++){
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(128, 128, 128);
      doc.text(`Página ${i} de ${totalPages} - Sistema de Avalúos - ${new Date().toLocaleDateString('es-GT')}`, 
              pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
    }

    
    const fileName = `Avaluo_${document.getElementById('associate-name').value || 'Propiedad'}_${new Date().toISOString().slice(0, 10)}.pdf`;
    console.log('💾 Guardando PDF:', fileName);
    doc.save(fileName);
    console.log('✅ PDF COMPLETO generado exitosamente');

  } catch(error) {
    console.error('❌ Error generando PDF:', error);
    alert('Error al generar el PDF: ' + error.message);
  } finally {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.style.display = 'none';
  }
}

    class FormWizard{
      constructor(){this.currentStep=1; this.totalSteps=4; this.init();}
      init(){this.bindEvents(); this.updateUI();}
      bindEvents(){
        document.getElementById('next-step').addEventListener('click',()=>this.next());
        document.getElementById('prev-step').addEventListener('click',()=>this.previous());
        document.querySelectorAll('.step').forEach(step=>{
          step.addEventListener('click',(e)=>{
            const n=parseInt(e.currentTarget.dataset.step);
            if(n<this.currentStep){this.goToStep(n);}
          });
        });
      }
      validateStep(step){
        const req=document.querySelectorAll(`[data-step="${step}"] [required]`);
        let ok=true; req.forEach(f=>{if(!f.value.trim()){f.style.borderColor='var(--error)'; ok=false;} else{f.style.borderColor='';}});
        if(!ok){alert('Por favor completa todos los campos requeridos marcados con *');}
        return ok;
      }
      next(){
        if(this.currentStep<this.totalSteps){
          if(this.validateStep(this.currentStep)){ this.currentStep++; this.updateUI(); }
        } else { this.calculateAppraisal(); }
      }
      previous(){ if(this.currentStep>1){ this.currentStep--; this.updateUI(); } }
      goToStep(step){ if(step>=1&&step<=this.totalSteps){ this.currentStep=step; this.updateUI(); } }
      updateUI(){
        document.querySelectorAll('.step').forEach(s=>{
          const n=parseInt(s.dataset.step);
          s.classList.remove('active','completed');
          if(n===this.currentStep){s.classList.add('active');}
          else if(n<this.currentStep){s.classList.add('completed');}
        });
        document.querySelectorAll('.form-section').forEach(sec=>{
          sec.classList.remove('active'); if(parseInt(sec.dataset.step)===this.currentStep){sec.classList.add('active');}
        });
        const prevBtn=document.getElementById('prev-step');
        const nextBtn=document.getElementById('next-step');
        prevBtn.style.display=this.currentStep>1?'flex':'none';
        nextBtn.innerHTML=this.currentStep===this.totalSteps?'<i class="fas fa-calculator"></i> Calcular Avalúo':'Siguiente <i class="fas fa-arrow-right"></i>';
      }
      calculateAppraisal(){
        if(this.validateStep(this.currentStep)){
          const nextBtn=document.getElementById('next-step');
          const original=nextBtn.innerHTML;
          nextBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Calculando...'; nextBtn.disabled=true;
          setTimeout(()=>{
            calculateRealAppraisal();
            document.getElementById('resultSection').classList.add('active');
            document.getElementById('save-btn').style.display='flex';
            document.getElementById('pdf-btn').style.display='flex';
            nextBtn.innerHTML=original; nextBtn.disabled=false;
          },800);
        }
      }
    }
    function newAppraisal(){
      document.getElementById('resultSection').classList.remove('active');
      document.getElementById('save-btn').style.display='none';
      document.getElementById('pdf-btn').style.display='none';
      window.formWizard.goToStep(1);
    }

    
    document.addEventListener('DOMContentLoaded',function(){
      window.formWizard=new FormWizard();
      document.getElementById('save-btn').addEventListener('click',async function(){ 
        await saveCurrentAppraisal();
        
      });
      document.getElementById('pdf-btn').addEventListener('click',function(){ generateReport(); });
      document.getElementById('catalogModal').addEventListener('click',function(e){ if(e.target===this){ __closeTypology(); } });
      document.getElementById('closeModal').addEventListener('click',function(){ __closeTypology(); });
      
      
      initImageModalEvents();
      initImageUpload();
    });
  </script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://csinbmcauuyljjqshawi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzaW5ibWNhdXV5bGpqcXNoYXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjMyNTcsImV4cCI6MjA3NTA5OTI1N30._0cV_TgcHMjkixigFEMcS34MGbtz7pcupog5-LuKoPA";

    let PUBLIC_APP_URL = window.location.origin + window.location.pathname;
    if (!PUBLIC_APP_URL.endsWith("/")) PUBLIC_APP_URL += "/";

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    
    function __updateAuthUI(isLogged){
      const overlay = document.getElementById('auth-overlay');
      const userBox = document.getElementById('user-box');
      
      console.log('🔄 Actualizando UI de autenticación. Logged:', isLogged);
      console.log('📧 Usuario actual:', window.__session?.user);
      
      if(overlay) {
        overlay.style.display = isLogged ? 'none' : 'flex';
        console.log('🔧 Overlay display:', overlay.style.display);
      }
      
      if(userBox){
        if(isLogged){
          userBox.style.display = 'flex';
          if(window.__session?.user){
            const email = window.__session.user.email || "";
            const username = window.__session.user.user_metadata?.username || email.split('@')[0] || "Usuario";
            const userNameElement = userBox.querySelector('[data-user-name]');
            const userEmailElement = userBox.querySelector('[data-user-email]');
            
            console.log('👤 Datos usuario:', {username, email});
            
            if(userNameElement) {
              userNameElement.textContent = username;
              console.log('✅ Nombre usuario actualizado');
            }
            if(userEmailElement) {
              userEmailElement.textContent = email;
              console.log('✅ Email usuario actualizado');
            }
          }
        } else {
          userBox.style.display = 'none';
        }
        console.log('🔧 UserBox display:', userBox.style.display);
      }
      
      const nextBtn = document.getElementById('next-step');
      if(nextBtn) {
        nextBtn.disabled = !isLogged;
        console.log('🔧 Botón siguiente disabled:', nextBtn.disabled);
      }
    }

    (async () => {
      console.log('🔍 Iniciando verificación de sesión...');
      const { data: { session}, error } = await window.supabase.auth.getSession();
      if(error) console.error('❌ Error obteniendo sesión:', error);
      
      window.__session = session || null;
      console.log('✅ Sesión obtenida:', session ? 'SÍ' : 'NO');
      __updateAuthUI(!!session);
    })();

    window.supabase.auth.onAuthStateChange((_event, session) => {
      console.log('🔄 Cambio de estado de autenticación:', _event);
      window.__session = session || null;
      __updateAuthUI(!!session);
    });

    window.__signUpWithEmail = async (email, password, username) => {
      try {
        console.log("📝 Intentando registro con:", email);
        
        if (!email || !password) {
          alert("Por favor ingresa email y contraseña");
          return;
        }

        const { data, error } = await window.supabase.auth.signUp({
          email: email.trim(),
          password: password.trim(),
          options: { 
            data: { username: username || email.split('@')[0] },
            emailRedirectTo: PUBLIC_APP_URL
          }
        });

        if (error) {
          console.error("❌ Error en registro:", error);
          
          
          if (error.message?.includes('already registered') || error.message?.includes('user_exists')) {
            const { data: loginData, error: loginError } = await window.supabase.auth.signInWithPassword({ 
              email: email.trim(), 
              password: password.trim() 
            });
            
            if (loginError) {
              if (loginError.message?.includes('Email not confirmed')) {
                alert("Tu email no ha sido confirmado. Revisa tu correo y haz clic en el enlace de verificación.");
                return;
              }
              throw loginError;
            }
            
           
            window.__session = loginData.session;
            __updateAuthUI(true);
            alert("¡Bienvenido de nuevo!");
            return;
          }
          throw error;
        }

        if (data?.user) {
          if (!data.session) {
            alert("✅ ¡Cuenta creada! Revisa tu email y confirma tu cuenta antes de iniciar sesión.");
          } else {
            
            window.__session = data.session;
            __updateAuthUI(true);
            alert("¡Cuenta creada y sesión iniciada!");
          }
        }

      } catch (e) {
        console.error("❌ Error completo en registro:", e);
        const errorMsg = e.message || 'Error desconocido';
        
        if (errorMsg.includes('Password should be at least')) {
          alert("La contraseña debe tener al menos 6 caracteres");
        } else if (errorMsg.includes('Invalid email')) {
          alert("Por favor ingresa un email válido");
        } else {
          alert("Error al crear cuenta: " + errorMsg);
        }
      }
    };

   
console.log("✅ Login auth exitoso, buscando datos de usuario...");
console.log("🔍 DEBUG - Email a buscar:", email);


const { data: usuarioData, error: userError } = await supabase
  .from('usuarios')
  .select('rol, cooperativa_id, nombre, activo')
  .eq('email', email.trim().toLowerCase())
  .single();

console.log("🔍 DEBUG - Resultado consulta:", usuarioData);
console.log("🔍 DEBUG - Error consulta:", userError);

if (userError) {
  console.error("❌ Error en consulta usuario:", userError);
  
  
  if (email.toLowerCase().includes('batztzunu@gmail.com')) {
    console.log("🎯 Asignando super_admin manualmente...");
    window.userRole = 'super_admin';
    window.cooperativaId = null;
    window.userName = 'Jeremiah';
    redirectByRole('super_admin');
    return;
  }
  
  alert("Usuario no encontrado en el sistema. Contacta al administrador.");
  await supabase.auth.signOut();
  return;
}

    function redirectByRole(rol) {
  console.log("🔄 Redirigiendo por rol:", rol);
  
  
  const elementos = document.querySelectorAll('.app-container, .gerente-dashboard, .super-admin-panel, .auth-overlay');
  elementos.forEach(el => {
    if (el) el.style.display = 'none';
  });
  
  switch(rol) {
    case 'asesor':
      
      const appContainer = document.querySelector('.app-container');
      if (appContainer) appContainer.style.display = 'block';
      break;
      
    case 'gerente':
      
      if (!document.querySelector('.gerente-dashboard')) {
        crearPanelGerente();
      }
      const panelGerente = document.querySelector('.gerente-dashboard');
      if (panelGerente) panelGerente.style.display = 'block';
      break;
      
    case 'super_admin':
      
      if (!document.querySelector('.super-admin-panel')) {
        crearPanelSuperAdmin();
      }
      const panelAdmin = document.querySelector('.super-admin-panel');
      if (panelAdmin) {
        panelAdmin.style.display = 'block';
        cargarPanelSuperAdmin();
      }
      break;
      
    default:
      console.error("Rol no reconocido:", rol);
      alert("Rol no configurado: " + rol);
      window.supabase.auth.signOut();
  }
}
    
    window.__signInWithEmail = async (email, password) => {
  try {
    console.log("🔐 Intentando login con:", email);
    
    if (!email || !password) {
      alert("Por favor ingresa email y contraseña");
      return;
    }

    const { data, error } = await window.supabase.auth.signInWithPassword({ 
      email: email.trim(), 
      password: password.trim() 
    });

    if (error) {
      console.error("❌ Error en login:", error);
      
      if (error.message?.includes('Invalid login credentials')) {
        alert("Email o contraseña incorrectos");
      } else if (error.message?.includes('Email not confirmed')) {
        alert("Tu email no ha sido confirmado. Revisa tu correo y haz clic en el enlace de verificación.");
      } else if (error.message?.includes('Email rate limit exceeded')) {
        alert("Demasiados intentos. Espera unos minutos.");
      } else {
        alert("Error al iniciar sesión: " + error.message);
      }
      return;
    }

    // ✅ LOGIN EXITOSO - VERIFICAR ROL
    console.log("✅ Login auth exitoso, buscando datos de usuario...");
    console.log("🔍 DEBUG - Email a buscar:", email);

    const { data: usuarioData, error: userError } = await supabase
      .from('usuarios')
      .select('rol, cooperativa_id, nombre, activo')
      .eq('email', email.trim().toLowerCase())
      .single();

    console.log("🔍 DEBUG - Resultado consulta:", usuarioData);
    console.log("🔍 DEBUG - Error consulta:", userError);

    if (userError || !usuarioData) {
      console.error("❌ Error en consulta usuario:", userError);
      
      // SI ES TU EMAIL, ASIGNAR SUPER_ADMIN MANUALMENTE
      if (email.toLowerCase().includes('batztzunu@gmail.com')) {
        console.log("🎯 Asignando super_admin manualmente...");
        window.userRole = 'super_admin';
        window.cooperativaId = null;
        window.userName = 'Jeremiah';
        redirectByRole('super_admin');
        return;
      }
      
      alert("Usuario no encontrado en el sistema. Contacta al administrador.");
      await supabase.auth.signOut();
      return;
    }

    if (!usuarioData.activo) {
      alert("Usuario desactivado. Contacta al administrador.");
      await supabase.auth.signOut();
      return;
    }

    // GUARDAR DATOS DE USUARIO
    window.userRole = usuarioData.rol;
    window.cooperativaId = usuarioData.cooperativa_id;
    window.userName = usuarioData.nombre;

    console.log("✅ Login completo. Rol:", usuarioData.rol, "Nombre:", usuarioData.nombre);

    // REDIRIGIR SEGÚN ROL
    redirectByRole(usuarioData.rol);

  } catch (e) {
    console.error("❌ Error completo en login:", e);
    alert("Error al iniciar sesión: " + (e.message || e));
  }
};
      

    function showUsernameModal(userId) {
      const modal = document.getElementById('username-modal');
      const usernameInput = document.getElementById('google-username');
      const saveButton = document.getElementById('save-google-username');
      
      if (!modal || !usernameInput || !saveButton) return;
      
      modal.classList.add('active');
      
      saveButton.replaceWith(saveButton.cloneNode(true));
      const newSaveButton = document.getElementById('save-google-username');
      
      newSaveButton.addEventListener('click', async () => {
        const username = usernameInput.value.trim();
        
        if (!username) {
          alert('Por favor ingresa un nombre de usuario');
          return;
        }
        
        if (username.length < 3) {
          alert('El username debe tener al menos 3 caracteres');
          return;
        }
        
        try {
          newSaveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
          newSaveButton.disabled = true;
          
          const { error } = await window.supabase.auth.updateUser({
            data: { username: username }
          });
          
          if (error) throw error;
          
          modal.classList.remove('active');
          usernameInput.value = '';
          
          const { data: { session } } = await window.supabase.auth.getSession();
          window.__session = session;
          __updateAuthUI(!!session);
          
          alert(`¡Bienvenido ${username}! Tu perfil ha sido actualizado.`);
          
        } catch (error) {
          console.error('Error updating username:', error);
          alert('Error al guardar username: ' + (error.message || error));
          newSaveButton.innerHTML = '<i class="fas fa-check"></i> Guardar y continuar';
          newSaveButton.disabled = false;
        }
      });
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
      
      usernameInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          newSaveButton.click();
        }
      });
      
      setTimeout(() => usernameInput.focus(), 300);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (session?.user && !session.user.user_metadata?.username) {
        setTimeout(() => {
          showUsernameModal(session.user.id);
        }, 1500);
      }
    });

    window.__resendVerification = async (email) => {
      try {
        if (!email) {
          alert("Por favor escribe tu correo electrónico primero");
          return;
        }

        console.log("🔄 Reenviando verificación a:", email);
        
        const { error } = await window.supabase.auth.resend({ 
          type: 'signup', 
          email: email.trim(),
          options: {
            emailRedirectTo: PUBLIC_APP_URL
          }
        });

        if (error) {
          if (error.message?.includes('already confirmed')) {
            alert("Este email ya fue confirmado. Puedes iniciar sesión.");
          } else if (error.message?.includes('rate limit')) {
            alert("Espera unos minutos antes de solicitar otro email.");
          } else {
            throw error;
          }
          return;
        }

        alert("✅ ¡Email de verificación reenviado! Revisa tu bandeja de entrada y carpeta de spam.");

      } catch (e) {
        console.error("❌ Error reenviando verificación:", e);
        alert("Error al reenviar: " + (e.message || e));
      }
    };

    window.__signOut = async () => { await window.supabase.auth.signOut(); };
    window.__canUseApp = () => !!window.__session;

    document.addEventListener('DOMContentLoaded', () => {
      const nextBtn = document.getElementById('next-step');
      if(nextBtn){
        nextBtn.addEventListener('click', (e) => {
          if(!window.__canUseApp()){
            e.stopImmediatePropagation();
            e.preventDefault();
            document.getElementById('auth-overlay').style.display='flex';
            alert("Inicia sesión para continuar.");
          }
        }, true);
      }
    });

    const _origCalculate = window.calculateRealAppraisal;
    if(_origCalculate){
      window.calculateRealAppraisal = function(){
        if(!window.__canUseApp()){
          document.getElementById('auth-overlay').style.display='flex';
          alert("Inicia sesión para calcular el avalúo.");
          return;
        }
        return _origCalculate.apply(this, arguments);
      };
    }
  </script>

  <script>
    (function () {
      const url = new URL(window.location.href);
      const hashStr = url.hash.startsWith('#') ? url.hash.slice(1) : url.hash;
      const hash = new URLSearchParams(hashStr);
      const qs = new URLSearchParams(url.search);
      const msg = hash.get("error_description") || hash.get("error") || qs.get("error_description") || qs.get("error");
      if (msg) {
        console.error("Auth callback error:", msg);
        alert("Autenticación: " + msg);
      }
    })();
  </script>

  <script>
   
    function fixTipologySelection() {
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('.select-button')) {
                e.preventDefault();
                e.stopPropagation();
                
                const button = e.target.closest('.select-button');
                const variantItem = button.closest('.typology-variant');
                const tipologyId = variantItem?.getAttribute('data-id');
                
                if (tipologyId) {
                    __selectTipo(tipologyId);
                }
            }
        });
    }

    
    document.addEventListener('DOMContentLoaded', function() {
        fixTipologySelection();
    });

    
    const originalRenderTipos = __renderTipos;
    __renderTipos = function() {
        originalRenderTipos();
        setTimeout(fixTipologySelection, 100);
    };

    function crearPanelSuperAdmin() {
  console.log("🛠️ Creando panel Super Admin...");
  
  const panelHTML = `
    <div class="super-admin-panel" style="display: none;">
      <header class="app-header">
        <h1><i class="fas fa-crown"></i> Panel Super Administrador</h1>
      </header>

      <div class="card">
        <h2><i class="fas fa-plus-circle"></i> Crear Nueva Cooperativa</h2>
        <div class="form-grid">
          <div class="form-group">
            <label class="required">Nombre Cooperativa</label>
            <input type="text" id="nombre-cooperativa" placeholder="Ej: Cooperativa La Esperanza">
          </div>
          <div class="form-group">
            <label>RFC</label>
            <input type="text" id="rfc-cooperativa" placeholder="Ej: COO123456789">
          </div>
          <div class="form-group">
            <label class="required">Email del Gerente</label>
            <input type="email" id="email-gerente" placeholder="gerente@cooperativa.com">
          </div>
          <div class="form-group">
            <label class="required">Nombre del Gerente</label>
            <input type="text" id="nombre-gerente" placeholder="Ej: Carlos Gómez">
          </div>
        </div>
        <button class="btn-primary" onclick="crearCooperativaConGerente()">
          <i class="fas fa-save"></i> Crear Cooperativa y Asignar Gerente
        </button>
      </div>

      <div class="card">
        <h2><i class="fas fa-building"></i> Cooperativas Existentes</h2>
        <div id="lista-cooperativas" class="lista-cooperativas">
          <div class="loading">Cargando cooperativas...</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', panelHTML);
  console.log("✅ Panel Super Admin creado");
}

    async function crearCooperativaConGerente() {
  const nombreCooperativa = document.getElementById('nombre-cooperativa').value;
  const rfc = document.getElementById('rfc-cooperativa').value;
  const emailGerente = document.getElementById('email-gerente').value;
  const nombreGerente = document.getElementById('nombre-gerente').value;

  if (!nombreCooperativa || !emailGerente || !nombreGerente) {
    alert('❌ Por favor completa todos los campos requeridos (marcados con *)');
    return;
  }

  const btn = document.querySelector('.btn-primary');
  const originalText = btn.innerHTML;
  
  try {
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
    btn.disabled = true;

    console.log("🏗️ Creando cooperativa:", nombreCooperativa);

    
    const { data: cooperativa, error: errorCoop } = await supabase
      .from('cooperativas')
      .insert([{
        nombre: nombreCooperativa,
        rfc: rfc,
        creado_por: window.__session.user.id
      }])
      .select()
      .single();

    if (errorCoop) {
      console.error('Error creando cooperativa:', errorCoop);
      alert('❌ Error creando cooperativa: ' + errorCoop.message);
      return;
    }

    console.log("✅ Cooperativa creada:", cooperativa.id);

    
    const { data: gerente, error: errorGerente } = await supabase
      .from('usuarios')
      .insert([{
        email: emailGerente,
        nombre: nombreGerente,
        cooperativa_id: cooperativa.id,
        rol: 'gerente',
        creado_por: window.__session.user.id
      }])
      .select()
      .single();

    if (errorGerente) {
      console.error('Error creando gerente:', errorGerente);
      
      
      await supabase.from('cooperativas').delete().eq('id', cooperativa.id);
      alert('❌ Error creando gerente: ' + errorGerente.message);
      return;
    }

    console.log("✅ Gerente creado:", gerente.id);

    
    alert(`✅ ¡Cooperativa creada exitosamente!\n\n` +
          `🏢 Cooperativa: ${nombreCooperativa}\n` +
          `👤 Gerente: ${nombreGerente}\n` +
          `📧 Email: ${emailGerente}\n\n` +
          `El gerente puede iniciar sesión con su email y crear su contraseña.`);

    document.getElementById('nombre-cooperativa').value = '';
    document.getElementById('rfc-cooperativa').value = '';
    document.getElementById('email-gerente').value = '';
    document.getElementById('nombre-gerente').value = '';

    
    cargarPanelSuperAdmin();

  } catch (error) {
    console.error('❌ Error completo:', error);
    alert('❌ Error: ' + error.message);
  } finally {
    btn.innerHTML = '<i class="fas fa-save"></i> Crear Cooperativa y Asignar Gerente';
    btn.disabled = false;
  }
}

    async function cargarPanelSuperAdmin() {
  try {
    console.log("📋 Cargando lista de cooperativas...");
    
    const listaContainer = document.getElementById('lista-cooperativas');
    if (!listaContainer) {
      console.error("No se encontró el contenedor de cooperativas");
      return;
    }

    listaContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando cooperativas...</div>';

    
    const { data: cooperativas, error } = await supabase
      .from('cooperativas')
      .select(`
        *,
        usuarios:usuarios!cooperativa_id(
          nombre,
          email,
          rol
        )
      `)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error cargando cooperativas:', error);
      throw error;
    }

    console.log("✅ Cooperativas cargadas:", cooperativas);

    if (!cooperativas || cooperativas.length === 0) {
      listaContainer.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-building" style="font-size: 3rem; opacity: 0.5; margin-bottom: 16px;"></i>
          <h4>No hay cooperativas creadas aún</h4>
          <p>Crea tu primera cooperativa usando el formulario superior</p>
        </div>
      `;
      return;
    }

    
    listaContainer.innerHTML = cooperativas.map(coop => {
      const gerente = coop.usuarios?.find(u => u.rol === 'gerente');
      
      return `
        <div class="cooperativa-item" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 1.2rem;">${coop.nombre}</h3>
              <div style="color: var(--text-light); font-size: 0.9rem; line-height: 1.5;">
                <div><strong>RFC:</strong> ${coop.rfc || 'No especificado'}</div>
                <div><strong>Gerente:</strong> ${gerente ? `${gerente.nombre} (${gerente.email})` : 'No asignado'}</div>
                <div><strong>Creada:</strong> ${new Date(coop.created_at).toLocaleDateString('es-GT')}</div>
                <div><strong>Estado:</strong> <span style="color: var(--success); font-weight: 600;">${coop.estado}</span></div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-shrink: 0;">
              <button class="btn-secondary btn-small" onclick="verDetallesCooperativa('${coop.id}')">
                <i class="fas fa-eye"></i> Ver
              </button>
              <button class="btn-small" style="background: var(--error); color: white; border: none; border-radius: var(--radius-sm); padding: 8px 12px;" 
                      onclick="suspenderCooperativa('${coop.id}')">
                <i class="fas fa-pause"></i> Suspender
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('❌ Error cargando cooperativas:', error);
    const listaContainer = document.getElementById('lista-cooperativas');
    if (listaContainer) {
      listaContainer.innerHTML = `
        <div class="error" style="color: var(--error); text-align: center; padding: 20px;">
          <i class="fas fa-exclamation-triangle"></i>
          <div>Error cargando cooperativas: ${error.message}</div>
        </div>
      `;
    }
  }
}

    function verDetallesCooperativa(coopId) {
  alert("📊 Detalles de cooperativa en desarrollo - ID: " + coopId);
}

function suspenderCooperativa(coopId) {
  if (confirm("¿Estás seguro de suspender esta cooperativa?")) {
    alert("⏸️ Función de suspensión en desarrollo - ID: " + coopId);
  }
}

    function crearPanelGerente() {
  console.log("👔 Creando Panel Gerente...");
  
  const panelHTML = `
    <div class="gerente-dashboard" style="display: none;">
      <header class="app-header">
        <h1><i class="fas fa-chart-line"></i> Dashboard Gerente - ${window.userName || 'Gerente'}</h1>
      </header>

      <!-- ESTADÍSTICAS RÁPIDAS -->
      <div class="card">
        <h2><i class="fas fa-tachometer-alt"></i> Resumen General</h2>
        <div class="result-grid" id="estadisticas-gerente">
          <div class="result-item">
            <div class="label">Total Avalúos</div>
            <div class="value" id="total-avaluos">0</div>
          </div>
          <div class="result-item">
            <div class="label">Pendientes</div>
            <div class="value" id="pendientes-avaluos">0</div>
          </div>
          <div class="result-item">
            <div class="label">Aprobados</div>
            <div class="value" id="aprobados-avaluos">0</div>
          </div>
          <div class="result-item">
            <div class="label">Asesores Activos</div>
            <div class="value" id="total-asesores">0</div>
          </div>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="card">
        <h2><i class="fas fa-filter"></i> Filtros</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Asesor</label>
            <select id="filtro-asesor" onchange="cargarAvaluosGerente()">
              <option value="">Todos los asesores</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="filtro-estado" onchange="cargarAvaluosGerente()">
              <option value="">Todos los estados</option>
              <option value="borrador">Borrador</option>
              <option value="pendiente_revision">Pendientes</option>
              <option value="aprobado">Aprobados</option>
              <option value="rechazado">Rechazados</option>
            </select>
          </div>
          <div class="form-group">
            <label>Fecha desde</label>
            <input type="date" id="filtro-fecha-desde" onchange="cargarAvaluosGerente()">
          </div>
          <div class="form-group">
            <label>Fecha hasta</label>
            <input type="date" id="filtro-fecha-hasta" onchange="cargarAvaluosGerente()">
          </div>
        </div>
        <button class="btn-secondary" onclick="descargarReporteGerente()">
          <i class="fas fa-download"></i> Descargar Reporte
        </button>
      </div>

      <!-- LISTA DE AVALÚOS -->
      <div class="card">
        <h2><i class="fas fa-list"></i> Avalúos de la Cooperativa</h2>
        <div id="lista-avaluos-gerente" style="max-height: 600px; overflow-y: auto;">
          <div class="loading">Cargando avalúos...</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', panelHTML);
  console.log("✅ Panel Gerente creado");
  
  
  cargarEstadisticasGerente();
  cargarSelectAsesores();
  cargarAvaluosGerente();
}

    async function cargarEstadisticasGerente() {
  try {
    
    const { count: totalAvaluos } = await supabase
      .from('avaluos')
      .select('*', { count: 'exact', head: true })
      .eq('cooperativa_id', window.cooperativaId);

    
    const { count: pendientes } = await supabase
      .from('avaluos')
      .select('*', { count: 'exact', head: true })
      .eq('cooperativa_id', window.cooperativaId)
      .eq('estado', 'pendiente_revision');

    
    const { count: aprobados } = await supabase
      .from('avaluos')
      .select('*', { count: 'exact', head: true })
      .eq('cooperativa_id', window.cooperativaId)
      .eq('estado', 'aprobado');

    
    const { count: totalAsesores } = await supabase
      .from('usuarios')
      .select('*', { count: 'exact', head: true })
      .eq('cooperativa_id', window.cooperativaId)
      .eq('rol', 'asesor')
      .eq('activo', true);

    
    document.getElementById('total-avaluos').textContent = totalAvaluos || 0;
    document.getElementById('pendientes-avaluos').textContent = pendientes || 0;
    document.getElementById('aprobados-avaluos').textContent = aprobados || 0;
    document.getElementById('total-asesores').textContent = totalAsesores || 0;

  } catch (error) {
    console.error('Error cargando estadísticas:', error);
  }
}

async function cargarSelectAsesores() {
  try {
    const { data: asesores, error } = await supabase
      .from('usuarios')
      .select('id, nombre, email')
      .eq('cooperativa_id', window.cooperativaId)
      .eq('rol', 'asesor')
      .eq('activo', true)
      .order('nombre');

    if (error) throw error;

    const select = document.getElementById('filtro-asesor');
    select.innerHTML = '<option value="">Todos los asesores</option>';
    
    asesores.forEach(asesor => {
      const option = document.createElement('option');
      option.value = asesor.id;
      option.textContent = `${asesor.nombre} (${asesor.email})`;
      select.appendChild(option);
    });

  } catch (error) {
    console.error('Error cargando asesores:', error);
  }
}

async function cargarAvaluosGerente() {
  try {
    const listaContainer = document.getElementById('lista-avaluos-gerente');
    if (!listaContainer) return;

    listaContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando avalúos...</div>';

    
    let query = supabase
      .from('avaluos')
      .select('*')
      .eq('cooperativa_id', window.cooperativaId)
      .order('fecha_creacion', { ascending: false });

    
    const asesorId = document.getElementById('filtro-asesor').value;
    const estado = document.getElementById('filtro-estado').value;
    const fechaDesde = document.getElementById('filtro-fecha-desde').value;
    const fechaHasta = document.getElementById('filtro-fecha-hasta').value;

    if (asesorId) query = query.eq('usuario_id', asesorId);
    if (estado) query = query.eq('estado', estado);
    if (fechaDesde) query = query.gte('fecha_creacion', fechaDesde);
    if (fechaHasta) query = query.lte('fecha_creacion', fechaHasta + 'T23:59:59');

    const { data: avaluos, error } = await query;

    if (error) throw error;

    if (!avaluos || avaluos.length === 0) {
      listaContainer.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-file-contract"></i>
          <h4>No hay avalúos que coincidan con los filtros</h4>
          <p>Intenta con otros criterios de búsqueda</p>
        </div>
      `;
      return;
    }

    
    listaContainer.innerHTML = avaluos.map(avaluo => {
      const fecha = new Date(avaluo.fecha_creacion).toLocaleDateString('es-GT');
      const estadoColor = {
        'borrador': 'var(--text-light)',
        'pendiente_revision': 'var(--warning)',
        'aprobado': 'var(--success)',
        'rechazado': 'var(--error)'
      }[avaluo.estado] || 'var(--text-light)';

      return `
        <div class="appraisal-item" style="border-left: 4px solid ${estadoColor};">
          <div class="appraisal-header">
            <div class="appraisal-date">
              <i class="fas fa-calendar"></i> ${fecha}
              <span style="margin-left: 12px; color: ${estadoColor}; font-weight: 600; text-transform: capitalize;">
                ${avaluo.estado.replace('_', ' ')}
              </span>
            </div>
            <div class="appraisal-actions">
              <button class="btn-primary btn-small" onclick="editarAvaluoGerente('${avaluo.id}')">
                <i class="fas fa-edit"></i> Editar
              </button>
              ${avaluo.estado === 'pendiente_revision' ? `
                <button class="btn-small" style="background: var(--success); color: white; border: none;" onclick="aprobarAvaluo('${avaluo.id}')">
                  <i class="fas fa-check"></i> Aprobar
                </button>
                <button class="btn-small" style="background: var(--error); color: white; border: none;" onclick="rechazarAvaluo('${avaluo.id}')">
                  <i class="fas fa-times"></i> Rechazar
                </button>
              ` : ''}
              <button class="btn-secondary btn-small" onclick="verAvaluoCompleto('${avaluo.id}')">
                <i class="fas fa-eye"></i> Ver
              </button>
            </div>
          </div>
          <div class="appraisal-details">
            <div><strong>Asesor:</strong> ${avaluo.usuario_nombre} (${avaluo.usuario_email})</div>
            <div><strong>Asociado:</strong> ${avaluo.associate_name || 'No especificado'}</div>
            <div><strong>Dirección:</strong> ${avaluo.address || 'No especificado'}</div>
            <div><strong>Valor Total:</strong> ${avaluo.total_value || 'Q0.00'}</div>
            ${avaluo.comentarios_revision ? `<div><strong>Comentarios:</strong> ${avaluo.comentarios_revision}</div>` : ''}
          </div>
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('Error cargando avalúos:', error);
    const listaContainer = document.getElementById('lista-avaluos-gerente');
    if (listaContainer) {
      listaContainer.innerHTML = `
        <div class="error" style="color: var(--error); text-align: center; padding: 20px;">
          <i class="fas fa-exclamation-triangle"></i>
          <div>Error cargando avalúos: ${error.message}</div>
        </div>
      `;
    }
  }
}

    
async function aprobarAvaluo(avaluoId) {
  if (!confirm('¿Estás seguro de aprobar este avalúo?')) return;

  try {
    const { error } = await supabase
      .from('avaluos')
      .update({
        estado: 'aprobado',
        revisado_por: window.__session.user.id,
        fecha_revision: new Date().toISOString(),
        comentarios_revision: 'Aprobado por gerente'
      })
      .eq('id', avaluoId);

    if (error) throw error;

    alert('✅ Avalúo aprobado correctamente');
    cargarAvaluosGerente();
    cargarEstadisticasGerente();

  } catch (error) {
    console.error('Error aprobando avalúo:', error);
    alert('❌ Error al aprobar avalúo: ' + error.message);
  }
}


async function rechazarAvaluo(avaluoId) {
  const comentarios = prompt('Ingresa los comentarios de por qué se rechaza este avalúo:');
  if (comentarios === null) return; 

  try {
    const { error } = await supabase
      .from('avaluos')
      .update({
        estado: 'rechazado',
        revisado_por: window.__session.user.id,
        fecha_revision: new Date().toISOString(),
        comentarios_revision: comentarios
      })
      .eq('id', avaluoId);

    if (error) throw error;

    alert('✅ Avalúo rechazado correctamente');
    cargarAvaluosGerente();
    cargarEstadisticasGerente();

  } catch (error) {
    console.error('Error rechazando avalúo:', error);
    alert('❌ Error al rechazar avalúo: ' + error.message);
  }
}


async function editarAvaluoGerente(avaluoId) {
  try {
    
    const { data: avaluo, error } = await supabase
      .from('avaluos')
      .select('*')
      .eq('id', avaluoId)
      .single();

    if (error) throw error;

    
    const modalHTML = `
      <div class="catalog-modal active" id="editar-avaluo-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Avalúo</h3>
            <button class="modal-close" onclick="cerrarModalEdicion()">&times;</button>
          </div>
          <div class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <div class="form-grid">
              <div class="form-group">
                <label>Asociado</label>
                <input type="text" id="editar-associate-name" value="${avaluo.associate_name || ''}">
              </div>
              <div class="form-group">
                <label>Dirección</label>
                <input type="text" id="editar-address" value="${avaluo.address || ''}">
              </div>
              <div class="form-group">
                <label>Área Construida (m²)</label>
                <input type="number" id="editar-construction-area" value="${avaluo.construction_area || ''}">
              </div>
              <div class="form-group">
                <label>Área Terreno (m²)</label>
                <input type="number" id="editar-land-area" value="${avaluo.land_area || ''}">
              </div>
              <div class="form-group">
                <label>Valor Total</label>
                <input type="text" id="editar-total-value" value="${avaluo.total_value || ''}">
              </div>
              <div class="form-group">
                <label>Estado</label>
                <select id="editar-estado">
                  <option value="borrador" ${avaluo.estado === 'borrador' ? 'selected' : ''}>Borrador</option>
                  <option value="pendiente_revision" ${avaluo.estado === 'pendiente_revision' ? 'selected' : ''}>Pendiente Revisión</option>
                  <option value="aprobado" ${avaluo.estado === 'aprobado' ? 'selected' : ''}>Aprobado</option>
                  <option value="rechazado" ${avaluo.estado === 'rechazado' ? 'selected' : ''}>Rechazado</option>
                </select>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Comentarios de Revisión</label>
                <textarea id="editar-comentarios" rows="3">${avaluo.comentarios_revision || ''}</textarea>
              </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button class="btn-primary" onclick="guardarEdicionAvaluo('${avaluoId}')" style="flex: 1;">
                <i class="fas fa-save"></i> Guardar Cambios
              </button>
              <button class="btn-secondary" onclick="cerrarModalEdicion()" style="flex: 1;">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    
    if (document.getElementById('editar-avaluo-modal')) {
      document.getElementById('editar-avaluo-modal').remove();
    }
    document.body.insertAdjacentHTML('beforeend', modalHTML);

  } catch (error) {
    console.error('Error cargando avalúo para edición:', error);
    alert('❌ Error al cargar avalúo: ' + error.message);
  }
}


async function guardarEdicionAvaluo(avaluoId) {
  try {
    const datosActualizados = {
      associate_name: document.getElementById('editar-associate-name').value,
      address: document.getElementById('editar-address').value,
      construction_area: parseFloat(document.getElementById('editar-construction-area').value) || 0,
      land_area: parseFloat(document.getElementById('editar-land-area').value) || 0,
      total_value: document.getElementById('editar-total-value').value,
      estado: document.getElementById('editar-estado').value,
      comentarios_revision: document.getElementById('editar-comentarios').value,
      revisado_por: window.__session.user.id,
      fecha_revision: new Date().toISOString(),
      fecha_actualizacion: new Date().toISOString()
    };

    const { error } = await supabase
      .from('avaluos')
      .update(datosActualizados)
      .eq('id', avaluoId);

    if (error) throw error;

    alert('✅ Avalúo actualizado correctamente');
    cerrarModalEdicion();
    cargarAvaluosGerente();
    cargarEstadisticasGerente();

  } catch (error) {
    console.error('Error guardando edición:', error);
    alert('❌ Error al guardar cambios: ' + error.message);
  }
}


function cerrarModalEdicion() {
  const modal = document.getElementById('editar-avaluo-modal');
  if (modal) modal.remove();
}


function verAvaluoCompleto(avaluoId) {
  alert(`📋 Función de vista completa en desarrollo\nAvalúo ID: ${avaluoId}\n\nEsta función mostrará todos los detalles del avalúo en un formato de reporte.`);
}


function descargarReporteGerente() {
  alert('📊 Función de descarga de reporte en desarrollo\n\nEsta función generará un Excel/PDF con todos los avalúos filtrados.');
}

  
async function aprobarAvaluo(avaluoId) {
  if (!confirm('¿Estás seguro de aprobar este avalúo?')) return;

  try {
    const { error } = await supabase
      .from('avaluos')
      .update({
        estado: 'aprobado',
        revisado_por: window.__session.user.id,
        fecha_revision: new Date().toISOString(),
        comentarios_revision: 'Aprobado por gerente'
      })
      .eq('id', avaluoId);

    if (error) throw error;

    alert('✅ Avalúo aprobado correctamente');
    cargarAvaluosGerente();
    cargarEstadisticasGerente();

  } catch (error) {
    console.error('Error aprobando avalúo:', error);
    alert('❌ Error al aprobar avalúo: ' + error.message);
  }
}


async function rechazarAvaluo(avaluoId) {
  const comentarios = prompt('Ingresa los comentarios de por qué se rechaza este avalúo:');
  if (comentarios === null) return; 

  try {
    const { error } = await supabase
      .from('avaluos')
      .update({
        estado: 'rechazado',
        revisado_por: window.__session.user.id,
        fecha_revision: new Date().toISOString(),
        comentarios_revision: comentarios
      })
      .eq('id', avaluoId);

    if (error) throw error;

    alert('✅ Avalúo rechazado correctamente');
    cargarAvaluosGerente();
    cargarEstadisticasGerente();

  } catch (error) {
    console.error('Error rechazando avalúo:', error);
    alert('❌ Error al rechazar avalúo: ' + error.message);
  }
}


async function editarAvaluoGerente(avaluoId) {
  try {
    
    const { data: avaluo, error } = await supabase
      .from('avaluos')
      .select('*')
      .eq('id', avaluoId)
      .single();

    if (error) throw error;

    
    const modalHTML = `
      <div class="catalog-modal active" id="editar-avaluo-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Avalúo</h3>
            <button class="modal-close" onclick="cerrarModalEdicion()">&times;</button>
          </div>
          <div class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <div class="form-grid">
              <div class="form-group">
                <label>Asociado</label>
                <input type="text" id="editar-associate-name" value="${avaluo.associate_name || ''}">
              </div>
              <div class="form-group">
                <label>Dirección</label>
                <input type="text" id="editar-address" value="${avaluo.address || ''}">
              </div>
              <div class="form-group">
                <label>Área Construida (m²)</label>
                <input type="number" id="editar-construction-area" value="${avaluo.construction_area || ''}">
              </div>
              <div class="form-group">
                <label>Área Terreno (m²)</label>
                <input type="number" id="editar-land-area" value="${avaluo.land_area || ''}">
              </div>
              <div class="form-group">
                <label>Valor Total</label>
                <input type="text" id="editar-total-value" value="${avaluo.total_value || ''}">
              </div>
              <div class="form-group">
                <label>Estado</label>
                <select id="editar-estado">
                  <option value="borrador" ${avaluo.estado === 'borrador' ? 'selected' : ''}>Borrador</option>
                  <option value="pendiente_revision" ${avaluo.estado === 'pendiente_revision' ? 'selected' : ''}>Pendiente Revisión</option>
                  <option value="aprobado" ${avaluo.estado === 'aprobado' ? 'selected' : ''}>Aprobado</option>
                  <option value="rechazado" ${avaluo.estado === 'rechazado' ? 'selected' : ''}>Rechazado</option>
                </select>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Comentarios de Revisión</label>
                <textarea id="editar-comentarios" rows="3">${avaluo.comentarios_revision || ''}</textarea>
              </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button class="btn-primary" onclick="guardarEdicionAvaluo('${avaluoId}')" style="flex: 1;">
                <i class="fas fa-save"></i> Guardar Cambios
              </button>
              <button class="btn-secondary" onclick="cerrarModalEdicion()" style="flex: 1;">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    
    if (document.getElementById('editar-avaluo-modal')) {
      document.getElementById('editar-avaluo-modal').remove();
    }
    document.body.insertAdjacentHTML('beforeend', modalHTML);

  } catch (error) {
    console.error('Error cargando avalúo para edición:', error);
    alert('❌ Error al cargar avalúo: ' + error.message);
  }
}


async function guardarEdicionAvaluo(avaluoId) {
  try {
    const datosActualizados = {
      associate_name: document.getElementById('editar-associate-name').value,
      address: document.getElementById('editar-address').value,
      construction_area: parseFloat(document.getElementById('editar-construction-area').value) || 0,
      land_area: parseFloat(document.getElementById('editar-land-area').value) || 0,
      total_value: document.getElementById('editar-total-value').value,
      estado: document.getElementById('editar-estado').value,
      comentarios_revision: document.getElementById('editar-comentarios').value,
      revisado_por: window.__session.user.id,
      fecha_revision: new Date().toISOString(),
      fecha_actualizacion: new Date().toISOString()
    };

    const { error } = await supabase
      .from('avaluos')
      .update(datosActualizados)
      .eq('id', avaluoId);

    if (error) throw error;

    alert('✅ Avalúo actualizado correctamente');
    cerrarModalEdicion();
    cargarAvaluosGerente();
    cargarEstadisticasGerente();

  } catch (error) {
    console.error('Error guardando edición:', error);
    alert('❌ Error al guardar cambios: ' + error.message);
  }
}


function cerrarModalEdicion() {
  const modal = document.getElementById('editar-avaluo-modal');
  if (modal) modal.remove();
}


function verAvaluoCompleto(avaluoId) {
  alert(`📋 Función de vista completa en desarrollo\nAvalúo ID: ${avaluoId}\n\nEsta función mostrará todos los detalles del avalúo en un formato de reporte.`);
}


function descargarReporteGerente() {
  alert('📊 Función de descarga de reporte en desarrollo\n\nEsta función generará un Excel/PDF con todos los avalúos filtrados.');
}

  
async function saveCurrentAppraisal() {
  if (!window.__session) {
    alert('Debes iniciar sesión para guardar avalúos');
    return false;
  }
  
  console.log('🟡 Guardando avalúo con sistema de roles...');
  
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay) loadingOverlay.style.display = 'flex';
  
  try {
    const appraisalData = {
      associateName: document.getElementById('associate-name').value || 'No especificado',
      address: document.getElementById('address').value || 'No especificado',
      constructionArea: parseFloat(document.getElementById('construction-area').value) || 0,
      landArea: parseFloat(document.getElementById('land-area').value) || 0,
      totalValue: document.getElementById('resultTotal').textContent || 'Q0.00',
      ownerName: document.getElementById('owner-name').value || '',
      typology: document.getElementById('typology').value || '',
      department: document.getElementById('department').value || '',
      estadoInmueble: document.getElementById('estado-inmueble').value || '',
      anioConstruccion: document.getElementById('anio-construccion').value || '',
      totalConstruccion: document.getElementById('totalConstruccion').value || '0',
      totalTerreno: document.getElementById('totalTerreno').value || '0'
    };

    console.log('📦 Datos del avalúo:', appraisalData);

    
    let estado = 'borrador';
    if (window.userRole === 'asesor') {
      estado = 'pendiente_revision'; 
    }

    
    const { data, error } = await window.supabase
      .from('avaluos')
      .insert([
        {
          usuario_id: window.__session.user.id,
          usuario_email: window.__session.user.email,
          usuario_nombre: window.userName || window.__session.user.email,
          cooperativa_id: window.cooperativaId,
          associate_name: appraisalData.associateName,
          address: appraisalData.address,
          construction_area: appraisalData.constructionArea,
          land_area: appraisalData.landArea,
          total_value: appraisalData.totalValue,
          owner_name: appraisalData.ownerName,
          typology: appraisalData.typology,
          department: appraisalData.department,
          estado_inmueble: appraisalData.estadoInmueble,
          anio_construccion: appraisalData.anioConstruccion,
          total_construccion: appraisalData.totalConstruccion,
          total_terreno: appraisalData.totalTerreno,
          estado: estado,
          datos_completos: appraisalData
        }
      ])
      .select();

    if (error) {
      console.error('❌ Error Supabase:', error);
      throw error;
    }

    console.log('✅ Avalúo guardado en Supabase:', data);

    
    const savedInLocal = window.avaluosStorage.saveAppraisal(appraisalData);
    console.log('✅ Backup en localStorage:', savedInLocal);

    alert(`✅ Avalúo ${estado === 'pendiente_revision' ? 'enviado a revisión' : 'guardado'} exitosamente`);
    
    
    if (document.getElementById('all-appraisals-modal')?.classList.contains('active')) {
      showAllAppraisals();
    }
    if (document.getElementById('my-appraisals-modal')?.classList.contains('active')) {
      showMyAppraisals();
    }
    
    return true;
    
  } catch (error) {
    console.error('❌ Error completo al guardar:', error);
    alert('❌ Error al guardar avalúo: ' + error.message);
    return false;
  } finally {
    if (loadingOverlay) loadingOverlay.style.display = 'none';
  }
}


document.addEventListener('DOMContentLoaded', function() {
  const saveBtn = document.getElementById('save-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', async function() { 
      await saveCurrentAppraisal();
    });
  }
});

    
document.addEventListener('DOMContentLoaded', function() {
  const saveBtn = document.getElementById('save-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', async function() { 
      await saveCurrentAppraisal();
    });
  }
});
  </script>
</body>
</html>
